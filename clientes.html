<!DOCTYPE html>
<html lang="es">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP - Gesti√≥n de Clientes</title>
    <link rel="stylesheet" href="styles.css">
    <script>
        // Funci√≥n parseAmount espec√≠fica para clientes.html (maneja formato Float 1.000.000,00)
        function parseAmount(amount) {
            if (!amount) return 0;
            
            // Si ya es un n√∫mero, usarlo directamente
            if (typeof amount === 'number') {
                return amount;
            }
            
            // Convertir a string y limpiar
            const cleanAmount = amount.toString().trim();
            
            // Si est√° vac√≠o, devolver 0
            if (!cleanAmount) return 0;
            
            // Remover caracteres no num√©ricos excepto punto y coma
            const numericOnly = cleanAmount.replace(/[^\d.,]/g, '');
            
            // Si no hay n√∫meros, devolver 0
            if (!numericOnly) return 0;
            
            let result;
            
            if (numericOnly.includes(',')) {
                // Formato: "1.000.000,00" -> 1000000.00
                const normalizedValue = numericOnly.replace(/\./g, '').replace(',', '.');
                result = parseFloat(normalizedValue) || 0;
            } else {
                // Formato: "1000000" o "1.000.000" -> 1000000
                const normalizedValue = numericOnly.replace(/\./g, '');
                result = parseFloat(normalizedValue) || 0;
            }
            
            return result;
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Estilos espec√≠ficos para el modal de b√∫squeda de grupos en m√≥vil */
        @media (max-width: 768px) {
            #groupSearchModal .modal-content {
                width: 95% !important;
                max-width: none !important;
                margin: 20px 10px;
                max-height: 90vh;
            }
            
            #groupSearchModal .modal-body {
                padding: 0 16px 16px 16px;
            }
            
            #groupSearchModal .form-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            #groupSearchModal .form-actions .btn {
                width: 100%;
                padding: 12px;
                font-size: 16px;
                min-height: 44px;
            }
            
            #groupSearchModal #groupsList {
                max-height: 150px;
            }
            
            #groupSearchModal .group-item {
                padding: 16px !important;
                margin-bottom: 12px !important;
                min-height: 60px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            
            #groupSearchModal .group-item div:first-child {
                font-size: 16px !important;
                margin-bottom: 6px !important;
            }
            
            #groupSearchModal .group-item div:last-child {
                font-size: 14px !important;
            }
            
            /* Mejorar bot√≥n de b√∫squeda en m√≥vil */
            .form-group .btn {
                min-height: 44px;
                font-size: 14px;
            }
            
            /* Asegurar que el input tenga altura m√≠nima t√°ctil */
            .form-input {
                min-height: 44px;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            margin-bottom: 60px;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 24px;
            justify-content: flex-start;
        }

        .header-logo {
            max-width: 120px;
            height: auto;
            flex-shrink: 0;
        }

        .header-text {
            flex: 1;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
            text-align: left;
        }

        .header p {
            font-size: 1.1rem;
            color: #86868b;
            font-weight: 400;
            text-align: left;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 48px;
        }

        .form-section {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #f2f2f7;
            width: 100%;
        }

        .form-section h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 24px;
            text-align: center;
        }

        .clients-section {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .search-container {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #f2f2f7;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px;
            border: 1px solid #d2d2d7;
            border-radius: 12px;
            font-size: 16px;
            background: #f9f9f9;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #007aff;
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .clients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .client-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid #f2f2f7;
            position: relative;
        }

        .client-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            border-color: #007aff;
        }

        .client-card.editing {
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .client-card.billed {
            border-left: 4px solid #34c759;
        }

        .client-card.selected {
            border: 2.5px solid #007aff;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.10);
            transition: border 0.2s, box-shadow 0.2s;
        }

        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .client-info {
            flex: 1;
        }

        .client-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 4px;
        }

        .client-id {
            color: #86868b;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .client-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .client-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .detail-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-label {
            font-weight: 500;
            color: #86868b;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-weight: 500;
            color: #1d1d1f;
            font-size: 0.95rem;
        }

        .amount-badge {
            background: #34c759;
            color: white;
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
            width: fit-content;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            width: fit-content;
        }

        .status-billed { background: #34c759; color: white; }
        .status-pending { background: #ff9500; color: white; }
        .status-overdue { background: #ff3b30; color: white; }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn-primary {
            background: #007aff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056cc;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #f2f2f7;
            color: #1d1d1f;
        }

        .btn-secondary:hover {
            background: #e8e8ed;
        }

        .btn-danger {
            background: #ff3b30;
            color: white;
        }

        .btn-danger:hover {
            background: #d70015;
        }

        .btn-success {
            background: #34c759;
            color: white;
        }

        .btn-success:hover {
            background: #248a3d;
        }

        .btn-warning {
            background: #ff9500;
            color: white;
        }

        .btn-warning:hover {
            background: #cc7700;
        }

        .btn-large {
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 12px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #1d1d1f;
            font-size: 0.9rem;
        }

        .required {
            color: #ff3b30;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d2d2d7;
            border-radius: 12px;
            font-size: 16px;
            background: white;
            transition: all 0.3s ease;
            min-height: 48px;
        }

        .form-input:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .form-input.valid {
            border-color: #34c759;
            box-shadow: 0 0 0 3px rgba(52, 199, 89, 0.1);
        }

        .form-input.invalid {
            border-color: #ff3b30;
            box-shadow: 0 0 0 3px rgba(255, 59, 48, 0.1);
        }

        .form-input.uppercase {
            text-transform: uppercase;
            font-weight: 500;
        }

        .field-help {
            color: #86868b;
            font-size: 0.8rem;
            margin-top: 4px;
            display: block;
            line-height: 1.3;
        }

        select.form-input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #86868b;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f2f2f7;
            border-top: 3px solid #007aff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #86868b;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 12px;
            color: #1d1d1f;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 400px;
            word-wrap: break-word;
        }

        .toast.success { background: #34c759; }
        .toast.error { background: #ff3b30; }
        .toast.warning { background: #ff9500; }
        .toast.show { transform: translateX(0); }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 12px;
        }

        .stat {
            text-align: center;
            padding: 12px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #007aff;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .debug-info {
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 12px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 14px;
            color: #333;
        }

        .billing-status {
            margin-top: 12px;
            padding: 12px;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .billing-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            font-size: 0.85rem;
        }

        .billing-item {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 6px;
        }

        @media (max-width: 768px) {
            .container { padding: 20px 15px; }
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 16px;
            }
            .header-logo {
                max-width: 100px;
            }
            .header h1 { font-size: 1.8rem; }
            .header p { font-size: 1rem; text-align: center; }
            .client-details { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .client-actions { flex-direction: column; }
            .clients-grid { grid-template-columns: 1fr; }
            .stats { grid-template-columns: 1fr 1fr; }
        }
    </style>


    <div class="container">
        <div class="header">
            <div class="header-content">
                <img src="./Logotipo EasyCars Fondo Blanco con Slogan - Copy.jpg" alt="EasyCars Logo" class="header-logo">
                <div class="header-text">
                    <h1>Gesti√≥n de Clientes</h1>
                    <p>Sistema completo para administrar clientes y contratos de leasing</p>
                </div>
            </div>
        </div>

        <!-- Informaci√≥n de debug -->
        <div class="debug-info" id="debugInfo" style="display: none;">
            <strong>Debug Info:</strong><br>
            API URL: <span id="debugApiUrl"></span><br>
            Response Status: <span id="debugStatus"></span><br>
            Response Data: <span id="debugData"></span>
        </div>

        <div class="main-content">
            <!-- Formulario de Cliente -->
            <div class="form-section">
                <h2 id="formTitle">Nuevo Cliente</h2>
                
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="totalClients">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="activeContracts">0</div>
                        <div class="stat-label">Con Contratos</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="billedClients">0</div>
                        <div class="stat-label">Facturados</div>
                    </div>
                    <div class="stat" onclick="window.location.href='capturas.html'" style="cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <div class="stat-value" id="totalPending">‚Ç°0</div>
                        <div class="stat-label">Por Cobrar</div>
                        <div style="font-size: 0.7rem; color: #007aff; margin-top: 4px;">üìä Ver Capturas</div>
                    </div>
                </div>

                <form id="clientForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">ID del Cliente <span class="required">*</span></label>
                            <input type="text" class="form-input" id="ID" required placeholder="Solo n√∫meros (9-15 d√≠gitos)" pattern="[0-9]{9,15}" maxlength="15">
                            <small class="field-help">Solo n√∫meros, entre 9 y 15 d√≠gitos</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nombre Completo <span class="required">*</span></label>
                            <input type="text" class="form-input uppercase" id="Nombre" required placeholder="NOMBRE DEL CLIENTE (se convierte a may√∫sculas)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">N√∫mero de Tel√©fono</label>
                            <input type="tel" class="form-input" id="numeroTelefono" placeholder="50688888888" pattern="506[0-9]{8}" maxlength="11">
                            <small class="field-help">Formato: 506 + 8 d√≠gitos (ej: 50688888888)</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Placa del Veh√≠culo</label>
                            <input type="text" class="form-input uppercase" id="Placa" placeholder="ABC123 (se convierte a may√∫sculas)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ID Grupo WhatsApp</label>
                            <div style="display: flex; gap: 8px; align-items: flex-end;">
                                <input type="text" class="form-input" id="idGrupoWhatsapp" placeholder="120363295526322228@g.us" style="flex: 1;">
                                <button type="button" class="btn btn-secondary" onclick="openGroupSearchModal()" style="white-space: nowrap; padding: 12px 16px; min-height: 44px;">
                                    üîç Buscar Grupo
                                </button>
                            </div>
                            <small class="field-help">Formato: n√∫meros@g.us (ej: 120363295526322228@g.us)</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">D√≠a de Pago Semanal</label>
                            <select class="form-input" id="diaPago">
                                <option value="">-- Seleccionar d√≠a de la semana --</option>
                                <option value="Lunes">Lunes</option>
                                <option value="Martes">Martes</option>
                                <option value="Mi√©rcoles">Mi√©rcoles</option>
                                <option value="Jueves">Jueves</option>
                                <option value="Viernes">Viernes</option>
                                <option value="S√°bado">S√°bado</option>
                                <option value="Domingo">Domingo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Monto Semanal del Contrato (‚Ç°)</label>
                            <input type="number" class="form-input" id="montoContrato" step="1000" placeholder="50000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Vendedor Asignado</label>
                            <select class="form-input" id="ID_Vendedor">
                                <option value="">-- Seleccionar vendedor --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha de Inicio del Contrato</label>
                            <input type="date" class="form-input" id="fechaContrato">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Duraci√≥n del Contrato (semanas)</label>
                            <input type="number" class="form-input" id="plazoContrato" placeholder="52" min="1" max="520">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 16px; margin-top: 32px; justify-content: center; flex-wrap: wrap;">
                        <button type="submit" class="btn btn-primary btn-large" id="submitBtn">
                            üíæ Guardar Cliente
                        </button>
                        <button type="button" class="btn btn-secondary btn-large" id="cancelBtn" onclick="cancelEdit()" style="display: none;">
                            ‚ùå Cancelar Edici√≥n
                        </button>
                        <button type="button" class="btn btn-secondary btn-large" onclick="toggleDebug()">
                            üêõ Debug
                        </button>
                    </div>
                </form>
            </div>

            <!-- Lista de Clientes -->
            <div class="clients-section">
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="üîç Buscar clientes por nombre, ID, placa o tel√©fono..." id="searchInput">
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Cargando clientes...</p>
                </div>

                <div class="clients-grid" id="clientsGrid"></div>

                <div class="empty-state" id="emptyState" style="display: none;">
                    <h3>üìã No hay clientes registrados</h3>
                    <p>Utiliza el formulario de arriba para agregar tu primer cliente al sistema</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL_CLIENTS = 'https://sheetdb.io/api/v1/qu62bagiwlgqy';
        const API_URL_INVOICES = 'https://sheetdb.io/api/v1/qu62bagiwlgqy';
        
        let clients = [];
        let invoices = [];
        let vendors = [];
        let currentClient = null;
        let isEditing = false;

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticaci√≥n antes de inicializar - DESHABILITADO TEMPORALMENTE
            // checkAuthentication();
            initializeApp();
            setupEventListeners();
        });
        
        // Verificar autenticaci√≥n
        function checkAuthentication() {
            const urlParams = new URLSearchParams(window.location.search);
            const isAdmin = urlParams.get('admin') === 'true';
            const isVendor = urlParams.get('vendor') === 'true';
            
            // Si no hay par√°metros de autenticaci√≥n, verificar sesi√≥n
            if (!isAdmin && !isVendor) {
                const session = localStorage.getItem('vendorSession');
                
                if (session) {
                    const sessionData = JSON.parse(session);
                    const now = new Date();
                    const expiresAt = new Date(sessionData.expiresAt);
                    
                    if (now < expiresAt) {
                        console.log('‚úÖ Sesi√≥n v√°lida encontrada');
                        // Redirigir con par√°metros de sesi√≥n
                        if (sessionData.vendorId === '112220831') {
                            window.location.href = '/clientes.html?admin=true';
                        } else {
                            window.location.href = '/clientes.html?vendor=true';
                        }
                        return;
                    } else {
                        console.log('‚ùå Sesi√≥n expirada');
                        localStorage.removeItem('vendorSession');
                    }
                }
                
                // No hay sesi√≥n v√°lida, redirigir al login
                console.log('üîí No hay sesi√≥n v√°lida, redirigiendo al login');
                window.location.href = '/login.html';
                return;
            }
            
            // Si hay par√°metros de autenticaci√≥n, continuar normalmente
            console.log('‚úÖ Acceso autorizado a clientes');
        }

        async function initializeApp() {
            console.log('=== INICIALIZANDO APLICACI√ìN ===');
            showLoading(true);
            
            try {
                // Cargar clientes, facturas y vendedores EN PARALELO
                console.log('Cargando clientes, facturas y vendedores...');
                await Promise.all([
                    loadClientsData(),
                    loadInvoicesData(),
                    loadVendorsData()
                ]);
                
                console.log('‚úÖ Todas las cargas completadas');
                console.log('Clientes cargados:', clients.length);
                console.log('Facturas cargadas:', invoices.length);
                console.log('Vendedores cargados:', vendors.length);
                
                // AHORA renderizar la interfaz con todos los datos
                renderClients(clients);
                console.log('üîÑ Antes de llamar updateStats()');
                updateStats();
                console.log('‚úÖ Despu√©s de llamar updateStats()');
                populateVendorSelect();
                
                showToast(`Sistema cargado: ${clients.length} clientes, ${invoices.length} facturas, ${vendors.length} vendedores`, 'success');
                
            } catch (error) {
                console.error('Error al inicializar:', error);
                showToast('Error al cargar datos del sistema', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadClientsData() {
            const apiUrl = `${API_URL_CLIENTS}?sheet=Clientes`;
            console.log('Cargando clientes desde:', apiUrl);
            
            const response = await fetch(apiUrl);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            clients = Array.isArray(data) ? data : [];
            clients = clients.filter(client => client.ID && client.ID.toString().trim() !== '');
            
            console.log('Clientes procesados:', clients.length);
        }

        async function loadInvoicesData() {
            const apiUrl = `${API_URL_INVOICES}?sheet=Facturas`;
            console.log('Cargando facturas desde:', apiUrl);
            
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                invoices = await response.json();
                console.log('‚úÖ Facturas cargadas:', invoices.length);
                
            } catch (error) {
                console.error('‚ùå Error cargando facturas:', error);
                showToast('Error al cargar facturas', 'error');
                invoices = [];
            }
        }
        
        async function loadVendorsData() {
            const apiUrl = `${API_URL_CLIENTS}?sheet=Usuarios`;
            console.log('Cargando vendedores desde:', apiUrl);
            
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                vendors = await response.json();
                console.log('‚úÖ Vendedores cargados:', vendors.length);
                
            } catch (error) {
                console.error('‚ùå Error cargando vendedores:', error);
                showToast('Error al cargar vendedores', 'error');
                vendors = [];
            }
        }
        
        function populateVendorSelect() {
            const vendorSelect = document.getElementById('ID_Vendedor');
            if (!vendorSelect) return;
            
            // Limpiar opciones existentes excepto la primera
            vendorSelect.innerHTML = '<option value="">-- Seleccionar vendedor --</option>';
            
            // Agregar vendedores activos
            vendors.filter(vendor => vendor.estado === 'Activo').forEach(vendor => {
                const option = document.createElement('option');
                option.value = vendor.id;
                option.textContent = `${vendor.nombre} (${vendor.id})`;
                vendorSelect.appendChild(option);
            });
        }

        function setupEventListeners() {
            // B√∫squeda en tiempo real
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function(e) {
                filterClients(e.target.value);
            });
            
            // Navegar al primer resultado al presionar Enter en la b√∫squeda
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Obtener el t√©rmino de b√∫squeda
                    const searchTerm = e.target.value.trim();
                    
                    if (searchTerm) {
                        // Filtrar clientes
                        const filtered = clients.filter(client => 
                            (client.Nombre || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                            (client.ID || '').toString().toLowerCase().includes(searchTerm.toLowerCase()) ||
                            (client.numeroTelefono || '').toString().toLowerCase().includes(searchTerm.toLowerCase()) ||
                            (client.Placa || '').toLowerCase().includes(searchTerm.toLowerCase())
                        );
                        
                        // Si hay resultados, navegar al primero
                        if (filtered.length > 0) {
                            const firstClient = filtered[0];
                            console.log('üöÄ Navegando al primer resultado:', firstClient.Nombre, 'ID:', firstClient.ID);
                            viewInvoices(firstClient.ID);
                        } else {
                            // Si no hay resultados, solo filtrar
                            filterClients(searchTerm);
                        }
                    } else {
                        // Si no hay t√©rmino de b√∫squeda, solo filtrar
                        filterClients(searchTerm);
                    }
                }
            });

            // Formulario de cliente
            document.getElementById('clientForm').addEventListener('submit', function(e) {
                e.preventDefault();
                if (validateForm()) {
                    saveClient();
                }
            });

            // Validaci√≥n en tiempo real del ID
            document.getElementById('ID').addEventListener('input', function(e) {
                const value = e.target.value;
                e.target.value = value.replace(/[^0-9]/g, '');
                validateID(e.target);
            });

            // Validaci√≥n en tiempo real del tel√©fono
            document.getElementById('numeroTelefono').addEventListener('input', function(e) {
                const value = e.target.value;
                e.target.value = value.replace(/[^0-9]/g, '');
                validatePhone(e.target);
            });

            // Validaci√≥n en tiempo real del ID de WhatsApp
            document.getElementById('idGrupoWhatsapp').addEventListener('input', function(e) {
                validateWhatsAppID(e.target);
            });

            // ===== NUEVO: CONVERSI√ìN AUTOM√ÅTICA A MAY√öSCULAS =====
            // Nombre del cliente
            document.getElementById('Nombre').addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
            });

            // Placa del veh√≠culo
            document.getElementById('Placa').addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
            });
        }

        async function loadClients() {
            // Esta funci√≥n ahora solo recarga y re-renderiza
            console.log('=== RECARGANDO CLIENTES ===');
            showLoading(true);
            try {
                await loadClientsData();
                await loadInvoicesData(); // Tambi√©n recargar facturas por si cambiaron
                await loadVendorsData(); // Recargar vendedores por si cambiaron
                renderClients(clients);
                updateStats();
            } catch (error) {
                console.error('Error al recargar clientes:', error);
                showToast('Error al recargar clientes: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadInvoices() {
            // Esta funci√≥n ahora solo recarga facturas
            console.log('=== RECARGANDO FACTURAS ===');
            try {
                await loadInvoicesData();
                renderClients(clients); // Re-renderizar para actualizar botones
                updateStats();
            } catch (error) {
                console.error('Error al recargar facturas:', error);
            }
        }

        function updateOverdueFines() {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Resetear horas para comparaci√≥n exacta
            
            console.log('\n=== DEBUG FECHAS DE VENCIMIENTO ===');
            console.log('Hoy (objeto Date):', today);
            console.log('Hoy (string):', formatDateForDB(today));
            
            let hasUpdates = false;
            let totalProcessed = 0;
            let totalPending = 0;
            let totalOverdue = 0;
            let debugCount = 0;
            
            invoices.forEach(invoice => {
                if (invoice.Estado === 'Pendiente') {
                    totalProcessed++;
                    const dueDateStr = invoice.FechaVencimiento;
                    
                    // Debug solo las primeras 5 facturas
                    if (debugCount < 5) {
                        console.log(`\n--- DEBUG FACTURA ${invoice.NumeroFactura} ---`);
                        console.log('Fecha vencimiento (string):', dueDateStr);
                        
                        const dueDate = parseDate(dueDateStr);
                        console.log('Fecha vencimiento (parseada):', dueDate);
                        
                        if (dueDate) {
                            console.log('¬øEs v√°lida?:', dueDate instanceof Date && !isNaN(dueDate));
                            console.log('¬øHoy > Vencimiento?:', today > dueDate);
                            
                            const diffTime = today.getTime() - dueDate.getTime();
                            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                            console.log('Diferencia en d√≠as:', diffDays);
                        }
                        debugCount++;
                    }
                    
                    // Validar que la fecha de vencimiento sea v√°lida
                    if (!dueDateStr || dueDateStr === '' || dueDateStr === 'undefined') {
                        console.warn('Factura con fecha inv√°lida:', invoice.NumeroFactura);
                        return;
                    }
                    
                    let newStatus = 'Pendiente';
                    let newDaysOverdue = 0;
                    let newFines = 0;
                    
                    // Parsear la fecha de vencimiento
                    const dueDate = parseDate(dueDateStr);
                    
                    if (!dueDate || isNaN(dueDate)) {
                        console.warn(`Fecha inv√°lida para factura ${invoice.NumeroFactura}:`, dueDateStr);
                        return; // Saltar esta factura
                    }
                    
                    // Resetear horas para comparaci√≥n exacta
                    dueDate.setHours(0, 0, 0, 0);
                    
                    // Comparaci√≥n directa de fechas (objetos Date)
                    if (today > dueDate) {
                        // Hoy es DESPU√âS del d√≠a de vencimiento = Pendiente con multas
                        const diffTime = today.getTime() - dueDate.getTime();
                        newDaysOverdue = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                        newFines = newDaysOverdue * 2000;
                        newStatus = 'Pendiente'; // Mantener como Pendiente, no cambiar a Vencido
                        totalOverdue++;
                        
                        if (debugCount <= 5) {
                            console.log(`‚ö†Ô∏è FACTURA PENDIENTE CON MULTA: ${invoice.NumeroFactura}, d√≠as: ${newDaysOverdue}`);
                        }
                    } else {
                        // Hoy es el d√≠a de vencimiento o antes = Pendiente
                        newDaysOverdue = 0;
                        newFines = 0;
                        newStatus = 'Pendiente';
                        totalPending++;
                        
                        if (debugCount <= 5) {
                            console.log(`‚úÖ FACTURA PENDIENTE: ${invoice.NumeroFactura}`);
                        }
                    }
                    
                    const newTotal = parseAmount(invoice.MontoBase || 0) + newFines;
                    
                    // Solo actualizar si hay cambios
                    if (invoice.DiasAtraso != newDaysOverdue || 
                        invoice.MontoMultas != newFines || 
                        invoice.Estado !== newStatus) {
                        
                        invoice.DiasAtraso = newDaysOverdue;
                        invoice.MontoMultas = newFines;
                        invoice.MontoTotal = newTotal;
                        invoice.Estado = newStatus;
                        hasUpdates = true;
                    }
                }
            });
            
            console.log(`\n=== RESUMEN FINAL ===`);
            console.log(`Procesadas: ${totalProcessed} | Pendientes: ${totalPending} | Vencidas: ${totalOverdue}`);
            
            if (hasUpdates) {
                console.log('‚úÖ Estados actualizados');
            }
        }

        function updateDebugInfo(key, value) {
            const element = document.getElementById(`debug${key}`);
            if (element) {
                element.textContent = value;
            }
        }

        function toggleDebug() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }

        function getClientBillingInfo(clientId) {
            // Asegurar que clientId sea string para comparaci√≥n
            const searchId = clientId.toString();
            
            const clientInvoices = invoices.filter(inv => {
                const invClientId = inv.ID_Cliente ? inv.ID_Cliente.toString() : '';
                return invClientId === searchId;
            });
            
            if (clientInvoices.length === 0) {
                return { status: 'not_billed', invoices: [], summary: null };
            }
            
            // Contar por estado
            const pending = clientInvoices.filter(inv => inv.Estado === 'Pendiente');
            const cancelled = clientInvoices.filter(inv => inv.Estado === 'Cancelado');
            
                    const totalPending = pending.reduce((sum, inv) => sum + parseAmount(inv.MontoTotal || 0), 0);
        const totalCancelled = cancelled.reduce((sum, inv) => sum + parseAmount(inv.MontoTotal || 0), 0);
        const totalFines = clientInvoices.reduce((sum, inv) => sum + parseAmount(inv.MontoMultas || 0), 0);
            
            return {
                status: 'billed',
                invoices: clientInvoices,
                summary: {
                    total: clientInvoices.length,
                    pending: pending.length,
                    cancelled: cancelled.length,
                    totalPending,
                    totalCancelled,
                    totalFines
                }
            };
        }

        function renderClients(clientsToRender) {
            console.log('üé® Iniciando renderClients con', clientsToRender?.length, 'clientes');
            
            try {
                const grid = document.getElementById('clientsGrid');
                const emptyState = document.getElementById('emptyState');
                
                if (!clientsToRender || clientsToRender.length === 0) {
                    grid.innerHTML = '';
                    emptyState.style.display = 'block';
                    return;
                }

                emptyState.style.display = 'none';
                
                grid.innerHTML = clientsToRender.map(client => {
                    const hasContract = client.fechaContrato && client.montoContrato && client.plazoContrato;
                    const billingInfo = getClientBillingInfo(client.ID);
                    const isBilled = billingInfo.status === 'billed';
                    // Determinar qu√© bot√≥n mostrar
                    let actionButton = '';
                    if (hasContract) {
                        if (!isBilled) {
                            actionButton = `
                                <button class="btn btn-success" onclick="event.stopPropagation(); billClient('${client.ID}')" id="billBtn-${client.ID}">
                                    üìÑ Facturar
                                </button>
                            `;
                        } else {
                            actionButton = `
                                <button class="btn btn-warning" onclick="event.stopPropagation(); viewInvoices('${client.ID}')">
                                    üìã Ver Facturas
                                </button>
                            `;
                        }
                    } else {
                        actionButton = `
                            <button class="btn btn-secondary" disabled title="Contrato incompleto">
                                üìÑ Sin Contrato
                            </button>
                        `;
                    }
                    let billingStatusHtml = '';
                    if (isBilled && billingInfo.summary) {
                        const s = billingInfo.summary;
                        billingStatusHtml = `
                            <div class="billing-status">
                                <div class="billing-summary">
                                    <div class="billing-item">
                                        <div style="color: #34c759; font-weight: 600;">${s.cancelled}</div>
                                        <div style="font-size: 0.75rem; color: #86868b;">Canceladas</div>
                                    </div>
                                    <div class="billing-item">
                                        <div style="color: #ff9500; font-weight: 600;">${s.pending}</div>
                                        <div style="font-size: 0.75rem; color: #86868b;">Pendientes</div>
                                    </div>
                                    <div class="billing-item">
                                        <div style="color: #ff3b30; font-weight: 600;">‚Ç°${s.totalFines.toLocaleString('es-CR')}</div>
                                        <div style="font-size: 0.75rem; color: #86868b;">Multas</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    return `
                        <div class="client-card ${isBilled ? 'billed' : ''}" id="card-${client.ID}" onclick="viewInvoices('${client.ID}')" style="cursor: pointer;">
                            <div class="client-header">
                                <div class="client-info">
                                    <div class="client-name">${client.Nombre || 'Sin nombre'}</div>
                                    <div class="client-id">ID: ${client.ID || 'Sin ID'}</div>
                                </div>
                            </div>
                            <div class="client-details">
                                ${client.numeroTelefono ? `
                                    <div class="detail-row">
                                        <span class="detail-label">Tel√©fono</span>
                                        <span class="detail-value">${client.numeroTelefono.toString().replace(/^(506)(\d{4})(\d{4})$/, '$1 $2 $3')}</span>
                                    </div>
                                ` : ''}
                                ${client.Placa ? `
                                    <div class="detail-row">
                                        <span class="detail-label">Placa</span>
                                        <span class="detail-value">${client.Placa}</span>
                                    </div>
                                ` : ''}
                                ${client.idGrupoWhatsapp ? `
                                    <div class="detail-row">
                                        <span class="detail-label">WhatsApp</span>
                                        <span class="detail-value" style="font-size: 0.85rem; word-break: break-all;">${client.idGrupoWhatsapp}</span>
                                    </div>
                                ` : ''}
                                ${client.diaPago ? `
                                    <div class="detail-row">
                                        <span class="detail-label">D√≠a de Pago</span>
                                        <span class="detail-value">${client.diaPago}</span>
                                    </div>
                                ` : ''}
                                ${hasContract ? `
                                    <div class="detail-row">
                                        <span class="detail-label">Monto Semanal</span>
                                        <span class="detail-value amount-badge">‚Ç°${parseAmount(client.montoContrato || 0).toLocaleString('es-CR')}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Fecha Inicio</span>
                                        <span class="detail-value">${formatDateForDisplay(client.fechaContrato)}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Duraci√≥n</span>
                                        <span class="detail-value">${client.plazoContrato} semanas</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Total Contrato</span>
                                        <span class="detail-value amount-badge">‚Ç°${(parseAmount(client.montoContrato || 0) * parseInt(client.plazoContrato || 0)).toLocaleString('es-CR')}</span>
                                    </div>
                                    <div class="detail-row" style="grid-column: 1 / -1;">
                                        <span class="detail-label">Estado Facturaci√≥n</span>
                                        <span class="detail-value">
                                            <span class="status-badge ${isBilled ? 'status-billed' : 'status-pending'}">
                                                ${isBilled ? '‚úÖ Facturado' : '‚è≥ Sin Facturar'}
                                            </span>
                                        </span>
                                    </div>
                                ` : `
                                    <div class="detail-row" style="grid-column: 1 / -1;">
                                        <span class="detail-label">Estado del Contrato</span>
                                        <span class="detail-value" style="color: #ff9500; font-weight: 600;">‚ö†Ô∏è Informaci√≥n de contrato incompleta</span>
                                    </div>
                                `}
                            </div>
                            ${billingStatusHtml}
                            <div class="client-actions" style="margin-top: 18px; justify-content: flex-start;">
                                <button class="btn btn-secondary" onclick="event.stopPropagation(); editClient('${client.ID}')">
                                    ‚úèÔ∏è Editar
                                </button>
                                ${actionButton}
                                <button class="btn btn-danger" onclick="event.stopPropagation(); deleteClient('${client.ID}')">
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error en renderClients:', error);
                showToast('Error al renderizar clientes: ' + error.message, 'error');
            }
        }

        function filterClients(searchTerm) {
            if (!searchTerm.trim()) {
                renderClients(clients);
                return;
            }

            const filtered = clients.filter(client => 
                (client.Nombre || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                (client.ID || '').toString().toLowerCase().includes(searchTerm.toLowerCase()) ||
                (client.numeroTelefono || '').toString().toLowerCase().includes(searchTerm.toLowerCase()) ||
                (client.Placa || '').toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            renderClients(filtered);
        }

        function updateStats() {
            console.log('üìä Iniciando updateStats()...');
            console.log('üìä Variables disponibles:', {
                clients: clients.length,
                invoices: invoices.length,
                vendors: vendors.length
            });
            
            try {
                const totalClients = clients.length;
                const activeContracts = clients.filter(client => 
                    client.fechaContrato && client.montoContrato && client.plazoContrato
                ).length;
                const billedClients = clients.filter(client => 
                    getClientBillingInfo(client.ID).status === 'billed'
                ).length;
                
                console.log('üìä Estad√≠sticas calculadas:', {
                    totalClients,
                    activeContracts,
                    billedClients
                });
            
                const totalPending = invoices
                    .filter(inv => {
                        // Incluir facturas con estado "Vencido" O facturas pendientes que ya vencieron
                        if (inv.Estado === 'Vencido') return true;
                        
                        // Verificar si es una factura pendiente que ya venci√≥
                        if (inv.Estado === 'Pendiente' && inv.FechaVencimiento) {
                            const fechaVencimiento = parseDate(inv.FechaVencimiento);
                            const hoy = new Date();
                            return fechaVencimiento < hoy;
                        }
                        
                        return false;
                    })
                    .reduce((sum, inv) => {
                        // Parsear montos como enteros, no decimales
                        // Limpiar formato costarricense: "104.000" -> "104000"
                        const montoBaseRaw = (inv.MontoTotal || '0').toString();
                        const multasRaw = (inv.Multas || '0').toString();
                        
                        // Remover puntos (separadores de miles) y convertir a entero
                        const montoBase = parseInt(montoBaseRaw.replace(/\./g, ''));
                        const multas = parseInt(multasRaw.replace(/\./g, ''));
                        const subtotal = montoBase + multas;
                        
                        // Debug individual
                        if (montoBase > 0 || multas > 0) {
                            console.log(`üîç Factura ${inv.ID_Factura}: Raw="${montoBaseRaw}"->${montoBase}, MultasRaw="${multasRaw}"->${multas}, Subtotal=${subtotal}`);
                        }
                        
                        return sum + subtotal;
                    }, 0);

            // Debug: Mostrar informaci√≥n sobre las facturas
            console.log('üîç DEBUG - C√°lculo POR COBRAR:');
            console.log('Total facturas cargadas:', invoices.length);
            
            // Verificar facturas vencidas por estado
            const facturasVencidasPorEstado = invoices.filter(inv => inv.Estado === 'Vencido');
            console.log('Facturas con estado "Vencido":', facturasVencidasPorEstado.length);
            
            // Verificar facturas pendientes que ya vencieron
            const facturasPendientesVencidas = invoices.filter(inv => {
                if (inv.Estado === 'Pendiente' && inv.FechaVencimiento) {
                    const fechaVencimiento = parseDate(inv.FechaVencimiento);
                    const hoy = new Date();
                    return fechaVencimiento < hoy;
                }
                return false;
            });
            console.log('Facturas pendientes que ya vencieron:', facturasPendientesVencidas.length);
            
            console.log('Facturas por estado:', invoices.reduce((acc, inv) => {
                acc[inv.Estado] = (acc[inv.Estado] || 0) + 1;
                return acc;
            }, {}));
            
            // Mostrar todos los estados √∫nicos para verificar
            const estadosUnicos = [...new Set(invoices.map(inv => inv.Estado))];
            console.log('üìä Estados √∫nicos encontrados:', estadosUnicos);
            
            // Mostrar detalle de facturas vencidas por estado
            if (facturasVencidasPorEstado.length > 0) {
                console.log('üìã Detalle facturas con estado "Vencido":');
                facturasVencidasPorEstado.forEach(inv => {
                    console.log(`- ${inv.ID_Factura}: Monto=${inv.MontoTotal}, Multas=${inv.Multas}, Estado=${inv.Estado}`);
                });
            }
            
            // Mostrar detalle de facturas pendientes que ya vencieron
            if (facturasPendientesVencidas.length > 0) {
                console.log('üìã Detalle facturas pendientes vencidas:');
                facturasPendientesVencidas.slice(0, 5).forEach(inv => {
                    const fechaVencimiento = parseDate(inv.FechaVencimiento);
                    const hoy = new Date();
                    const diasVencida = Math.floor((hoy - fechaVencimiento) / (1000 * 60 * 60 * 24));
                    console.log(`- ${inv.ID_Factura}: MontoRaw="${inv.MontoTotal}", MultasRaw="${inv.Multas}", FechaVencimiento=${inv.FechaVencimiento}, Vencida hace ${diasVencida} d√≠as`);
                });
                if (facturasPendientesVencidas.length > 5) {
                    console.log(`... y ${facturasPendientesVencidas.length - 5} m√°s`);
                }
            }
            
            console.log('üí∞ Total POR COBRAR calculado:', totalPending);

                document.getElementById('totalClients').textContent = totalClients;
                document.getElementById('activeContracts').textContent = activeContracts;
                document.getElementById('billedClients').textContent = billedClients;
                // Formatear n√∫mero manualmente para evitar problemas con toLocaleString
                const formattedAmount = Math.round(totalPending).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                document.getElementById('totalPending').textContent = `‚Ç°${formattedAmount}`;
            } catch (error) {
                console.error('Error en updateStats:', error);
                showToast('Error al actualizar estad√≠sticas', 'error');
            }
        }

        async function billClient(clientId) {
            const client = clients.find(c => c.ID.toString() === clientId.toString());
            if (!client) {
                showToast('Cliente no encontrado', 'error');
                return;
            }

            // Verificar que el contrato est√© completo
            if (!client.fechaContrato || !client.montoContrato || !client.plazoContrato) {
                showToast('El contrato del cliente est√° incompleto', 'error');
                return;
            }

            // Verificar si ya est√° facturado
            const billingInfo = getClientBillingInfo(clientId);
            if (billingInfo.status === 'billed') {
                showToast('Este cliente ya ha sido facturado', 'warning');
                return;
            }

            // Deshabilitar bot√≥n mientras procesa
            const billBtn = document.getElementById(`billBtn-${clientId}`);
            if (billBtn) {
                billBtn.disabled = true;
                billBtn.textContent = '‚è≥ Facturando...';
            }

            try {
                const invoicesData = generateInvoicesForClient(client);
                
                // Enviar todas las facturas en lote
                const response = await fetch(`${API_URL_INVOICES}?sheet=Facturas`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(invoicesData)
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                // Recargar facturas y actualizar vista
                await loadInvoices();
                renderClients(clients);
                updateStats();
                
                // ===== NUEVO: REDIRIGIR AUTOM√ÅTICAMENTE A LA P√ÅGINA DE FACTURAS =====
                showToast(`‚úÖ Cliente facturado exitosamente: ${invoicesData.length} facturas generadas. Redirigiendo a facturas...`, 'success');
                
                // Mostrar contador regresivo y redirigir
                let countdown = 3;
                const countdownInterval = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        showToast(`üîÑ Redirigiendo a facturas en ${countdown} segundos...`, 'warning');
                    } else {
                        clearInterval(countdownInterval);
                        window.location.href = `https://arrendautos.app/facturas.html?clientId=${clientId}`;
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error al facturar cliente:', error);
                showToast('Error al generar facturas: ' + error.message, 'error');
                
                // Restaurar bot√≥n
                if (billBtn) {
                    billBtn.disabled = false;
                    billBtn.textContent = 'üìÑ Facturar';
                }
            }
        }

        function generateInvoicesForClient(client) {
            const invoicesData = [];
            const signDate = parseDate(client.fechaContrato); // Fecha de firma usando parseDate
            const contractStartDate = new Date(signDate);
            contractStartDate.setDate(signDate.getDate() + 1); // Contrato inicia un d√≠a despu√©s
            
            console.log(`Fecha de firma: ${client.fechaContrato}`);
            console.log(`Fecha de inicio contrato: ${formatDateForDB(contractStartDate)}`);
            
            const weeklyAmount = parseAmount(client.montoContrato);
            const totalWeeks = parseInt(client.plazoContrato);
            const paymentDay = client.diaPago;
            
            // Obtener el √∫ltimo n√∫mero de factura para generar consecutivos
            let lastInvoiceNumber = 0;
            invoices.forEach(inv => {
                if (inv.NumeroFactura && inv.NumeroFactura.startsWith('FAC-')) {
                    const num = parseInt(inv.NumeroFactura.split('-')[1]);
                    if (num > lastInvoiceNumber) {
                        lastInvoiceNumber = num;
                    }
                }
            });

            for (let week = 1; week <= totalWeeks; week++) {
                // Calcular fecha de inicio de la semana (desde el d√≠a que inicia el contrato)
                const weekStartDate = new Date(contractStartDate);
                weekStartDate.setDate(contractStartDate.getDate() + (week - 1) * 7);
                
                // Calcular fecha de fin de la semana
                const weekEndDate = new Date(weekStartDate);
                weekEndDate.setDate(weekStartDate.getDate() + 6);
                
                // Calcular fecha de vencimiento (un d√≠a despu√©s del fin de semana)
                const dueDate = getNextPaymentDate(weekEndDate, paymentDay);
                
                // Generar descripci√≥n de la semana
                const weekDescription = generateWeekDescription(weekStartDate, weekEndDate);
                
                // N√∫mero de factura consecutivo
                lastInvoiceNumber++;
                const invoiceNumber = `FAC-${lastInvoiceNumber.toString().padStart(3, '0')}`;
                
                const invoiceData = {
                    ID_Cliente: client.ID,
                    NumeroFactura: invoiceNumber,
                    SemanaNumero: week,
                    SemanaDescripcion: weekDescription,
                    FechaVencimiento: formatDateForStorage(dueDate), // DD/MM/YYYY para Google Sheets
                    MontoBase: weeklyAmount,
                    DiasAtraso: 0,
                    MontoMultas: 0,
                    MontoTotal: weeklyAmount,
                    Estado: 'Pendiente',
                    FechaCreacion: formatDateForStorage(new Date()), // DD/MM/YYYY para Google Sheets
                    FechaPago: '',
                    Observaciones: `Factura generada autom√°ticamente para ${client.Nombre}`
                };
                
                invoicesData.push(invoiceData);
            }
            
            return invoicesData;
        }

        function getNextPaymentDate(weekEndDate, paymentDay) {
            // La fecha de vencimiento es simplemente un d√≠a despu√©s del fin de semana
            const dueDate = new Date(weekEndDate);
            dueDate.setDate(weekEndDate.getDate() + 1);
            return dueDate;
        }

        function generateWeekDescription(startDate, endDate) {
            const months = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            const startDay = startDate.getDate();
            const startMonth = months[startDate.getMonth()];
            const startYear = startDate.getFullYear();
            
            const endDay = endDate.getDate();
            const endMonth = months[endDate.getMonth()];
            const endYear = endDate.getFullYear();
            
            if (startMonth === endMonth && startYear === endYear) {
                return `Semana del ${startDay} al ${endDay} de ${startMonth} del ${startYear}`;
            } else if (startYear === endYear) {
                return `Semana del ${startDay} de ${startMonth} al ${endDay} de ${endMonth} del ${startYear}`;
            } else {
                return `Semana del ${startDay} de ${startMonth} del ${startYear} al ${endDay} de ${endMonth} del ${endYear}`;
            }
        }

        function parseDate(dateString) {
            if (!dateString) return null;
            
            // Detectar si es formato DD/MM/YYYY (como viene de Google Sheets)
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1; // JavaScript usa meses 0-11
                    const year = parseInt(parts[2]);
                    
                    // Validar que los valores sean razonables
                    if (day >= 1 && day <= 31 && month >= 0 && month <= 11 && year >= 2025) {
                        return new Date(year, month, day);
                    }
                }
            }
            
            // Si es formato YYYY-MM-DD (como formatDateForDB)
            if (dateString.includes('-')) {
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    const year = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1; // JavaScript usa meses 0-11
                    const day = parseInt(parts[2]);
                    
                    if (day >= 1 && day <= 31 && month >= 0 && month <= 11 && year >= 2025) {
                        return new Date(year, month, day);
                    }
                }
            }
            
            console.warn('Fecha no reconocida:', dateString);
            return null;
        }

        function formatDateForDisplay(dateString) {
            const date = parseDate(dateString);
            return date ? date.toLocaleDateString('es-CR') : dateString;
        }

        function formatDateForDB(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`; // YYYY-MM-DD para logging/debugging
        }

        function formatDateForStorage(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${day}/${month}/${year}`; // DD/MM/YYYY para Google Sheets
        }

        // FUNCI√ìN MODIFICADA: Ahora redirige a URL externa
        async function viewInvoices(clientId) {
            const client = clients.find(c => c.ID.toString() === clientId.toString());
            if (!client) {
                showToast('Cliente no encontrado', 'error');
                return;
            }
            // Redirigir a la URL correcta - siempre permitir navegaci√≥n
            window.location.href = `https://arrendautos.app/facturas.html?clientId=${clientId}`;
        }

        async function markAsPaid(invoiceNumber) {
            try {
                // Usar URLSearchParams para SheetDB PATCH
                const params = new URLSearchParams();
                params.append('sheet', 'Facturas'); // Especificar la hoja
                params.append('Estado', 'Pagado');
                params.append('FechaPago', formatDateForStorage(new Date())); // DD/MM/YYYY para Google Sheets
                
                const response = await fetch(`${API_URL_INVOICES}/NumeroFactura/${invoiceNumber}?${params.toString()}`, {
                    method: 'PATCH'
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                await loadInvoices();
                renderClients(clients);
                updateStats();
                
                showToast(`Factura ${invoiceNumber} marcada como pagada`, 'success');
                
            } catch (error) {
                console.error('Error al marcar como pagado:', error);
                showToast('Error al actualizar factura: ' + error.message, 'error');
            }
        }

        function editClient(clientId) {
            const client = clients.find(c => c.ID.toString() === clientId.toString());
            if (!client) return;

            currentClient = client;
            isEditing = true;

            document.getElementById('formTitle').textContent = 'Editar Cliente';
            document.getElementById('submitBtn').innerHTML = 'üíæ Actualizar Cliente';
            document.getElementById('cancelBtn').style.display = 'inline-flex';

            fillForm(client);
            document.getElementById('ID').disabled = true;

            document.querySelectorAll('.client-card').forEach(card => {
                card.classList.remove('editing');
            });
            document.getElementById(`card-${clientId}`).classList.add('editing');

            document.querySelector('.form-section').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }

        function cancelEdit() {
            currentClient = null;
            isEditing = false;

            document.getElementById('formTitle').textContent = 'Nuevo Cliente';
            document.getElementById('submitBtn').innerHTML = 'üíæ Guardar Cliente';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('ID').disabled = false;

            clearForm();
            clearValidationStyles();

            document.querySelectorAll('.client-card').forEach(card => {
                card.classList.remove('editing');
            });
        }

        function clearValidationStyles() {
            const inputs = ['ID', 'numeroTelefono', 'idGrupoWhatsapp'];
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.style.borderColor = '';
                    input.style.boxShadow = '';
                }
            });
        }

        function fillForm(client) {
            document.getElementById('ID').value = client.ID || '';
            document.getElementById('Nombre').value = client.Nombre || '';
            document.getElementById('numeroTelefono').value = client.numeroTelefono || '';
            document.getElementById('idGrupoWhatsapp').value = client.idGrupoWhatsapp || '';
            document.getElementById('Placa').value = client.Placa || '';
            document.getElementById('montoContrato').value = client.montoContrato || '';
            document.getElementById('fechaContrato').value = client.fechaContrato || '';
            document.getElementById('plazoContrato').value = client.plazoContrato || '';
            document.getElementById('diaPago').value = client.diaPago || '';
            document.getElementById('ID_Vendedor').value = client.ID_Vendedor || '';
        }

        function clearForm() {
            document.getElementById('clientForm').reset();
        }

        function validateID(input) {
            const value = input.value;
            const isValid = value.length >= 9 && value.length <= 15 && /^[0-9]+$/.test(value);
            
            if (value && !isValid) {
                input.style.borderColor = '#ff3b30';
                input.style.boxShadow = '0 0 0 3px rgba(255, 59, 48, 0.1)';
            } else {
                input.style.borderColor = isValid ? '#34c759' : '#d2d2d7';
                input.style.boxShadow = isValid ? '0 0 0 3px rgba(52, 199, 89, 0.1)' : '';
            }
            
            return isValid;
        }

        function validatePhone(input) {
            const value = input.value;
            const isValid = value === '' || (/^506[0-9]{8}$/.test(value) && value.length === 11);
            
            if (value && !isValid) {
                input.style.borderColor = '#ff3b30';
                input.style.boxShadow = '0 0 0 3px rgba(255, 59, 48, 0.1)';
            } else {
                input.style.borderColor = isValid && value ? '#34c759' : '#d2d2d7';
                input.style.boxShadow = isValid && value ? '0 0 0 3px rgba(52, 199, 89, 0.1)' : '';
            }
            
            return isValid;
        }

        function validateWhatsAppID(input) {
            const value = input.value.trim();
            const isValid = value === '' || /^[0-9]+@g\.us$/.test(value);
            
            if (value && !isValid) {
                input.style.borderColor = '#ff3b30';
                input.style.boxShadow = '0 0 0 3px rgba(255, 59, 48, 0.1)';
            } else {
                input.style.borderColor = isValid && value ? '#34c759' : '#d2d2d7';
                input.style.boxShadow = isValid && value ? '0 0 0 3px rgba(52, 199, 89, 0.1)' : '';
            }
            
            return isValid;
        }

        function validateForm() {
            const idInput = document.getElementById('ID');
            const phoneInput = document.getElementById('numeroTelefono');
            const whatsappInput = document.getElementById('idGrupoWhatsapp');
            const nameInput = document.getElementById('Nombre');
            
            if (!idInput.value) {
                showToast('El ID del cliente es obligatorio', 'error');
                idInput.focus();
                return false;
            }
            
            if (!validateID(idInput)) {
                showToast('El ID debe tener entre 9 y 15 d√≠gitos num√©ricos', 'error');
                idInput.focus();
                return false;
            }
            
            if (!nameInput.value.trim()) {
                showToast('El nombre del cliente es obligatorio', 'error');
                nameInput.focus();
                return false;
            }
            
            if (phoneInput.value && !validatePhone(phoneInput)) {
                showToast('El tel√©fono debe tener el formato: 506 + 8 d√≠gitos (ej: 50688888888)', 'error');
                phoneInput.focus();
                return false;
            }

            if (whatsappInput.value && !validateWhatsAppID(whatsappInput)) {
                showToast('El ID de WhatsApp debe tener el formato: n√∫meros@g.us (ej: 120363295526322228@g.us)', 'error');
                whatsappInput.focus();
                return false;
            }
            
            return true;
        }

        async function saveClient() {
            const formData = {
                ID: document.getElementById('ID').value.trim(),
                Nombre: document.getElementById('Nombre').value.trim().toUpperCase(),
                numeroTelefono: document.getElementById('numeroTelefono').value.trim(),
                idGrupoWhatsapp: document.getElementById('idGrupoWhatsapp').value.trim(),
                Placa: document.getElementById('Placa').value.trim().toUpperCase(),
                montoContrato: document.getElementById('montoContrato').value.trim(),
                fechaContrato: document.getElementById('fechaContrato').value.trim(),
                plazoContrato: document.getElementById('plazoContrato').value.trim(),
                diaPago: document.getElementById('diaPago').value.trim(),
                ID_Vendedor: document.getElementById('ID_Vendedor').value.trim()
            };

            if (!formData.ID || !formData.Nombre) {
                showToast('Por favor completa los campos obligatorios (ID y Nombre)', 'error');
                return;
            }

            if (!isEditing && clients.some(client => client.ID.toString() === formData.ID.toString())) {
                showToast('Ya existe un cliente con ese ID', 'error');
                return;
            }

            try {
                let response;
                
                if (isEditing) {
                    // Para actualizar, usar el formato correcto de SheetDB PATCH
                    const updateUrl = `${API_URL_CLIENTS}/ID/${currentClient.ID}`;
                    
                    // Crear URLSearchParams para los datos de actualizaci√≥n
                    const params = new URLSearchParams();
                    params.append('sheet', 'Clientes'); // Especificar la hoja
                    
                    Object.keys(formData).forEach(key => {
                        if (formData[key] !== '' && key !== 'ID') { // No incluir ID en la actualizaci√≥n
                            params.append(key, formData[key]);
                        }
                    });
                    
                    response = await fetch(`${updateUrl}?${params.toString()}`, {
                        method: 'PATCH'
                    });
                } else {
                    // Para crear, usar POST con JSON
                    response = await fetch(`${API_URL_CLIENTS}?sheet=Clientes`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                cancelEdit();
                await loadClients();
                
                // Mejorar experiencia de usuario: filtrar y mostrar solo el cliente reci√©n guardado
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    // Llenar el campo de b√∫squeda con el nombre del cliente
                    searchInput.value = formData.Nombre;
                    // Filtrar la lista para mostrar solo este cliente
                    filterClients(formData.Nombre);
                }
                
                // Hacer scroll hacia la tarjeta del cliente
                setTimeout(() => {
                    const clientCard = document.getElementById(`card-${formData.ID}`);
                    if (clientCard) {
                        clientCard.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                    }
                }, 100);
                
                showToast(isEditing ? 'Cliente actualizado correctamente' : 'Cliente creado correctamente', 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al guardar cliente: ' + error.message, 'error');
            }
        }

        async function deleteClient(clientId) {
            const client = clients.find(c => c.ID.toString() === clientId.toString());
            if (!client) return;

            if (!confirm(`¬øEst√°s seguro de que deseas eliminar al cliente "${client.Nombre}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL_CLIENTS}/ID/${clientId}?sheet=Clientes`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Error al eliminar cliente');

                await loadClients();
                showToast('Cliente eliminado correctamente', 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al eliminar cliente: ' + error.message, 'error');
            }
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            const grid = document.getElementById('clientsGrid');
            
            if (show) {
                loading.style.display = 'block';
                grid.style.display = 'none';
            } else {
                loading.style.display = 'none';
                grid.style.display = 'grid';
            }
        }

        function showToast(message, type) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 100);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ===== FUNCIONES PARA B√öSQUEDA DE GRUPOS DE WHATSAPP =====
        
        // Configuraci√≥n de la API de UltraMsg
        const ULTRA_MSG_CONFIG = {
            instanceId: "instance112077",
            token: "wp98xs1qrfhqg9ya"
        };

        function openGroupSearchModal() {
            // Primero verificar si hay valor en el campo placa
            const placaValue = document.getElementById('Placa').value.trim();
            
            if (placaValue) {
                // Si hay placa, usar autom√°ticamente para buscar grupos
                document.getElementById('groupNameInput').value = placaValue;
                searchWhatsAppGroups();
            } else {
                // Si no hay placa, mostrar el modal para que el usuario digite
                const modal = document.getElementById('groupSearchModal');
                modal.classList.add('show');
                
                // Limpiar campos anteriores
                document.getElementById('groupNameInput').value = '';
                document.getElementById('searchResults').style.display = 'none';
                document.getElementById('searchLoading').style.display = 'none';
                document.getElementById('groupsList').innerHTML = '';
                
                // Enfocar el campo de entrada
                setTimeout(() => {
                    document.getElementById('groupNameInput').focus();
                }, 100);
            }
        }

        function closeGroupSearchModal() {
            const modal = document.getElementById('groupSearchModal');
            modal.classList.remove('show');
        }

        async function searchWhatsAppGroups() {
            const groupName = document.getElementById('groupNameInput').value.trim();
            
            if (!groupName) {
                showToast('Por favor ingresa el nombre del grupo a buscar', 'warning');
                return;
            }

            // Asegurar que el modal est√© visible para mostrar resultados
            const modal = document.getElementById('groupSearchModal');
            if (!modal.classList.contains('show')) {
                modal.classList.add('show');
            }

            const searchLoading = document.getElementById('searchLoading');
            const searchResults = document.getElementById('searchResults');
            const groupsList = document.getElementById('groupsList');

            try {
                // Mostrar loading
                searchLoading.style.display = 'block';
                searchResults.style.display = 'none';
                groupsList.innerHTML = '';

                // Llamar a la API de UltraMsg
                const url = `https://api.ultramsg.com/${ULTRA_MSG_CONFIG.instanceId}/chats?token=${ULTRA_MSG_CONFIG.token}`;
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const data = await response.json();
                
                // Filtrar solo grupos que contengan el nombre buscado
                const grupos = data.filter(g => 
                    g.isGroup && 
                    g.name && 
                    g.name.toLowerCase().includes(groupName.toLowerCase())
                );

                // Ocultar loading
                searchLoading.style.display = 'none';

                if (grupos.length === 0) {
                    groupsList.innerHTML = '<p style="color: #86868b; text-align: center; padding: 20px;">No se encontraron grupos con ese nombre.</p>';
                    searchResults.style.display = 'block';
                    return;
                }

                // Mostrar resultados
                let html = '';
                grupos.forEach(grupo => {
                    html += `
                        <div class="group-item" style="padding: 12px; border: 1px solid #e0e0e0; border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: background-color 0.2s;" 
                             onmouseover="this.style.backgroundColor='#f8f9fa'" 
                             onmouseout="this.style.backgroundColor='white'"
                             onclick="selectGroup('${grupo.id}', '${grupo.name.replace(/'/g, "\\'")}')">
                            <div style="font-weight: 600; color: #1d1d1f; margin-bottom: 4px;">${grupo.name}</div>
                            <div style="font-size: 0.85rem; color: #86868b;">ID: ${grupo.id}</div>
                        </div>
                    `;
                });

                groupsList.innerHTML = html;
                searchResults.style.display = 'block';

            } catch (error) {
                console.error('Error al buscar grupos:', error);
                searchLoading.style.display = 'none';
                showToast('Error al buscar grupos: ' + error.message, 'error');
            }
        }

        function selectGroup(groupId, groupName) {
            // Rellenar el campo ID del grupo
            document.getElementById('idGrupoWhatsapp').value = groupId;
            
            // Cerrar el modal
            closeGroupSearchModal();
            
            // Mostrar notificaci√≥n de √©xito
            showToast(`Grupo seleccionado: ${groupName}`, 'success');
        }

        // Permitir b√∫squeda con Enter
        document.addEventListener('DOMContentLoaded', function() {
            const groupNameInput = document.getElementById('groupNameInput');
            if (groupNameInput) {
                groupNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchWhatsAppGroups();
                    }
                });
            }
        });
    </script>

    <!-- Modal para buscar grupos de WhatsApp -->
    <div class="modal-overlay" id="groupSearchModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîç Buscar Grupo de WhatsApp</h3>
                <button class="modal-close" onclick="closeGroupSearchModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nombre del Grupo</label>
                    <input type="text" class="form-input" id="groupNameInput" placeholder="Ingresa el nombre del grupo a buscar...">
                    <small class="field-help">Escribe parte del nombre del grupo para buscarlo</small>
                </div>
                
                <div id="searchResults" style="display: none;">
                    <h4 style="margin: 16px 0 8px 0; color: #1d1d1f;">Resultados de b√∫squeda:</h4>
                    <div id="groupsList" style="max-height: 200px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px;"></div>
                </div>
                
                <div id="searchLoading" style="display: none; text-align: center; padding: 20px;">
                    <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto 10px;"></div>
                    <p>Buscando grupos...</p>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeGroupSearchModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="searchWhatsAppGroups()">üîç Buscar Grupos</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot√≥n Volver al Inicio -->
    <a href="index.html" class="home-button" title="Volver al Inicio">
        üè†
    </a>