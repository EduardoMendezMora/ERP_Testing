<!DOCTYPE html>
<html lang="es">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Inteligente de Transacciones Bancarias</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 60px 20px;
            background: linear-gradient(135deg, #000 0%, #333 100%);
            border-radius: 20px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 12px;
            background: linear-gradient(90deg, #ffffff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.25rem;
            font-weight: 400;
            opacity: 0.8;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-section {
            background: white;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .bank-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            padding: 8px;
            background: #f2f2f7;
            border-radius: 12px;
        }

        .bank-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 15px;
            font-weight: 600;
            color: #86868b;
        }

        .bank-btn:hover {
            background: rgba(255,255,255,0.5);
        }

        .bank-btn.active {
            background: #007aff;
            color: white;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.25);
        }

        .search-container {
            position: relative;
            margin-bottom: 24px;
        }

        .search-box {
            width: 100%;
            padding: 16px 52px 16px 20px;
            font-size: 17px;
            font-weight: 400;
            border: 2px solid #d2d2d7;
            border-radius: 12px;
            outline: none;
            transition: all 0.2s ease;
            background: #fbfbfd;
            -webkit-appearance: none;
        }

        .search-box:focus {
            border-color: #007aff;
            background: white;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #8e8e93;
            font-size: 18px;
        }

        /* ESTILOS PARA DASHBOARD DE ESTAD√çSTICAS */
        .stats-dashboard {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .stats-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff9500, #ff6b35);
        }

        .stats-card.older::before {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }

        .stats-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            color: #86868b;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stats-number {
            font-size: 3rem;
            font-weight: 800;
            color: #ff9500;
            line-height: 1;
            margin-bottom: 8px;
        }

        .stats-number.older {
            color: #e74c3c;
        }

        .stats-description {
            color: #515154;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 16px;
        }

        .stats-banks {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .bank-stat {
            text-align: center;
            padding: 12px 8px;
            background: #f8f9fa;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .bank-stat:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .bank-icon {
            font-size: 20px;
            margin-bottom: 4px;
            display: block;
        }

        .bank-count {
            font-size: 18px;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 2px;
        }

        .bank-name {
            font-size: 11px;
            color: #86868b;
            font-weight: 600;
            text-transform: uppercase;
        }

        .stats-highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            margin-top: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .older-transaction {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 12px;
            margin-top: 12px;
        }

        .older-ref {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 14px;
            color: #007aff;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .older-amount {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 16px;
            font-weight: 700;
            color: #e74c3c;
            margin-bottom: 4px;
        }

        .older-days {
            background: #e74c3c;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        @media (max-width: 768px) {
            .stats-dashboard {
                grid-template-columns: 1fr;
                gap: 16px;
                margin-bottom: 24px;
            }

            .stats-banks {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .stats-number {
                font-size: 2.5rem;
            }

            .stats-card {
                padding: 20px;
            }
        }
        .ai-analysis-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            color: white;
            display: none;
        }

        .ai-analysis-panel.show {
            display: block;
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .ai-title {
            font-size: 16px;
            font-weight: 600;
        }

        .ai-status {
            font-size: 14px;
            opacity: 0.9;
        }

        .ai-progress {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .ai-progress-bar {
            height: 100%;
            background: rgba(255,255,255,0.8);
            width: 0%;
            transition: width 0.3s ease;
        }

        .suggestion-item {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .suggestion-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .suggestion-confidence {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .suggestion-content {
            flex: 1;
            font-size: 13px;
            line-height: 1.4;
        }

        .suggestion-text {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 10px;
            border-radius: 6px;
            margin-top: 4px;
            font-style: italic;
        }

        /* ESTILOS PARA SUGERENCIAS EN LAS TRANSACCIONES */
        .observations-container {
            position: relative;
            display: flex;
            align-items: stretch;
            gap: 8px;
        }

        /* ESTILOS PARA BOTONES DE SUGERENCIAS POR DEMANDA */
        .suggestions-btn {
            background: linear-gradient(135deg, #007aff, #0056cc) !important;
            color: white !important;
            border: none !important;
            padding: 6px 12px !important;
            border-radius: 6px !important;
            font-size: 12px !important;
            cursor: pointer !important;
            margin-left: 8px !important;
            transition: all 0.2s ease !important;
            font-weight: 500 !important;
            white-space: nowrap !important;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3) !important;
        }

        .suggestions-btn:hover {
            background: linear-gradient(135deg, #0056cc, #004499) !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4) !important;
        }

        .suggestions-btn:active {
            transform: translateY(0) !important;
        }

        /* Responsive para botones de sugerencias */
        @media (max-width: 768px) {
            .suggestions-btn {
                padding: 8px 12px !important;
                font-size: 12px !important;
                min-height: 44px !important;
            }
        }

        .cell-observations {
            font-size: 14px;
            color: #515154;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            min-height: 36px;
            display: flex;
            align-items: center;
            background: #f8f9fa;
            flex: 1;
        }

        .cell-observations:hover {
            background: #e9ecef;
            border-color: #007aff;
        }

        .cell-observations.empty {
            color: #86868b;
            font-style: italic;
        }

        .cell-observations.has-suggestion {
            border-left: 4px solid #ff9500;
            background: linear-gradient(90deg, rgba(255, 149, 0, 0.1) 0%, #f8f9fa 100%);
        }

        .suggestion-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #ff9500, #ff6b35);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(255, 149, 0, 0.3);
            position: relative;
            animation: pulse 2s infinite;
            z-index: 100;
            flex-shrink: 0;
        }

        .suggestion-indicator:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(255, 149, 0, 0.4);
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
                box-shadow: 0 4px 12px rgba(255, 149, 0, 0.4);
            }
            50% {
                transform: scale(1.1);
                opacity: 0.9;
                box-shadow: 0 6px 20px rgba(255, 149, 0, 0.6);
            }
        }

        .suggestion-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            width: 90vw;
            max-width: 500px;
            font-size: 14px;
            line-height: 1.5;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.8);
            transition: all 0.3s ease;
            pointer-events: none;
            border: 3px solid #ff9500;
        }

        .suggestion-panel.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        .suggestion-panel-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .suggestion-panel-backdrop.show {
            opacity: 1;
            pointer-events: auto;
        }

        .suggestion-options {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .suggestion-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .suggestion-btn.apply {
            background: #27ae60;
            color: white;
        }

        .suggestion-btn.apply:hover {
            background: #219a52;
        }

        .suggestion-btn.dismiss {
            background: #95a5a6;
            color: white;
        }

        .suggestion-btn.dismiss:hover {
            background: #7f8c8d;
        }

        .date-filter-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .date-filter-section.active {
            background: #e3f2fd;
            border-color: #2196f3;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.15);
        }

        .date-filter-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .date-filter-title {
            font-size: 16px;
            font-weight: 600;
            color: #1d1d1f;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-filter-controls {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 12px;
            align-items: end;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .date-label {
            font-size: 14px;
            font-weight: 500;
            color: #666;
        }

        .date-input {
            padding: 12px 16px;
            border: 2px solid #d2d2d7;
            border-radius: 8px;
            font-size: 15px;
            background: white;
            transition: all 0.2s ease;
        }

        .date-input:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .date-filter-actions {
            display: flex;
            gap: 8px;
        }

        .date-btn {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .date-btn.apply {
            background: #2196f3;
            color: white;
        }

        .date-btn.apply:hover {
            background: #1976d2;
        }

        .date-btn.clear {
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
        }

        .date-btn.clear:hover {
            background: #e0e0e0;
        }

        .date-filter-status {
            background: #2196f3;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
        }

        .date-filter-status.show {
            display: flex;
        }

        .filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 1px solid #d2d2d7;
            background: #fbfbfd;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 15px;
            font-weight: 500;
            color: #1d1d1f;
        }

        .filter-btn:hover {
            background: #f2f2f7;
            border-color: #a1a1a6;
        }

        .filter-btn.active {
            background: #007aff;
            color: white;
            border-color: #007aff;
        }

        .results-section {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .results-header {
            background: #f2f2f7;
            padding: 16px 24px;
            border-bottom: 1px solid #d2d2d7;
            font-weight: 600;
            font-size: 15px;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table-header {
            background: #fbfbfd;
            border-bottom: 1px solid #d2d2d7;
            font-weight: 600;
            font-size: 14px;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            user-select: none;
        }

        .table-header:hover {
            background: #f2f2f7;
        }

        .table-header, .transaction-row {
            display: grid;
            grid-template-columns: 120px 140px 1fr 140px 280px;
            gap: 20px;
            padding: 16px 24px;
            align-items: center;
        }

        .sortable-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 4px 8px;
            border-radius: 6px;
            user-select: none;
        }

        .sortable-header:hover {
            background: rgba(0, 122, 255, 0.1);
            color: #007aff;
            transform: translateY(-1px);
        }

        .sortable-header:active {
            transform: translateY(0);
        }

        .sort-indicator {
            font-size: 12px;
            margin-left: 4px;
            opacity: 0.6;
            transition: all 0.2s ease;
            min-width: 12px;
            text-align: center;
        }

        .sort-indicator.active {
            opacity: 1;
            color: #007aff;
            font-weight: bold;
        }

        .sort-indicator.asc::after {
            content: '‚ñ≤';
        }

        .sort-indicator.desc::after {
            content: '‚ñº';
        }

        .sort-indicator:not(.active)::after {
            content: '‚áÖ';
        }

        .sort-indicator:hover::after {
            content: '‚áÖ';
        }

        .sortable-header:hover .sort-indicator:not(.active) {
            opacity: 1;
        }

        .transaction-row {
            padding: 20px 24px;
            border-bottom: 1px solid #f2f2f7;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }

        .transaction-row:hover {
            background: #f9f9f9;
        }

        .transaction-row:last-child {
            border-bottom: none;
        }

        .cell {
            font-size: 15px;
            font-weight: 400;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cell-date {
            font-weight: 500;
            color: #1d1d1f;
        }

        .cell-reference {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 14px;
            color: #007aff;
            font-weight: 500;
        }

        .cell-code {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            min-width: 30px;
        }

        .code-ts {
            background: #d1f2eb;
            color: #00875a;
        }

        .code-tf {
            background: #deebff;
            color: #0052cc;
        }

        .cell-description {
            color: #515154;
            line-height: 1.4;
        }

        .cell-amount {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 15px;
            font-weight: 600;
            color: #30d158;
            text-align: right;
            white-space: nowrap;
            overflow: visible;
            min-width: 120px;
        }

        .observations-editor {
            position: relative;
            display: block;
            width: 100%;
        }

        .observations-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #007aff;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            outline: none;
            resize: vertical;
            min-height: 36px;
            background: white;
        }

        .observations-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            justify-content: flex-end;
        }

        .observations-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .observations-btn.save {
            background: #007aff;
            color: white;
        }

        .observations-btn.save:hover {
            background: #0056b3;
        }

        .observations-btn.cancel {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #ddd;
        }

        .observations-btn.cancel:hover {
            background: #e9ecef;
        }

        .share-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #25d366;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3);
            z-index: 10;
        }

        .share-btn:hover {
            background: #128c7e;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
        }

        .share-btn:active {
            transform: scale(0.95);
        }

        .copy-btn {
            position: absolute;
            top: 8px;
            right: 48px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
            z-index: 10;
        }

        .copy-btn:hover {
            background: #0056b3;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
        }

        .copy-btn:active {
            transform: scale(0.95);
        }

        .copy-btn.copied {
            background: #30d158;
            animation: copySuccess 0.6s ease;
        }

        @keyframes copySuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #86868b;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #f2f2f7;
            border-top: 2px solid #007aff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #ffeae7;
            color: #d1242f;
            padding: 16px 24px;
            margin: 16px 24px;
            border-radius: 12px;
            border: 1px solid #ffbdba;
            font-weight: 500;
        }

        .initial-state, .no-results {
            text-align: center;
            padding: 80px 20px;
            color: #86868b;
        }

        .state-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.4;
        }

        .state-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1d1d1f;
        }

        .state-description {
            font-size: 16px;
            max-width: 400px;
            margin: 0 auto;
        }

        .results-info {
            padding: 16px 24px;
            background: #f2f2f7;
            border-bottom: 1px solid #d2d2d7;
            font-size: 14px;
            color: #515154;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .results-info-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .results-info-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .results-info-btn.pending {
            background: #ff9500;
            color: white;
        }

        .results-info-btn.pending:hover {
            background: #e6850e;
            transform: translateY(-1px);
        }

        .results-info-btn.copy {
            background: #007aff;
            color: white;
        }

        .results-info-btn.copy:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .saving-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #007aff;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 350px;
        }

        .saving-indicator.show {
            transform: translateX(0);
        }

        .saving-indicator.success {
            background: #30d158;
        }

        .saving-indicator.error {
            background: #ff3b30;
        }

        .saving-indicator-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .saving-indicator-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .saving-indicator-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .saving-indicator-btn.primary {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .saving-indicator-btn.primary:hover {
            background: white;
        }

        /* NUEVOS ESTILOS PARA WHATSAPP NOTIFICATION */
        .whatsapp-notification {
            position: fixed;
            top: 70px;
            right: 20px;
            background: linear-gradient(135deg, #25d366, #128c7e);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 9998;
            box-shadow: 0 8px 24px rgba(37, 211, 102, 0.4);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .whatsapp-notification.show {
            transform: translateX(0);
        }

        .whatsapp-notification .icon {
            font-size: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        mark {
            background: #ffeb3b;
            color: #1d1d1f;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .table-header, .transaction-row {
                grid-template-columns: 100px 120px 1fr 120px 220px;
                gap: 12px;
            }
        }

        @media (max-width: 1024px) {
            .table-header, .transaction-row {
                grid-template-columns: 90px 110px 1fr 110px 200px;
                gap: 10px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .header {
                padding: 40px 20px;
                margin-bottom: 24px;
            }

            .header h1 {
                font-size: 2.2rem;
            }

            .search-section {
                padding: 24px;
                margin-bottom: 24px;
            }

            .table-header {
                display: none;
            }

            .transaction-row {
                display: block;
                padding: 20px;
                border-radius: 12px;
                margin: 8px 16px;
                border: 1px solid #f2f2f7;
                background: white;
            }

            .transaction-row:hover {
                background: #f9f9f9;
            }

            .mobile-row {
                margin-bottom: 12px;
            }

            .mobile-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                gap: 12px;
            }

            .mobile-bank-date {
                display: flex;
                align-items: center;
                gap: 8px;
                flex-shrink: 0;
            }

            .mobile-bank-icon {
                font-size: 16px;
            }

            .mobile-amount-container {
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                min-width: 0;
                flex: 1;
            }

            .mobile-amount-label {
                font-size: 10px;
                color: #86868b;
                text-transform: uppercase;
                font-weight: 600;
                letter-spacing: 0.5px;
                margin-bottom: 2px;
            }

            .mobile-amount {
                font-family: 'SF Mono', Monaco, monospace;
                font-size: 18px;
                font-weight: 700;
                color: #30d158;
                text-align: right;
                line-height: 1.2;
                word-break: break-word;
                hyphens: auto;
            }

            .mobile-details {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                margin-bottom: 12px;
            }

            .mobile-detail {
                display: flex;
                flex-direction: column;
            }

            .mobile-label {
                font-size: 12px;
                color: #86868b;
                text-transform: uppercase;
                font-weight: 600;
                margin-bottom: 4px;
                letter-spacing: 0.5px;
            }

            .mobile-description {
                background: #f2f2f7;
                padding: 12px;
                border-radius: 8px;
                font-size: 14px;
                color: #515154;
                line-height: 1.4;
            }

            .date-filter-controls {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .date-filter-actions {
                justify-content: stretch;
            }

            .date-btn {
                flex: 1;
                text-align: center;
            }

            .observations-container {
                flex-direction: column;
                gap: 8px;
            }

            .suggestion-indicator {
                align-self: flex-start;
            }

            /* Responsive para nuevos botones */
            .results-info {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .results-info-buttons {
                justify-content: center;
                flex-wrap: wrap;
            }

            .results-info-btn {
                flex: 1;
                min-width: 120px;
            }

            .saving-indicator {
                right: 10px;
                left: 10px;
                transform: translateY(-100%);
                max-width: none;
            }

            .saving-indicator.show {
                transform: translateY(0);
            }

            .saving-indicator-buttons {
                flex-direction: column;
            }

            /* Mejoras adicionales para pantallas muy peque√±as */
            @media (max-width: 480px) {
                .mobile-header {
                    flex-direction: column;
                    align-items: stretch;
                    gap: 8px;
                }

                .mobile-bank-date {
                    justify-content: center;
                }

                .mobile-amount-container {
                    align-items: center;
                    text-align: center;
                }

                .mobile-amount {
                    font-size: 20px;
                }

                .mobile-amount-label {
                    font-size: 11px;
                }
            }

            @media (max-width: 360px) {
                .mobile-amount {
                    font-size: 16px;
                }

                .mobile-bank-icon {
                    font-size: 14px;
                }

                .cell-date {
                    font-size: 12px;
                }
            }
        }

        @media (max-width: 480px) {
            .filters {
                justify-content: center;
            }

            .filter-btn {
                flex: 1;
                min-width: 80px;
                text-align: center;
            }

            .mobile-details {
                grid-template-columns: 1fr;
            }
        }
    </style>



    <div class="container">
        <div class="header">
            <h1>üß† Transacciones Inteligentes</h1>
            <p>Sistema con IA para sugerencias por demanda de conciliaci√≥n + WhatsApp</p>
        </div>

        <!-- Dashboard de Estad√≠sticas -->
        <div class="stats-dashboard" id="statsDashboard" style="display: none;">
            <div class="stats-card">
                <div class="stats-header">
                    <span>‚ö†Ô∏è</span>
                    TRANSACCIONES PENDIENTES DE CONCILIAR
                </div>
                <div class="stats-number" id="pendingCount">0</div>
                <div class="stats-description" id="pendingDescription">
                    Desde el 10/07/2025 sin observaciones<br>
                    <strong id="pendingPercentage">0%</strong> del total pendiente
                </div>
                <div class="stats-banks" id="bankStats">
                    <div class="bank-stat">
                        <span class="bank-icon">üîµ</span>
                        <div class="bank-count" id="bacCount">0</div>
                        <div class="bank-name">BAC</div>
                    </div>
                    <div class="bank-stat">
                        <span class="bank-icon">üü¢</span>
                        <div class="bank-count" id="bnCount">0</div>
                        <div class="bank-name">BN</div>
                    </div>
                    <div class="bank-stat">
                        <span class="bank-icon">üü°</span>
                        <div class="bank-count" id="huberCount">0</div>
                        <div class="bank-name">Huber</div>
                    </div>
                    <div class="bank-stat">
                        <span class="bank-icon">üü†</span>
                        <div class="bank-count" id="autoBacCount">0</div>
                        <div class="bank-name">Auto BAC</div>
                    </div>
                    <div class="bank-stat">
                        <span class="bank-icon">üü£</span>
                        <div class="bank-count" id="autoBnCount">0</div>
                        <div class="bank-name">Auto BN</div>
                    </div>
                </div>
                <div class="stats-highlight" id="aiSuggestionsInfo" style="display: none;">
                    üß† <span id="suggestionsCount">0</span> sugerencias IA generadas por demanda
                </div>
            </div>

            <div class="stats-card older">
                <div class="stats-header">
                    <span>‚è∞</span>
                    TRANSACCI√ìN M√ÅS ANTIGUA
                </div>
                <div class="stats-number older" id="oldestDays">0</div>
                <div class="stats-description">
                    d√≠as sin conciliar<br>
                    <strong id="oldestDate">--/--/----</strong>
                </div>
                <div class="older-transaction" id="oldestTransaction" style="display: none;">
                    <div class="older-ref" id="oldestRef">Ref: --------</div>
                    <div class="older-amount" id="oldestAmount">¬¢0,00</div>
                    <div class="older-days" id="oldestDaysLabel">0 d√≠as sin conciliar</div>
                </div>
            </div>
        </div>

        <div class="search-section">
            <div class="bank-selector">
                <button class="bank-btn active" data-bank="all">üè¶ Todos los Bancos</button>
                <button class="bank-btn" data-bank="BAC">üîµ BAC San Jos√©</button>
                <button class="bank-btn" data-bank="BN">üü¢ Banco Nacional</button>
                <button class="bank-btn" data-bank="HuberBN">üü° Huber BN</button>
                <button class="bank-btn" data-bank="AutosubastasBAC">üü† Autosubastas BAC</button>
                <button class="bank-btn" data-bank="AutosubastasBN">üü£ Autosubastas BN</button>
            </div>

            <!-- Panel de An√°lisis de IA -->
            <div class="ai-analysis-panel" id="aiAnalysisPanel">
                <div class="ai-header">
                    <span style="font-size: 20px;">üß†</span>
                    <div>
                        <div class="ai-title">An√°lisis Inteligente en Progreso</div>
                        <div class="ai-status" id="aiStatus">Analizando transacciones desde 10/07/2025...</div>
                    </div>
                </div>
                <div class="ai-progress">
                    <div class="ai-progress-bar" id="aiProgressBar"></div>
                </div>
                <div id="aiSuggestionsList"></div>
            </div>

            <div class="search-container">
                <input
                    type="text"
                    class="search-box"
                    id="searchInput"
                    placeholder="Buscar por referencia, descripci√≥n, c√≥digo o monto (ej: 150000)..."
                    autocomplete="off"
                >
                <span class="search-icon">‚åï</span>
            </div>

            <div class="date-filter-section" id="dateFilterSection">
                <div class="date-filter-header">
                    <div class="date-filter-title">
                        üìÖ Filtro de Fecha
                        <small style="color: #666; font-weight: 400;">(opcional - independiente de la b√∫squeda)</small>
                    </div>
                </div>
               
                <div class="date-filter-controls">
                    <div class="date-input-group">
                        <label class="date-label">Desde:</label>
                        <input type="date" class="date-input" id="dateFrom">
                    </div>
                   
                    <div class="date-input-group">
                        <label class="date-label">Hasta:</label>
                        <input type="date" class="date-input" id="dateTo">
                    </div>
                   
                    <div class="date-filter-actions">
                        <button class="date-btn apply" id="applyDateFilter">
                            üîç Aplicar
                        </button>
                        <button class="date-btn clear" id="clearDateFilter">
                            ‚ùå Limpiar
                        </button>
                    </div>
                </div>

                <div class="date-filter-status" id="dateFilterStatus">
                    <span>üìÖ Filtro de fecha activo: <span id="dateRangeText"></span></span>
                    <button style="background: none; border: none; color: white; cursor: pointer; font-size: 16px;" onclick="window.transactionSearchSystem.clearDateFilter()">‚ùå</button>
                </div>
            </div>
           
            <div class="filters">
                <button class="filter-btn active" data-filter="all">Todas</button>
                <button class="filter-btn" id="observationsFilter"
                        style="background: #6c757d; color: white; border-color: #6c757d;"
                        title="Filtrar por estado de observaciones">
                    üîÑ Todas
                </button>
                <button class="filter-btn" id="pendingButton" onclick="window.transactionSearchSystem.goToPendingTransactions()"
                        style="background: #ff9500; color: white; border-color: #ff9500;"
                        title="Ver transacciones pendientes de conciliar">
                    üìù Pendientes
                </button>
                <button class="filter-btn" onclick="window.transactionSearchSystem.exportObservations()"
                        style="background: #30d158; color: white; border-color: #30d158;">
                    üì• Exportar
                </button>
                <button class="filter-btn" onclick="window.transactionSearchSystem.debugSuggestions()"
                        style="background: #e74c3c; color: white; border-color: #e74c3c;"
                        title="Debug: Ver informaci√≥n de sugerencias">
                    üîç Debug IA
                </button>
            </div>
        </div>

        <div class="results-section">
            <div id="loadingIndicator" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Cargando transacciones...</p>
            </div>

            <div id="errorMessage" class="error-message" style="display: none;"></div>

            <div id="resultsInfo" class="results-info" style="display: none;"></div>

            <div id="initialState" class="initial-state">
                <div class="state-icon">üß†</div>
                <div class="state-title">Sistema Inteligente Cargando</div>
                <div class="state-description">
                    Analizando transacciones y generando sugerencias autom√°ticas...<br>
                    <small>üí° El sistema buscar√° similitudes con transacciones conciliadas</small>
                </div>
            </div>

            <div id="noResults" class="no-results" style="display: none;">
                <div class="state-icon">üîç</div>
                <div class="state-title">Sin Resultados</div>
                <div class="state-description">No se encontraron transacciones que coincidan con su b√∫squeda</div>
            </div>

            <div id="tableContainer" style="display: none;">
                <!-- Los headers se generan din√°micamente con JavaScript -->
                <div id="resultsContainer"></div>
            </div>
        </div>
    </div>

    <div id="savingIndicator" class="saving-indicator">
        <!-- El contenido se genera din√°micamente -->
    </div>

    <!-- NUEVA NOTIFICACI√ìN PARA WHATSAPP -->
    <div id="whatsappNotification" class="whatsapp-notification">
        <span class="icon">üì±</span>
        <span id="whatsappNotificationText">Enviando a WhatsApp...</span>
    </div>

    <script>
        class SmartTransactionSystem {
            constructor() {
                // API Configuration
                this.apiUrl = 'https://sheetdb.io/api/v1/a7oekivxzreg7';
                this.flotaApiUrl = 'https://sheetdb.io/api/v1/nrzmoa46446mu';
               
                // === CONFIGURACI√ìN DE WHATSAPP ULTRAMSG ===
                this.whatsappConfig = {
                    token: 'wp98xs1qrfhqg9ya',
                    instanceId: 'instance112077',
                    groupId: '120363403929811504@g.us',
                    baseUrl: 'https://api.ultramsg.com'
                };
               
                // Data arrays
                this.allTransactions = [];
                this.bacTransactions = [];
                this.bnTransactions = [];
                this.huberBNTransactions = [];
                this.autosubastasTransactions = [];
                this.autosubastasBNTransactions = [];
                this.filteredTransactions = [];
                this.lastDisplayedResults = []; // Para referencia en funciones de copia
               
                // State management
                this.currentFilter = 'all';
                this.currentBank = 'all';
                this.searchTimeout = null;
                this.isLoading = false;
                this.activeObservationsEditor = null;
               
                // Sorting state
                this.currentSort = {
                    column: null,
                    direction: null // 'asc', 'desc', or null
                };
               
                // Date filter properties
                this.dateFilterActive = false;
                this.dateFromFilter = null;
                this.dateToFilter = null;
               
                // Observations filter properties
                this.observationsFilter = 'all';
               
                // AI System properties
                this.aiSuggestions = new Map();
                this.isAnalyzing = false;
                this.analysisProgress = 0;
                this.conciliatedTransactions = [];
                this.unconciledTransactions = [];
                this.cutoffDate = new Date('2025-07-10');
               
                // Fleet license plates system
                this.placasFlota = [];
               
                this.initializeElements();
                this.bindEvents();
                this.loadTransactions();
            }

            // === NUEVA FUNCI√ìN: ENVIAR MENSAJE DE WHATSAPP ===
            async sendWhatsAppNotification(transaction, observations) {
                try {
                    console.log('üì± Enviando notificaci√≥n de WhatsApp para transacci√≥n conciliada:', transaction.Referencia);
                   
                    // Mostrar notificaci√≥n visual
                    this.showWhatsAppNotification('Enviando a WhatsApp...', 'sending');
                   
                    // Obtener informaci√≥n del usuario (puedes personalizar esto)
                    const userName = this.getCurrentUserName(); // Funci√≥n que debes implementar
                   
                    // Formatear informaci√≥n del banco
                    let bankInfo = '';
                    switch (transaction.banco) {
                        case 'BAC':
                            bankInfo = 'üîµ BAC San Jos√©';
                            break;
                        case 'BN':
                            bankInfo = 'üü¢ Banco Nacional';
                            break;
                        case 'HuberBN':
                            bankInfo = 'üü° Huber BN';
                            break;
                        case 'AutosubastasBAC':
                            bankInfo = 'üü† Autosubastas BAC';
                            break;
                        case 'AutosubastasBN':
                            bankInfo = 'üü£ Autosubastas BN';
                            break;
                        default:
                            bankInfo = transaction.banco;
                    }
                   
                    // Crear mensaje de WhatsApp
                    const message = `*‚úÖ TRANSACCI√ìN CONCILIADA*

${bankInfo}
üìÖ *Fecha:* ${transaction.Fecha || 'N/A'}
üî¢ *Referencia:* ${transaction.Referencia}
üí∞ *Monto:* ${this.formatAmount(transaction.Cr√©ditos)}

üìÑ *Descripci√≥n:*
${transaction.Descripci√≥n || 'Sin descripci√≥n'}

üí¨ *Observaciones agregadas:*
${observations}

üë§ *Conciliado por:* ${userName}
‚è∞ *Hora:* ${new Date().toLocaleString('es-CR')}

---
_Sistema Inteligente de Transacciones_`;

                    // Configurar la llamada a la API de UltraMsg
                    const apiUrl = `${this.whatsappConfig.baseUrl}/${this.whatsappConfig.instanceId}/messages/chat`;
                   
                    const requestBody = {
                        token: this.whatsappConfig.token,
                        to: this.whatsappConfig.groupId,
                        body: message,
                        priority: 1
                    };

                    console.log('üì° Enviando a UltraMsg API:', apiUrl);
                    console.log('üìù Mensaje:', message.substring(0, 100) + '...');

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });

                    const responseData = await response.json();
                    console.log('üì± Respuesta de UltraMsg:', responseData);

                    if (response.ok && responseData.sent) {
                        console.log('‚úÖ Mensaje de WhatsApp enviado exitosamente');
                        this.showWhatsAppNotification('‚úÖ Enviado a WhatsApp', 'success');
                        return true;
                    } else {
                        console.error('‚ùå Error enviando mensaje de WhatsApp:', responseData);
                        this.showWhatsAppNotification('‚ùå Error enviando a WhatsApp', 'error');
                        return false;
                    }

                } catch (error) {
                    console.error('‚ùå Error en sendWhatsAppNotification:', error);
                    this.showWhatsAppNotification('‚ùå Error de conexi√≥n WhatsApp', 'error');
                    return false;
                }
            }

            // === NUEVA FUNCI√ìN: OBTENER NOMBRE DEL USUARIO ===
            getCurrentUserName() {
                // Puedes personalizar esto para obtener el nombre del usuario actual
                // Por ahora retorna un nombre gen√©rico, pero puedes implementar:
                // - Obtener de localStorage
                // - Obtener de una cookie
                // - Obtener de un campo en la interfaz
                // - Obtener del sistema de autenticaci√≥n
               
                const savedUserName = localStorage.getItem('currentUserName');
                if (savedUserName) {
                    return savedUserName;
                }
               
                // Si no hay nombre guardado, pedir al usuario la primera vez
                const userName = prompt('Ingrese su nombre para las notificaciones de WhatsApp:');
                if (userName && userName.trim()) {
                    localStorage.setItem('currentUserName', userName.trim());
                    return userName.trim();
                }
               
                return 'Usuario del Sistema'; // Fallback
            }

            // === NUEVA FUNCI√ìN: MOSTRAR NOTIFICACI√ìN VISUAL DE WHATSAPP ===
            showWhatsAppNotification(message, type = 'info') {
                if (!this.whatsappNotification) {
                    this.whatsappNotification = document.getElementById('whatsappNotification');
                    this.whatsappNotificationText = document.getElementById('whatsappNotificationText');
                }

                if (!this.whatsappNotification || !this.whatsappNotificationText) {
                    console.warn('‚ö†Ô∏è Elementos de notificaci√≥n de WhatsApp no encontrados');
                    return;
                }

                // Configurar el mensaje y icono seg√∫n el tipo
                let icon = 'üì±';
                let backgroundColor = 'linear-gradient(135deg, #25d366, #128c7e)';
               
                switch (type) {
                    case 'sending':
                        icon = '‚è≥';
                        backgroundColor = 'linear-gradient(135deg, #007aff, #0056b3)';
                        break;
                    case 'success':
                        icon = '‚úÖ';
                        backgroundColor = 'linear-gradient(135deg, #30d158, #28a745)';
                        break;
                    case 'error':
                        icon = '‚ùå';
                        backgroundColor = 'linear-gradient(135deg, #ff3b30, #dc3545)';
                        break;
                }

                this.whatsappNotificationText.textContent = message;
                this.whatsappNotification.querySelector('.icon').textContent = icon;
                this.whatsappNotification.style.background = backgroundColor;
                this.whatsappNotification.classList.add('show');

                // Auto-ocultar despu√©s de 3 segundos
                setTimeout(() => {
                    if (this.whatsappNotification) {
                        this.whatsappNotification.classList.remove('show');
                    }
                }, 3000);
            }

            // === FUNCI√ìN MODIFICADA: ACTUALIZAR OBSERVACIONES CON WHATSAPP Y B√öSQUEDA AUTOM√ÅTICA ===
            async updateTransactionObservations(transaction, newObservations) {
                try {
                    console.log('üì° Actualizando observaciones en API...');
                    this.showSavingIndicator('Guardando observaciones...');
                   
                    const sheetName = transaction.banco === 'BN' ? 'BN' :
                                    transaction.banco === 'HuberBN' ? 'HuberBN' :
                                    transaction.banco === 'AutosubastasBAC' ? 'AutosubastasBAC' :
                                    transaction.banco === 'AutosubastasBN' ? 'AutosubastasBN' : 'BAC';
                   
                    const updateUrl = `${this.apiUrl}/Referencia/${transaction.Referencia}?sheet=${sheetName}`;
                   
                    const requestBody = {
                        Observaciones: newObservations,
                        ID_Cliente: newObservations // Guardar el mismo valor en ID_Cliente
                    };
                   
                    const response = await fetch(updateUrl, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                   
                    if (response.ok) {
                        // Actualizar la transacci√≥n localmente
                        transaction.Observaciones = newObservations;
                        transaction.ID_Cliente = newObservations; // Actualizar tambi√©n localmente
                        this.updateTransactionInArrays(transaction);
                       
                        // Remover sugerencia si existe
                        if (this.aiSuggestions.has(transaction.Referencia)) {
                            this.aiSuggestions.delete(transaction.Referencia);
                        }

                        // Mostrar indicador de guardado exitoso con botones
                        this.showSavingIndicator('‚úÖ Transacci√≥n conciliada y enviada a WhatsApp', 'conciliated', true);

                        // === NUEVA FUNCIONALIDAD: ENVIAR A WHATSAPP ===
                        // Solo enviar si hay observaciones (no est√° vaciando el campo)
                        if (newObservations && newObservations.trim() !== '') {
                            console.log('üì± Iniciando env√≠o de notificaci√≥n de WhatsApp...');
                           
                            // Enviar notificaci√≥n de WhatsApp en segundo plano
                            this.sendWhatsAppNotification(transaction, newObservations)
                                .then(success => {
                                    if (success) {
                                        console.log('‚úÖ Notificaci√≥n de WhatsApp enviada correctamente');
                                    } else {
                                        console.warn('‚ö†Ô∏è No se pudo enviar la notificaci√≥n de WhatsApp');
                                    }
                                })
                                .catch(error => {
                                    console.error('‚ùå Error enviando notificaci√≥n de WhatsApp:', error);
                                });
                        }

                        // === NUEVA FUNCIONALIDAD: BUSCAR AUTOM√ÅTICAMENTE LA TRANSACCI√ìN CONCILIADA ===
                        if (newObservations && newObservations.trim() !== '') {
                            console.log('üîç Buscando autom√°ticamente la transacci√≥n conciliada:', transaction.Referencia);
                           
                            // Cambiar filtro a "Con Obs." porque la transacci√≥n ya tiene observaciones
                            this.observationsFilter = 'with';
                            this.updateObservationsFilterUI();
                           
                            // Poner la referencia en el campo de b√∫squeda
                            this.searchInput.value = transaction.Referencia;
                           
                            // Ejecutar b√∫squeda autom√°ticamente
                            setTimeout(() => {
                                this.performSearch(transaction.Referencia);
                                console.log('‚úÖ Transacci√≥n conciliada mostrada autom√°ticamente en resultados');
                            }, 300);
                        } else {
                            // Si se vaciaron las observaciones, recargar vista normal
                            const currentQuery = this.searchInput.value.trim();
                            if (currentQuery || this.dateFilterActive || this.observationsFilter !== 'all') {
                                this.performSearch(currentQuery);
                            } else {
                                this.showInitialState();
                            }
                        }
                       
                    } else {
                        const errorText = await response.text();
                        throw new Error(`Error del servidor: ${response.status} - ${errorText}`);
                    }
                   
                } catch (error) {
                    console.error('‚ùå Error actualizando observaciones:', error);
                    this.showSavingIndicator('‚ùå Error al guardar observaciones', 'error');
                    alert(`Error al guardar observaciones:\n\n${error.message}\n\nRevisa la consola (F12) para m√°s detalles.`);
                }
               
                this.closeObservationsEditor();
            }

            // === FUNCI√ìN MODIFICADA: APLICAR SUGERENCIA CON WHATSAPP ===
            async applySuggestion(referencia) {
                const suggestion = this.aiSuggestions.get(referencia);
                if (!suggestion) return;

                const transaction = suggestion.transaction;
                const suggestedObservation = suggestion.suggestions[0].suggestedObservation;

                try {
                    console.log('üß† Aplicando sugerencia IA:', suggestedObservation);
                   
                    // Aplicar la observaci√≥n sugerida (incluir√° el env√≠o de WhatsApp autom√°ticamente)
                    await this.updateTransactionObservations(transaction, suggestedObservation);
                   
                    // Remover la sugerencia del mapa
                    this.aiSuggestions.delete(referencia);

                    // Actualizar dashboard de estad√≠sticas
                    this.updateAISuggestionsDashboard();

                    // Mensaje especial para sugerencias IA con botones
                    this.showSavingIndicator('üß† Sugerencia IA aplicada y enviada a WhatsApp', 'conciliated', true);
                   
                } catch (error) {
                    console.error('‚ùå Error aplicando sugerencia:', error);
                    this.showSavingIndicator('‚ùå Error aplicando sugerencia', 'error');
                }
            }

            // === CARGA DE PLACAS DE FLOTA ===
            async loadFlotaPlacas() {
                try {
                    console.log('üöó Cargando placas de flota...');
                   
                    const response = await fetch(`${this.flotaApiUrl}?sheet=Flota`);
                    if (response.ok) {
                        const flotaData = await response.json();
                       
                        if (Array.isArray(flotaData)) {
                            this.placasFlota = flotaData
                                .filter(item => item.Placa && item.Placa.trim() !== '')
                                .map(item => item.Placa.trim().toUpperCase());
                           
                            console.log(`‚úÖ Cargadas ${this.placasFlota.length} placas de flota:`, this.placasFlota.slice(0, 5));
                        }
                    } else {
                        console.warn('‚ö†Ô∏è No se pudo cargar la hoja Flota');
                        this.placasFlota = [];
                    }
                } catch (error) {
                    console.error('‚ùå Error cargando placas de flota:', error);
                    this.placasFlota = [];
                }
            }

            // === DETECCI√ìN MEJORADA DE PLACAS CON VERIFICACI√ìN DE FLOTA ===
            detectPlacasInText(text) {
                if (!text) return [];
               
                const normalizedText = text.toUpperCase();
                const placasEncontradas = [];
               
                console.log(`üîç ANALIZANDO TEXTO: "${text}"`);
                console.log(`üîç TEXTO NORMALIZADO: "${normalizedText}"`);
               
                // Patrones espec√≠ficos y mejorados para todos los casos
                const placaPatterns = [
                    // === PATRONES ESPEC√çFICOS PARA CASOS PROBLEM√ÅTICOS ===
                   
                    // 1. BMV462 (texto simple)
                    {
                        pattern: /\b([A-Z]{3}\d{3})\b/g,
                        name: "Patr√≥n simple BMV462",
                        test: "BMV462"
                    },
                   
                    // 2. BRS_645_-88616144 (con guiones bajos Y gui√≥n)
                    {
                        pattern: /\b([A-Z]{3})[_\s]*(\d{3})[_\s]*(?=\-)/g,
                        name: "Patr√≥n BRS_645_-",
                        test: "BRS_645_-88616144",
                        combineGroups: true
                    },
                   
                    // 3. ABH301-88616144 (letras+n√∫meros seguido de gui√≥n)
                    {
                        pattern: /\b([A-Z]{3}\d{3})(?=\-\d)/g,
                        name: "Patr√≥n ABH301-n√∫meros",
                        test: "ABH301-88616144"
                    },
                   
                    // === PATRONES ESPEC√çFICOS PARA SINPE MOVIL ===
                    {
                        pattern: /SINPE\s+MOVIL\s+([A-Z]{3})[_\s]*(\d{3})/gi,
                        name: "SINPE MOVIL separado",
                        test: "SINPE MOVIL BRS_645",
                        combineGroups: true
                    },
                   
                    {
                        pattern: /SINPE\s+MOVIL\s+([A-Z]{3}\d{3})/gi,
                        name: "SINPE MOVIL junto",
                        test: "SINPE MOVIL ABH301"
                    },
                   
                    {
                        pattern: /SINPE\s+MOVIL\s+([A-Z]{2})[_\s]*(\d{4})/gi,
                        name: "SINPE MOVIL 2+4",
                        test: "SINPE MOVIL AA1234",
                        combineGroups: true
                    },
                   
                    // === PATRONES GENERALES MEJORADOS ===
                    {
                        pattern: /([A-Z]{3})[_\-\s]*(\d{3})(?![A-Z0-9])/g,
                        name: "3 letras + 3 n√∫meros con separadores",
                        test: "ABC_123, ABC-123, ABC123",
                        combineGroups: true
                    },
                   
                    {
                        pattern: /([A-Z]{2})[_\-\s]*(\d{4})(?![A-Z0-9])/g,
                        name: "2 letras + 4 n√∫meros con separadores",
                        test: "AB_1234, AB-1234, AB1234",
                        combineGroups: true
                    },
                   
                    {
                        pattern: /([A-Z]{3}\d{3})(?![A-Z0-9])/g,
                        name: "3 letras + 3 n√∫meros simple",
                        test: "ABC123"
                    },
                   
                    {
                        pattern: /([A-Z]{2}\d{4})(?![A-Z0-9])/g,
                        name: "2 letras + 4 n√∫meros simple",
                        test: "AB1234"
                    },
                   
                    // === PATRONES ADICIONALES ===
                    {
                        pattern: /(\d{3})[_\-\s]*([A-Z]{3})(?![A-Z0-9])/g,
                        name: "3 n√∫meros + 3 letras",
                        test: "123ABC",
                        combineGroups: true
                    },
                   
                    {
                        pattern: /(\d{4})[_\-\s]*([A-Z]{2})(?![A-Z0-9])/g,
                        name: "4 n√∫meros + 2 letras",
                        test: "1234AB",
                        combineGroups: true
                    },
                   
                    {
                        pattern: /([A-Z]{1}\d{6})(?![A-Z0-9])/g,
                        name: "Formato especial V046164",
                        test: "V046164"
                    }
                ];
               
                // Buscar todas las placas posibles con debug detallado
                const placasCandidatas = new Set();
               
                for (const patternObj of placaPatterns) {
                    try {
                        // Usar matchAll de forma segura
                        const matches = [...normalizedText.matchAll(patternObj.pattern)];
                       
                        if (matches.length > 0) {
                            console.log(`‚úÖ ${patternObj.name} encontr√≥ ${matches.length} coincidencias`);
                           
                            matches.forEach((match, index) => {
                                let cleanMatch = '';
                               
                                // Para patrones que capturan grupos separados (letras y n√∫meros por separado)
                                if (patternObj.combineGroups && match.length > 2 && match[1] && match[2]) {
                                    cleanMatch = (match[1] + match[2]).replace(/[_\-\s]+/g, '');
                                    console.log(`  üìã Match ${index + 1}: "${match[0]}" ‚Üí Grupos: "${match[1]}" + "${match[2]}" ‚Üí "${cleanMatch}"`);
                                }
                                // Para patrones que capturan todo junto
                                else if (match[1]) {
                                    cleanMatch = match[1].replace(/[_\-\s]+/g, '');
                                    console.log(`  üìã Match ${index + 1}: "${match[0]}" ‚Üí Grupo: "${match[1]}" ‚Üí "${cleanMatch}"`);
                                }
                                // Fallback al match completo
                                else {
                                    cleanMatch = match[0].replace(/[_\-\s]+/g, '');
                                    console.log(`  üìã Match ${index + 1}: "${match[0]}" ‚Üí Completo ‚Üí "${cleanMatch}"`);
                                }
                               
                                // Limpiar cualquier texto extra que no sea parte de la placa
                                cleanMatch = cleanMatch.replace(/^(SINPE|MOVIL|TEF)\s*/gi, '');
                               
                                // Validaciones m√°s estrictas para evitar falsos positivos
                                if (cleanMatch.length >= 5 && cleanMatch.length <= 7) {
                                    // Verificar que tenga al menos una letra y un n√∫mero
                                    const hasLetter = /[A-Z]/.test(cleanMatch);
                                    const hasNumber = /\d/.test(cleanMatch);
                                   
                                    if (hasLetter && hasNumber) {
                                        console.log(`    ‚úÖ PLACA V√ÅLIDA: "${cleanMatch}"`);
                                        placasCandidatas.add(cleanMatch);
                                    } else {
                                        console.log(`    ‚ùå Inv√°lida (sin letra o n√∫mero): "${cleanMatch}"`);
                                    }
                                } else {
                                    console.log(`    ‚ùå Longitud inv√°lida (${cleanMatch.length}): "${cleanMatch}"`);
                                }
                            });
                        } else {
                            console.log(`‚ùå ${patternObj.name} - sin coincidencias`);
                        }
                    } catch (error) {
                        // Fallback: usar match normal si matchAll falla
                        console.warn('‚ö†Ô∏è Error con matchAll, usando match normal:', error);
                        const match = normalizedText.match(patternObj.pattern);
                        if (match && match[1]) {
                            const cleanMatch = match[1].replace(/[_\-\s]+/g, '');
                            if (cleanMatch.length >= 5 && cleanMatch.length <= 7) {
                                const hasLetter = /[A-Z]/.test(cleanMatch);
                                const hasNumber = /\d/.test(cleanMatch);
                                if (hasLetter && hasNumber) {
                                    placasCandidatas.add(cleanMatch);
                                }
                            }
                        }
                    }
                }
               
                console.log(`üéØ CANDIDATAS FINALES:`, Array.from(placasCandidatas));
               
                // Verificar cada placa candidata contra la flota
                placasCandidatas.forEach(placa => {
                    const verificacion = this.verificarPlacaEnFlota(placa);
                    if (verificacion.encontrada) {
                        console.log(`‚úÖ PLACA EN FLOTA: ${placa} (${verificacion.tipo})`);
                        placasEncontradas.push({
                            placa: placa,
                            placaFlota: verificacion.placaFlota,
                            tipoCoincidencia: verificacion.tipo,
                            confianza: verificacion.confianza
                        });
                    } else {
                        console.log(`üîç PLACA NO EN FLOTA: ${placa} - agregando como detectada`);
                    }
                });
               
                // Si no encontramos placas verificadas, agregar las candidatas
                if (placasEncontradas.length === 0 && placasCandidatas.size > 0) {
                    placasCandidatas.forEach(placa => {
                        // Solo agregar placas que sigan patrones t√≠picos costarricenses
                        const esFormatoValido =
                            /^[A-Z]{3}\d{3}$/.test(placa) ||     // ABC123
                            /^[A-Z]{2}\d{4}$/.test(placa) ||     // AB1234
                            /^\d{3}[A-Z]{3}$/.test(placa) ||     // 123ABC
                            /^\d{4}[A-Z]{2}$/.test(placa) ||     // 1234AB
                            /^[A-Z]{1}\d{6}$/.test(placa);       // V046164
                       
                        if (esFormatoValido) {
                            console.log(`üìù AGREGANDO COMO DETECTADA: ${placa}`);
                            placasEncontradas.push({
                                placa: placa,
                                placaFlota: placa,
                                tipoCoincidencia: 'detectada',
                                confianza: 0.7
                            });
                        }
                    });
                }
               
                console.log(`üèÅ RESULTADO FINAL para "${text}":`, placasEncontradas);
               
                return placasEncontradas;
            }

            // === VERIFICACI√ìN INTELIGENTE CONTRA API DE FLOTA ===
            verificarPlacaEnFlota(placaTexto) {
                if (!placaTexto || this.placasFlota.length === 0) {
                    return { encontrada: false };
                }
               
                const placaLimpia = placaTexto.replace(/\s+/g, '').toUpperCase();
               
                // 1. Buscar coincidencia exacta
                for (const placaFlota of this.placasFlota) {
                    if (placaLimpia === placaFlota) {
                        return {
                            encontrada: true,
                            placaFlota: placaFlota,
                            tipo: 'exacta',
                            confianza: 1.0
                        };
                    }
                }
               
                // 2. Buscar coincidencia parcial (placa texto contenida en placa flota)
                for (const placaFlota of this.placasFlota) {
                    if (placaFlota.includes(placaLimpia) || placaLimpia.includes(placaFlota)) {
                        return {
                            encontrada: true,
                            placaFlota: placaFlota,
                            tipo: 'parcial',
                            confianza: 0.8
                        };
                    }
                }
               
                // 3. Buscar similitud por formato (mismas letras/n√∫meros en diferente orden)
                for (const placaFlota of this.placasFlota) {
                    const similitud = this.calcularSimilitudPlaca(placaLimpia, placaFlota);
                    if (similitud >= 0.7) {
                        return {
                            encontrada: true,
                            placaFlota: placaFlota,
                            tipo: 'formato',
                            confianza: similitud
                        };
                    }
                }
               
                return { encontrada: false };
            }

            // === C√ÅLCULO DE SIMILITUD ENTRE PLACAS ===
            calcularSimilitudPlaca(placa1, placa2) {
                if (!placa1 || !placa2) return 0;
               
                // Extraer letras y n√∫meros por separado
                const letras1 = placa1.match(/[A-Z]/g) || [];
                const numeros1 = placa1.match(/\d/g) || [];
                const letras2 = placa2.match(/[A-Z]/g) || [];
                const numeros2 = placa2.match(/\d/g) || [];
               
                // Calcular similitud de letras
                let letrasComunes = 0;
                letras1.forEach(letra => {
                    if (letras2.includes(letra)) {
                        letrasComunes++;
                    }
                });
               
                // Calcular similitud de n√∫meros
                let numerosComunes = 0;
                numeros1.forEach(numero => {
                    if (numeros2.includes(numero)) {
                        numerosComunes++;
                    }
                });
               
                const totalLetras = Math.max(letras1.length, letras2.length);
                const totalNumeros = Math.max(numeros1.length, numeros2.length);
               
                if (totalLetras === 0 && totalNumeros === 0) return 0;
               
                const similitudLetras = totalLetras > 0 ? letrasComunes / totalLetras : 0;
                const similitudNumeros = totalNumeros > 0 ? numerosComunes / totalNumeros : 0;
               
                return (similitudLetras + similitudNumeros) / 2;
            }

            // === FUNCI√ìN LEGACY ACTUALIZADA ===
            detectPlacaInText(text) {
                const placas = this.detectPlacasInText(text);
                // Retornar la placa con mayor confianza para compatibilidad
                if (placas.length > 0) {
                    const mejorPlaca = placas.sort((a, b) => b.confianza - a.confianza)[0];
                    return mejorPlaca.placa;
                }
                return null;
            }

            // === ACTUALIZACI√ìN DE DASHBOARD DE ESTAD√çSTICAS ===
            updateStatsDashboard() {
                console.log('üìä Actualizando dashboard de estad√≠sticas...');
               
                try {
                    // Calcular estad√≠sticas (solo transacciones desde 10/07/2025 sin observaciones)
                    const totalPending = this.unconciledTransactions.length;
                    const totalTransactions = this.allTransactions.length;
                    const pendingPercentage = totalTransactions > 0 ? Math.round((totalPending / totalTransactions) * 100) : 0;
                   
                    // Contar por banco (solo transacciones sin observaciones desde 10/07/2025)
                    const bankCounts = {
                        BAC: this.unconciledTransactions.filter(t => t.banco === 'BAC').length,
                        BN: this.unconciledTransactions.filter(t => t.banco === 'BN').length,
                        HuberBN: this.unconciledTransactions.filter(t => t.banco === 'HuberBN').length,
                        AutosubastasBAC: this.unconciledTransactions.filter(t => t.banco === 'AutosubastasBAC').length,
                        AutosubastasBN: this.unconciledTransactions.filter(t => t.banco === 'AutosubastasBN').length
                    };

                    // Encontrar transacci√≥n m√°s antigua
                    let oldestTransaction = null;
                    let oldestDays = 0;
                   
                    if (this.unconciledTransactions.length > 0) {
                        const today = new Date();
                       
                        for (const tx of this.unconciledTransactions) {
                            const txDate = this.parseTransactionDate(tx.Fecha);
                            if (txDate) {
                                const daysDiff = Math.floor((today - txDate) / (1000 * 60 * 60 * 24));
                                if (daysDiff > oldestDays) {
                                    oldestDays = daysDiff;
                                    oldestTransaction = tx;
                                }
                            }
                        }
                    }

                    // Actualizar elementos del DOM
                    if (this.pendingCount) this.pendingCount.textContent = totalPending;
                   
                    if (this.pendingPercentage) this.pendingPercentage.textContent = `${pendingPercentage}%`;
                   
                    if (this.bacCount) this.bacCount.textContent = bankCounts.BAC;
                    if (this.bnCount) this.bnCount.textContent = bankCounts.BN;
                    if (this.huberCount) this.huberCount.textContent = bankCounts.HuberBN;
                    if (this.autoBacCount) this.autoBacCount.textContent = bankCounts.AutosubastasBAC;
                    if (this.autoBnCount) this.autoBnCount.textContent = bankCounts.AutosubastasBN;

                    // Actualizar transacci√≥n m√°s antigua
                    if (oldestTransaction && this.oldestDays) {
                        this.oldestDays.textContent = oldestDays;
                        this.oldestDate.textContent = oldestTransaction.Fecha || '--/--/----';
                        this.oldestRef.textContent = `Ref: ${oldestTransaction.Referencia}`;
                        this.oldestAmount.textContent = this.formatAmount(oldestTransaction.Cr√©ditos);
                        this.oldestDaysLabel.textContent = `${oldestDays} d√≠as sin conciliar`;
                       
                        if (this.oldestTransaction) {
                            this.oldestTransaction.style.display = 'block';
                        }
                    } else if (this.oldestDays) {
                        this.oldestDays.textContent = '0';
                        this.oldestDate.textContent = '--/--/----';
                        if (this.oldestTransaction) {
                            this.oldestTransaction.style.display = 'none';
                        }
                    }

                    // Mostrar dashboard
                    if (this.statsDashboard) {
                        this.statsDashboard.style.display = 'grid';
                    }

                    console.log(`üìä Dashboard actualizado: ${totalPending} pendientes (${pendingPercentage}%), m√°s antigua: ${oldestDays} d√≠as`);
                   
                } catch (error) {
                    console.error('‚ùå Error actualizando dashboard:', error);
                }
            }

            // === FUNCI√ìN PARA REFRESCAR LA VISTA ACTUAL ===
            refreshCurrentView() {
                console.log('üîÑ Refrescando vista para mostrar sugerencias IA...');
               
                const currentQuery = this.searchInput.value.trim();
               
                // Si hay una b√∫squeda activa o filtros aplicados, recargar esa vista
                if (currentQuery || this.dateFilterActive || this.observationsFilter !== 'all') {
                    console.log('üîÑ Refrescando b√∫squeda/filtros actuales...');
                    this.performSearch(currentQuery);
                }
                // Si est√° mostrando transacciones sin observaciones (vista por defecto)
                else if (this.observationsFilter === 'without') {
                    console.log('üîÑ Refrescando vista de transacciones sin observaciones...');
                    this.performObservationsFilterOnly();
                }
                // Si no hay filtros, pero hay transacciones cargadas
                else if (this.allTransactions.length > 0) {
                    console.log('üîÑ Refrescando a vista por defecto con sugerencias...');
                    // Forzar mostrar transacciones sin observaciones para ver las sugerencias
                    this.observationsFilter = 'without';
                    this.updateObservationsFilterUI();
                    this.performObservationsFilterOnly();
                }
               
                console.log(`‚úÖ Vista refrescada. ${this.aiSuggestions.size} sugerencias disponibles.`);
            }

            // === ACTUALIZACI√ìN INMEDIATA DEL DASHBOARD CON CALLBACK ===
            updateAISuggestionsDashboard() {
                const suggestionsCount = this.aiSuggestions.size;
               
                if (suggestionsCount > 0 && this.aiSuggestionsInfo) {
                    this.suggestionsCount.textContent = suggestionsCount;
                    this.aiSuggestionsInfo.style.display = 'block';
                   
                    // Actualizar inmediatamente despu√©s de mostrar el contador
                    setTimeout(() => {
                        console.log(`üìä Dashboard actualizado: ${suggestionsCount} sugerencias IA visibles`);
                    }, 100);
                } else if (this.aiSuggestionsInfo) {
                    this.aiSuggestionsInfo.style.display = 'none';
                }
            }

            initializeElements() {
                this.searchInput = document.getElementById('searchInput');
                this.loadingIndicator = document.getElementById('loadingIndicator');
                this.errorMessage = document.getElementById('errorMessage');
                this.resultsInfo = document.getElementById('resultsInfo');
                this.resultsContainer = document.getElementById('resultsContainer');
                this.tableContainer = document.getElementById('tableContainer');
                this.noResults = document.getElementById('noResults');
                this.initialState = document.getElementById('initialState');
                this.filterButtons = document.querySelectorAll('.filter-btn');
                this.bankButtons = document.querySelectorAll('.bank-btn');
                this.savingIndicator = document.getElementById('savingIndicator');
               
                // ELEMENTOS DEL FILTRO DE FECHA
                this.dateFilterSection = document.getElementById('dateFilterSection');
                this.dateFromInput = document.getElementById('dateFrom');
                this.dateToInput = document.getElementById('dateTo');
                this.applyDateFilterBtn = document.getElementById('applyDateFilter');
                this.clearDateFilterBtn = document.getElementById('clearDateFilter');
                this.dateFilterStatus = document.getElementById('dateFilterStatus');
                this.dateRangeText = document.getElementById('dateRangeText');
               
                // ELEMENTOS DEL FILTRO DE OBSERVACIONES
                this.observationsFilterBtn = document.getElementById('observationsFilter');
               
                // === ELEMENTOS DE IA ===
                this.aiAnalysisPanel = document.getElementById('aiAnalysisPanel');
                this.aiStatus = document.getElementById('aiStatus');
                this.aiProgressBar = document.getElementById('aiProgressBar');
                this.aiSuggestionsList = document.getElementById('aiSuggestionsList');
               
                // === ELEMENTOS DE DASHBOARD DE ESTAD√çSTICAS ===
                this.statsDashboard = document.getElementById('statsDashboard');
                this.pendingCount = document.getElementById('pendingCount');
                this.pendingDescription = document.getElementById('pendingDescription');
                this.pendingPercentage = document.getElementById('pendingPercentage');
                this.bacCount = document.getElementById('bacCount');
                this.bnCount = document.getElementById('bnCount');
                this.huberCount = document.getElementById('huberCount');
                this.autoBacCount = document.getElementById('autoBacCount');
                this.autoBnCount = document.getElementById('autoBnCount');
                this.aiSuggestionsInfo = document.getElementById('aiSuggestionsInfo');
                this.suggestionsCount = document.getElementById('suggestionsCount');
                this.oldestDays = document.getElementById('oldestDays');
                this.oldestDate = document.getElementById('oldestDate');
                this.oldestTransaction = document.getElementById('oldestTransaction');
                this.oldestRef = document.getElementById('oldestRef');
                this.oldestAmount = document.getElementById('oldestAmount');
                this.oldestDaysLabel = document.getElementById('oldestDaysLabel');
               
                // === ELEMENTOS DE WHATSAPP ===
                this.whatsappNotification = document.getElementById('whatsappNotification');
                this.whatsappNotificationText = document.getElementById('whatsappNotificationText');
               
                console.log('‚úÖ Elementos inicializados correctamente');
            }

            bindEvents() {
                this.searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    this.handleSearch(query);
                });

                this.filterButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        if (btn.id === 'observationsFilter') {
                            this.toggleObservationsFilter();
                        } else {
                            this.handleFilterChange(e.target.dataset.filter);
                        }
                    });
                });

                this.bankButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.handleBankChange(e.target.dataset.bank);
                    });
                });

                // EVENTOS PARA FILTRO DE FECHA
                this.applyDateFilterBtn.addEventListener('click', () => {
                    this.applyDateFilter();
                });

                this.clearDateFilterBtn.addEventListener('click', () => {
                    this.clearDateFilter();
                });

                this.dateFromInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        this.applyDateFilter();
                    }
                });

                this.dateToInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        this.applyDateFilter();
                    }
                });

                // Cerrar panel de sugerencias al hacer clic fuera
                document.addEventListener('click', (e) => {
                    if (this.activeObservationsEditor && !this.activeObservationsEditor.contains(e.target)) {
                        this.closeObservationsEditor();
                    }
                });

                // Cerrar editores y paneles con ESC
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeObservationsEditor();
                        this.closeSuggestionPanel();
                    }
                });

                // === EVENTOS DE DASHBOARD ===
                this.addDashboardListeners();

                // === EVENTOS DE ORDENAMIENTO ===
                this.addSortingListeners();

                console.log('‚úÖ Eventos configurados correctamente');
            }

            // === SISTEMA DE INTELIGENCIA ARTIFICIAL ===
            async startAIAnalysis() {
                if (this.isAnalyzing || this.allTransactions.length === 0) {
                    return;
                }

                console.log('üß† Iniciando an√°lisis de IA...');
                this.isAnalyzing = true;
                this.analysisProgress = 0;
               
                // Mostrar panel de an√°lisis
                this.aiAnalysisPanel.classList.add('show');
                this.updateAIStatus('Clasificando transacciones...');
                this.updateAIProgress(10);

                try {
                    // 1. Clasificar transacciones
                    await this.classifyTransactions();
                    this.updateAIProgress(30);

                    if (this.unconciledTransactions.length === 0) {
                        this.updateAIStatus('‚úÖ No hay transacciones sin conciliar desde 10/07/2025');
                        this.updateAIProgress(100);
                        setTimeout(() => this.aiAnalysisPanel.classList.remove('show'), 3000);
                        return;
                    }

                    this.updateAIStatus(`Analizando ${this.unconciledTransactions.length} transacciones sin conciliar...`);
                    this.updateAIProgress(50);

                    // 2. Analizar similitudes
                    await this.analyzeTransactionSimilarities();
                    this.updateAIProgress(80);

                    // 3. Mostrar resumen
                    this.showAISummary();
                    this.updateAIProgress(100);

                    setTimeout(() => {
                        this.aiAnalysisPanel.classList.remove('show');
                        this.showSavingIndicator('üß† An√°lisis IA completado - Sugerencias disponibles', 'success');
                       
                        // IMPORTANTE: Refrescar la vista actual para mostrar las sugerencias
                        this.refreshCurrentView();
                    }, 2000); // Reducido de 5000 a 2000ms

                } catch (error) {
                    console.error('‚ùå Error en an√°lisis de IA:', error);
                    this.updateAIStatus('‚ùå Error en el an√°lisis');
                } finally {
                    this.isAnalyzing = false;
                }
            }

            async classifyTransactions() {
                // Simular tiempo de procesamiento
                await new Promise(resolve => setTimeout(resolve, 500));

                this.conciliatedTransactions = [];
                this.unconciledTransactions = [];

                for (const transaction of this.allTransactions) {
                    const transactionDate = this.parseTransactionDate(transaction.Fecha);
                   
                    if (transaction.Observaciones && transaction.Observaciones.trim() !== '') {
                        // Transacci√≥n conciliada (tiene observaciones)
                        this.conciliatedTransactions.push(transaction);
                    } else if (transactionDate && transactionDate >= this.cutoffDate) {
                        // Transacci√≥n sin conciliar desde 10/07/2025
                        this.unconciledTransactions.push(transaction);
                    }
                }

                console.log(`üìä Clasificaci√≥n completada:`);
                console.log(`   ‚Ä¢ ${this.conciliatedTransactions.length} transacciones conciliadas`);
                console.log(`   ‚Ä¢ ${this.unconciledTransactions.length} transacciones sin conciliar desde 10/07/2025`);

                // Actualizar dashboard de estad√≠sticas
                this.updateStatsDashboard();
               
                // IMPORTANTE: Mostrar inmediatamente las transacciones pendientes si hay
                if (this.unconciledTransactions.length > 0) {
                    console.log('üìù Mostrando autom√°ticamente transacciones pendientes...');
                    setTimeout(() => {
                        // Asegurar que el filtro est√© en "without" y mostrar resultados
                        if (this.observationsFilter !== 'without') {
                            this.observationsFilter = 'without';
                            this.updateObservationsFilterUI();
                        }
                        this.performObservationsFilterOnly();
                    }, 300);
                }
            }

            async analyzeTransactionSimilarities() {
                let suggestionsFound = 0;
                const totalToAnalyze = this.unconciledTransactions.length;

                console.log(`üß† Analizando ${totalToAnalyze} transacciones sin conciliar...`);
                console.log(`üìä Comparando contra ${this.conciliatedTransactions.length} transacciones conciliadas...`);

                for (let i = 0; i < this.unconciledTransactions.length; i++) {
                    const uncomciledTx = this.unconciledTransactions[i];
                   
                    // Simular tiempo de procesamiento
                    if (i % 5 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        this.updateAIStatus(`Analizando ${i + 1}/${totalToAnalyze} transacciones...`);
                        this.updateAIProgress(50 + ((i / totalToAnalyze) * 30));
                    }

                    const suggestions = this.findSimilarTransactions(uncomciledTx);
                   
                    if (suggestions.length > 0) {
                        const confidence = this.calculateConfidence(suggestions[0]);
                       
                        this.aiSuggestions.set(uncomciledTx.Referencia, {
                            transaction: uncomciledTx,
                            suggestions: suggestions,
                            confidence: confidence
                        });
                       
                        suggestionsFound++;
                       
                        console.log(`üí° Sugerencia #${suggestionsFound}: ${uncomciledTx.Referencia} -> "${suggestions[0].suggestedObservation}" (${confidence}%)`);
                       
                        // Refrescar vista cada 5 sugerencias para feedback inmediato
                        if (suggestionsFound % 5 === 0) {
                            console.log(`üîÑ Refrescando vista... ${suggestionsFound} sugerencias generadas hasta ahora`);
                            setTimeout(() => {
                                this.refreshCurrentView();
                            }, 50);
                        }
                    }
                }

                console.log(`üß† An√°lisis completado: ${suggestionsFound} sugerencias generadas de ${totalToAnalyze} transacciones`);
                console.log(`üìã Mapa de sugerencias:`, Array.from(this.aiSuggestions.keys()));

                // Actualizar dashboard con sugerencias de IA
                this.updateAISuggestionsDashboard();
               
                // IMPORTANTE: Refrescar vista progresivamente mientras se generan sugerencias
                if (suggestionsFound > 0) {
                    console.log('üîÑ Refrescando vista para mostrar sugerencias generadas...');
                    setTimeout(() => {
                        this.refreshCurrentView();
                    }, 200);
                }
            }

            findSimilarTransactions(unconciledTransaction) {
                const suggestions = [];
                const unconciledDesc = (unconciledTransaction.Descripci√≥n || '').trim();
                const unconciledAmount = this.parseAmount(unconciledTransaction.Cr√©ditos || '0');
               
                console.log(`üîç Buscando similitudes para: "${unconciledDesc}" (${this.formatAmount(unconciledTransaction.Cr√©ditos)})`);
               
                if (!unconciledDesc) {
                    console.log('‚ö†Ô∏è Sin descripci√≥n, no se pueden generar sugerencias');
                    return [];
                }

                // === FILTRO DE DESCRIPCIONES GEN√âRICAS ===
                if (this.isGenericDescription(unconciledDesc)) {
                    console.log('‚ö†Ô∏è Descripci√≥n demasiado gen√©rica, no se generan sugerencias');
                    return [];
                }

                for (const conciliatedTx of this.conciliatedTransactions) {
                    const conciliatedDesc = (conciliatedTx.Descripci√≥n || '').trim();
                    const conciliatedAmount = this.parseAmount(conciliatedTx.Cr√©ditos || '0');
                   
                    if (!conciliatedDesc || !conciliatedTx.Observaciones || conciliatedTx.Observaciones.trim() === '') {
                        continue; // Solo considerar transacciones con descripci√≥n y observaciones
                    }

                    // Tambi√©n filtrar transacciones conciliadas gen√©ricas
                    if (this.isGenericDescription(conciliatedDesc)) {
                        continue;
                    }

                    let totalSimilarity = 0;
                    let matchFactors = [];
                    let hasUniqueIdentifier = false; // Flag para verificar si hay identificadores √∫nicos

                    // === 1. DETECCI√ìN DE NOMBRES DE PERSONAS (FACTOR PRINCIPAL) ===
                    let nameSimilarity = 0;
                    const unconciledNames = this.extractPersonNames(unconciledDesc);
                    const conciliatedNames = this.extractPersonNames(conciliatedDesc);
                   
                    // Comparar nombres encontrados
                    for (const unconciledName of unconciledNames) {
                        for (const conciliatedName of conciliatedNames) {
                            const similarity = this.calculateNameSimilarity(unconciledName, conciliatedName);
                           
                            if (similarity >= 0.9) { // 90% o m√°s de similitud
                                nameSimilarity = similarity;
                                matchFactors.push(`NOMBRE: ${unconciledName}`);
                                hasUniqueIdentifier = true;
                                break;
                            }
                        }
                        if (nameSimilarity >= 0.9) break;
                    }

                    // === 2. DETECCI√ìN MEJORADA DE PLACAS DE VEH√çCULOS ===
                    let placaSimilarity = 0;
                    let placaMatchInfo = null;
                    const unconciledPlacas = this.detectPlacasInText(unconciledDesc);
                    const conciliatedPlacas = this.detectPlacasInText(conciliatedDesc);
                   
                    console.log(`üöó Comparando placas:`);
                    console.log(`   Sin conciliar: ${JSON.stringify(unconciledPlacas)}`);
                    console.log(`   Conciliada: ${JSON.stringify(conciliatedPlacas)}`);
                   
                    // Comparar todas las placas encontradas
                    for (const unconciledPlacaInfo of unconciledPlacas) {
                        for (const conciliatedPlacaInfo of conciliatedPlacas) {
                            let similarity = 0;
                            let matchType = '';
                           
                            console.log(`üîç Comparando: "${unconciledPlacaInfo.placa}" vs "${conciliatedPlacaInfo.placa}"`);
                           
                            // Coincidencia exacta de placas
                            if (unconciledPlacaInfo.placa === conciliatedPlacaInfo.placa) {
                                similarity = 1.0;
                                matchType = `PLACA EXACTA: ${unconciledPlacaInfo.placa}`;
                               
                                // Bonus si ambas son de la flota verificada
                                if (unconciledPlacaInfo.tipoCoincidencia === 'exacta' &&
                                    conciliatedPlacaInfo.tipoCoincidencia === 'exacta') {
                                    matchType += ' (FLOTA VERIFICADA)';
                                    similarity = 1.0;
                                }
                                // Si ambas est√°n detectadas pero no verificadas
                                else if (unconciledPlacaInfo.tipoCoincidencia === 'detectada' &&
                                         conciliatedPlacaInfo.tipoCoincidencia === 'detectada') {
                                    matchType += ' (DETECTADA)';
                                    similarity = 0.95; // Alta confianza para coincidencia exacta
                                }
                                // Si una est√° verificada y otra detectada
                                else if ((unconciledPlacaInfo.tipoCoincidencia === 'exacta' && conciliatedPlacaInfo.tipoCoincidencia === 'detectada') ||
                                         (unconciledPlacaInfo.tipoCoincidencia === 'detectada' && conciliatedPlacaInfo.tipoCoincidencia === 'exacta')) {
                                    matchType += ' (MIXTA VERIFICADA-DETECTADA)';
                                    similarity = 0.98;
                                }
                               
                                console.log(`‚úÖ COINCIDENCIA EXACTA: ${matchType} (${similarity})`);
                            }
                            // Placas diferentes pero ambas verificadas en flota
                            else if (unconciledPlacaInfo.placaFlota === conciliatedPlacaInfo.placaFlota &&
                                     unconciledPlacaInfo.tipoCoincidencia !== 'detectada' &&
                                     conciliatedPlacaInfo.tipoCoincidencia !== 'detectada') {
                                similarity = 0.9;
                                matchType = `MISMA FLOTA: ${unconciledPlacaInfo.placaFlota}`;
                                console.log(`‚úÖ MISMA FLOTA: ${matchType} (${similarity})`);
                            }
                            // Similitud parcial (solo si no hay coincidencias exactas)
                            else {
                                const textSimilarity = this.calcularSimilitudPlaca(
                                    unconciledPlacaInfo.placa,
                                    conciliatedPlacaInfo.placa
                                );
                                if (textSimilarity >= 0.8) { // Aumentar umbral para ser m√°s estricto
                                    similarity = textSimilarity * 0.7; // Reducir peso de similitud parcial
                                    matchType = `PLACA SIMILAR: ${unconciledPlacaInfo.placa}‚Üî${conciliatedPlacaInfo.placa}`;
                                    console.log(`‚ö†Ô∏è SIMILITUD PARCIAL: ${matchType} (${similarity})`);
                                }
                            }
                           
                            // Solo considerar como identificador √∫nico si la similitud es alta
                            if (similarity >= 0.8) {
                                if (similarity > placaSimilarity) {
                                    placaSimilarity = similarity;
                                    placaMatchInfo = {
                                        matchType: matchType,
                                        unconciledPlaca: unconciledPlacaInfo,
                                        conciliatedPlaca: conciliatedPlacaInfo,
                                        similarity: similarity
                                    };
                                    hasUniqueIdentifier = true;
                                    console.log(`üéØ MEJOR MATCH DE PLACA ACTUALIZADO: ${matchType}`);
                                }
                            }
                        }
                    }
                   
                    if (placaMatchInfo) {
                        matchFactors.push(placaMatchInfo.matchType);
                        console.log(`üìù Factor de placa agregado: ${placaMatchInfo.matchType}`);
                    } else if (unconciledPlacas.length > 0 && conciliatedPlacas.length > 0) {
                        console.log(`‚ùå No se encontr√≥ match de placas v√°lido entre:`,
                                  unconciledPlacas.map(p => p.placa), 'vs', conciliatedPlacas.map(p => p.placa));
                    }

                    // === 3. DETECCI√ìN DE N√öMEROS DE REFERENCIA √öNICOS ===
                    let referenceSimilarity = 0;
                    const unconciledNumbers = this.extractUniqueNumbers(unconciledDesc);
                    const conciliatedNumbers = this.extractUniqueNumbers(conciliatedDesc);
                   
                    for (const unconciledNum of unconciledNumbers) {
                        for (const conciliatedNum of conciliatedNumbers) {
                            if (unconciledNum === conciliatedNum && unconciledNum.length >= 4) {
                                referenceSimilarity = 1.0;
                                matchFactors.push(`N√öMERO √öNICO: ${unconciledNum}`);
                                hasUniqueIdentifier = true;
                                break;
                            }
                        }
                        if (referenceSimilarity === 1.0) break;
                    }

                    // === 4. DETECCI√ìN DE C√ìDIGOS O IDENTIFICADORES ESPEC√çFICOS ===
                    let codeSimilarity = 0;
                    const unconciledCodes = this.extractSpecificCodes(unconciledDesc);
                    const conciliatedCodes = this.extractSpecificCodes(conciliatedDesc);
                   
                    for (const unconciledCode of unconciledCodes) {
                        for (const conciliatedCode of conciliatedCodes) {
                            if (unconciledCode === conciliatedCode) {
                                codeSimilarity = 1.0;
                                matchFactors.push(`C√ìDIGO: ${unconciledCode}`);
                                hasUniqueIdentifier = true;
                                break;
                            }
                        }
                        if (codeSimilarity === 1.0) break;
                    }

                    // === CRITERIO DE EXCLUSI√ìN: SOLO GENERAR SUGERENCIAS SI HAY IDENTIFICADORES √öNICOS ===
                    if (!hasUniqueIdentifier) {
                        continue; // Saltar si no hay identificadores √∫nicos
                    }

                    // === C√ÅLCULO DE SIMILITUD TOTAL (solo con factores √∫nicos) ===
                    totalSimilarity =
                        (nameSimilarity * 0.50) +          // 50% nombres de personas
                        (placaSimilarity * 0.25) +         // 25% placas
                        (referenceSimilarity * 0.15) +     // 15% n√∫meros √∫nicos
                        (codeSimilarity * 0.10);           // 10% c√≥digos espec√≠ficos

                    // === CRITERIOS DE INCLUSI√ìN M√ÅS ESTRICTOS ===
                    if (totalSimilarity >= 0.50 || nameSimilarity >= 0.9 || placaSimilarity >= 0.8) {
                       
                        console.log(`‚úÖ SUGERENCIA CALIFICADA:`);
                        console.log(`   Similitud total: ${Math.round(totalSimilarity * 100)}%`);
                        console.log(`   Similitud nombres: ${Math.round(nameSimilarity * 100)}%`);
                        console.log(`   Similitud placas: ${Math.round(placaSimilarity * 100)}%`);
                        console.log(`   Factores √∫nicos: [${matchFactors.join(', ')}]`);
                        console.log(`   Sugerencia: "${conciliatedTx.Observaciones}"`);
                       
                        suggestions.push({
                            conciliatedTransaction: conciliatedTx,
                            totalSimilarity: totalSimilarity,
                            nameSimilarity: nameSimilarity,
                            placaSimilarity: placaSimilarity,
                            referenceSimilarity: referenceSimilarity,
                            codeSimilarity: codeSimilarity,
                            matchFactors: matchFactors,
                            suggestedObservation: conciliatedTx.Observaciones,
                            // Informaci√≥n para debug
                            unconciledPlacas: unconciledPlacas,
                            conciliatedPlacas: conciliatedPlacas,
                            placaMatchInfo: placaMatchInfo,
                            unconciledNames: unconciledNames,
                            conciliatedNames: conciliatedNames,
                            unconciledNumbers: unconciledNumbers,
                            conciliatedNumbers: conciliatedNumbers
                        });
                    } else {
                        console.log(`‚ùå SUGERENCIA NO CALIFICA:`);
                        console.log(`   Similitud total: ${Math.round(totalSimilarity * 100)}% (min: 50%)`);
                        console.log(`   Similitud nombres: ${Math.round(nameSimilarity * 100)}% (min: 90%)`);
                        console.log(`   Similitud placas: ${Math.round(placaSimilarity * 100)}% (min: 80%)`);
                        console.log(`   Factores √∫nicos: [${matchFactors.join(', ')}]`);
                        console.log(`   Sugerencia habr√≠a sido: "${conciliatedTx.Observaciones}"`);
                    }
                }

                // Ordenar por similitud total (mayor a menor) y tomar las mejores 3
                const sortedSuggestions = suggestions
                    .sort((a, b) => b.totalSimilarity - a.totalSimilarity)
                    .slice(0, 3);

                if (sortedSuggestions.length > 0) {
                    const best = sortedSuggestions[0];
                    console.log(`üéâ SUGERENCIAS FINALES PARA "${unconciledDesc}":`);
                    console.log(`  ‚úÖ ${sortedSuggestions.length} sugerencias encontradas (con identificadores √∫nicos).`);
                    console.log(`  ü•á Mejor: "${best.suggestedObservation}" (${Math.round(best.totalSimilarity * 100)}%)`);
                    console.log(`  üîç Factores √∫nicos: ${best.matchFactors.join(', ')}`);
                   
                    // Verificaci√≥n adicional para asegurar coherencia
                    if (best.placaSimilarity >= 0.8) {
                        console.log(`  üöó MATCH DE PLACA CONFIRMADO: ${best.placaMatchInfo?.matchType}`);
                        console.log(`  üìã Ref transacci√≥n origen: ${best.conciliatedTransaction.Referencia}`);
                        console.log(`  üìÑ Descripci√≥n origen: "${best.conciliatedTransaction.Descripci√≥n}"`);
                    }
                } else {
                    console.log(`‚ùå No se encontraron sugerencias con identificadores √∫nicos v√°lidos para "${unconciledDesc}"`);
                }

                return sortedSuggestions;
            }

            // === NUEVA FUNCI√ìN: FILTRO DE DESCRIPCIONES GEN√âRICAS ===
            isGenericDescription(description) {
                if (!description || description.trim().length < 5) {
                    return true; // Descripciones muy cortas son gen√©ricas
                }

                const genericWords = [
                    // Palabras relacionadas con transferencias
                    'sinpe', 'tef', 'transferencia', 'pago', 'deposito', 'retiro',
                    'movil', 'm√≥vil', 'envio', 'env√≠o', 'recibo',
                   
                    // Palabras relacionadas con veh√≠culos gen√©ricas
                    'carro', 'auto', 'vehiculo', 'veh√≠culo', 'moto', 'motocicleta',
                    'camion', 'cami√≥n', 'pick', 'pickup',
                   
                    // Palabras de servicios gen√©ricos
                    'servicio', 'compra', 'venta', 'cuota', 'abono', 'cancelacion',
                    'cancelaci√≥n', 'factura', 'recibo', 'comision', 'comisi√≥n',
                   
                    // Palabras bancarias gen√©ricas
                    'banco', 'cuenta', 'tarjeta', 'efectivo', 'cheque',
                    'credito', 'cr√©dito', 'debito', 'd√©bito',
                   
                    // Palabras muy comunes
                    'cliente', 'persona', 'usuario', 'particular',
                    'general', 'varios', 'otros', 'diversos'
                ];

                const normalizedDesc = description.toLowerCase().trim();
               
                // Remover palabras gen√©ricas y ver qu√© queda
                let cleanedDesc = normalizedDesc;
               
                for (const genericWord of genericWords) {
                    // Remover la palabra gen√©rica completa
                    const regex = new RegExp(`\\b${genericWord}\\b`, 'gi');
                    cleanedDesc = cleanedDesc.replace(regex, ' ');
                }
               
                // Remover caracteres especiales y espacios m√∫ltiples
                cleanedDesc = cleanedDesc.replace(/[^a-zA-Z√°√©√≠√≥√∫√±√Å√â√ç√ì√ö√ë0-9\s]/g, ' ')
                                       .replace(/\s+/g, ' ')
                                       .trim();
               
                // Si despu√©s de remover palabras gen√©ricas queda muy poco contenido √∫til
                if (cleanedDesc.length < 5) {
                    return true; // Es gen√©rica
                }
               
                // Verificar si solo quedan n√∫meros cortos (c√≥digos de transacci√≥n)
                const wordsLeft = cleanedDesc.split(' ').filter(w => w.length > 0);
                const meaningfulWords = wordsLeft.filter(w => {
                    // Filtrar n√∫meros cortos que podr√≠an ser c√≥digos de transacci√≥n gen√©ricos
                    if (/^\d+$/.test(w) && w.length < 4) return false;
                    return w.length >= 3; // Solo palabras de 3+ caracteres
                });
               
                // Si quedan menos de 2 palabras significativas, es gen√©rica
                if (meaningfulWords.length < 2) {
                    return true;
                }
               
                return false; // No es gen√©rica
            }

            // === NUEVA FUNCI√ìN: EXTRAER NOMBRES DE PERSONAS ===
            extractPersonNames(description) {
                if (!description) return [];
               
                const names = [];
               
                // Patrones m√°s espec√≠ficos para nombres despu√©s de TEF DE: o SINPE DE: o SINPE MOVIL
                // IMPORTANTE: Todos los patrones necesitan la bandera 'g' para usar con matchAll
                const specificPatterns = [
                    // Patrones tradicionales (ahora con bandera global)
                    /(?:TEF\s+(?:DE:|A:)\s*)([A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+(?:\s+[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+){1,3})/gi,
                    /(?:SINPE\s+(?:DE:|A:)\s*)([A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+(?:\s+[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+){1,3})/gi,
                    /(?:TEF\s+(?:A:)?\s*)([A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+(?:\s+[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+){1,3})/gi,
                    /(?:SINPE\s+(?:A:)?\s*)([A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+(?:\s+[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+){1,3})/gi,
                   
                    // Nuevos patrones para SINPE MOVIL (nombres despu√©s)
                    /SINPE\s+MOVIL\s+[A-Z0-9_\-]+\s+([A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+(?:\s+[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+){1,3})/gi,
                    /SINPE\s+MOVIL\s+[A-Z0-9_\-]+_([A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+(?:\s+[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+)*)/gi,
                   
                    // Nombres en descripci√≥n despu√©s de c√≥digos o placas
                    /[A-Z0-9]{3,8}[\s_\-]+([A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+(?:\s+[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+){1,2})/gi,
                ];
               
                for (const pattern of specificPatterns) {
                    try {
                        // Usar matchAll de forma segura
                        const matches = [...description.matchAll(pattern)];
                       
                        for (const match of matches) {
                            if (match && match[1]) {
                                const cleanName = match[1].trim();
                               
                                // Verificar que no sea una palabra gen√©rica
                                if (!this.isGenericName(cleanName)) {
                                    names.push(cleanName);
                                }
                            }
                        }
                    } catch (error) {
                        // Fallback: usar match normal si matchAll falla
                        console.warn('‚ö†Ô∏è Error con matchAll, usando match normal:', error);
                        const match = description.match(pattern);
                        if (match && match[1]) {
                            const cleanName = match[1].trim();
                            if (!this.isGenericName(cleanName)) {
                                names.push(cleanName);
                            }
                        }
                    }
                }
               
                // Si no encontr√≥ nombres espec√≠ficos, buscar patrones de nombres generales
                if (names.length === 0) {
                    // Limpiar el texto primero, removiendo placas conocidas y c√≥digos
                    let cleanDescription = description;
                   
                    // Remover placas detectadas para evitar confusi√≥n
                    const placasDetectadas = this.detectPlacasInText(description);
                    placasDetectadas.forEach(placaInfo => {
                        cleanDescription = cleanDescription.replace(new RegExp(placaInfo.placa, 'gi'), ' ');
                    });
                   
                    // Remover palabras clave comunes
                    cleanDescription = cleanDescription.replace(/SINPE|MOVIL|TEF|DE:|A:|_/gi, ' ');
                   
                    // Buscar nombres en el texto limpio
                    const generalPattern = /([A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+(?:\s+[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+){1,3})/g;
                    const matches = cleanDescription.match(generalPattern);
                   
                    if (matches) {
                        for (const match of matches) {
                            const cleanName = match.trim();
                           
                            // Filtros para nombres v√°lidos
                            if (cleanName.length >= 6 && // Al menos 6 caracteres
                                cleanName.split(' ').length >= 2 && // Al menos 2 palabras
                                !this.isGenericName(cleanName) &&
                                !/^\d+$/.test(cleanName) && // No solo n√∫meros
                                !/^[A-Z]{2,6}\d+$/.test(cleanName)) { // No c√≥digos como ABC123
                                names.push(cleanName);
                            }
                        }
                    }
                }
               
                return [...new Set(names)]; // Remover duplicados
            }

            // === FUNCI√ìN AUXILIAR: VERIFICAR SI ES NOMBRE GEN√âRICO ===
            isGenericName(name) {
                if (!name) return true;
               
                const genericNames = [
                    // Palabras relacionadas con veh√≠culos y transporte
                    'auto', 'carro', 'vehiculo', 'veh√≠culo', 'moto', 'motocicleta',
                    'camion', 'cami√≥n', 'pick', 'pickup', 'taxi', 'bus', 'omnibus',
                   
                    // Palabras bancarias y transacciones
                    'sinpe', 'movil', 'm√≥vil', 'banco', 'cliente', 'persona',
                    'transferencia', 'pago', 'deposito', 'retiro', 'compra', 'venta',
                    'servicio', 'cuota', 'abono', 'factura', 'recibo', 'remesa',
                   
                    // Palabras temporales y de fecha
                    'semana', 'mes', 'a√±o', 'dia', 'd√≠a', 'hora', 'tiempo',
                    'fecha', 'periodo', 'plazo',
                   
                    // Palabras gen√©ricas adicionales
                    'codigo', 'c√≥digo', 'numero', 'n√∫mero', 'referencia', 'ref',
                    'descripcion', 'descripci√≥n', 'detalle', 'observacion', 'observaci√≥n',
                   
                    // T√©rminos relacionados con estados civiles o documentos
                    'cedula', 'c√©dula', 'documento', 'identidad', 'pasaporte',
                   
                    // Palabras muy comunes
                    'general', 'varios', 'otros', 'diversos', 'empresa', 'sociedad',
                    'compa√±ia', 'compa√±√≠a', 'limitada', 'responsabilidad'
                ];
               
                const lowerName = name.toLowerCase();
               
                // Verificar si el nombre contiene palabras gen√©ricas
                for (const generic of genericNames) {
                    if (lowerName.includes(generic)) {
                        return true;
                    }
                }
               
                // Verificar si es solo n√∫meros
                if (/^\d+$/.test(name.replace(/\s+/g, ''))) {
                    return true;
                }
               
                // Verificar si parece un c√≥digo (letras may√∫sculas seguidas de n√∫meros)
                if (/^[A-Z]{2,6}\d+$/.test(name.replace(/\s+/g, ''))) {
                    return true;
                }
               
                // Verificar si tiene patrones t√≠picos de c√≥digos bancarios
                if (/^[A-Z]{3}\d{2,6}$/.test(name.replace(/\s+/g, '')) ||
                    /^[A-Z]{2}\d{3,6}$/.test(name.replace(/\s+/g, ''))) {
                    return true;
                }
               
                // Verificar si contiene muchos n√∫meros (m√°s del 50% del contenido)
                const totalChars = name.replace(/\s+/g, '').length;
                const numberChars = (name.match(/\d/g) || []).length;
                if (totalChars > 0 && (numberChars / totalChars) > 0.5) {
                    return true;
                }
               
                return false;
            }

            // === NUEVAS FUNCIONES AUXILIARES ===
           
            calculateNameSimilarity(name1, name2) {
                if (!name1 || !name2) return 0;
               
                const clean1 = name1.toLowerCase().trim();
                const clean2 = name2.toLowerCase().trim();
               
                // Coincidencia exacta
                if (clean1 === clean2) return 1.0;
               
                // Dividir en palabras
                const words1 = clean1.split(/\s+/);
                const words2 = clean2.split(/\s+/);
               
                // Verificar si todas las palabras significativas coinciden
                let matchingWords = 0;
                const totalWords = Math.max(words1.length, words2.length);
               
                for (const word1 of words1) {
                    if (word1.length >= 3) { // Solo palabras de 3+ caracteres
                        for (const word2 of words2) {
                            if (word1 === word2 || word1.includes(word2) || word2.includes(word1)) {
                                matchingWords++;
                                break;
                            }
                        }
                    }
                }
               
                return totalWords > 0 ? matchingWords / totalWords : 0;
            }
           
            extractUniqueNumbers(text) {
                if (!text) return [];
               
                // Buscar n√∫meros de 4 o m√°s d√≠gitos que puedan ser identificadores √∫nicos
                const numberMatches = text.match(/\b\d{4,}\b/g);
                return numberMatches ? numberMatches.filter(num =>
                    // Filtrar n√∫meros que no sean montos comunes
                    !['1000', '2000', '5000', '10000', '15000', '20000', '25000', '50000', '100000'].includes(num)
                ) : [];
            }
           
            extractSpecificCodes(text) {
                if (!text) return [];
               
                const codes = [];
               
                // Buscar c√≥digos como AUTO, MIN024, etc.
                const codeMatches = text.match(/\b[A-Z]{2,}[0-9]{2,}\b/g);
                if (codeMatches) codes.push(...codeMatches);
               
                // Buscar patrones como BMV462, etc.
                const alphaNumMatches = text.match(/\b[A-Z]{2,}\d{2,}\b/g);
                if (alphaNumMatches) codes.push(...alphaNumMatches);
               
                return codes;
            }

            normalizeText(text) {
                if (!text) return '';
                return text
                    .toLowerCase()
                    .replace(/[^a-z0-9\s]/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
            }

            calculateReferenceSimilarity(ref1, ref2) {
                if (!ref1 || !ref2) return 0;
               
                // Extraer n√∫meros de las referencias
                const nums1 = ref1.match(/\d+/g);
                const nums2 = ref2.match(/\d+/g);
               
                if (nums1 && nums2) {
                    // Buscar n√∫meros en com√∫n
                    for (const num1 of nums1) {
                        for (const num2 of nums2) {
                            if (num1 === num2 && num1.length >= 4) {
                                return 0.8; // N√∫mero largo coincidente
                            }
                        }
                    }
                }
               
                return 0;
            }

            calculateKeywordSimilarity(text1, text2) {
                if (!text1 || !text2) return 0;

                // Palabras clave importantes que suelen repetirse en transacciones
                const keywords = ['tef', 'sinpe', 'deposito', 'retiro', 'pago', 'transferencia', 'compra', 'venta', 'cuota', 'servicio'];
               
                let keywordMatches = 0;
                let totalKeywords = 0;

                for (const keyword of keywords) {
                    if (text1.includes(keyword) || text2.includes(keyword)) {
                        totalKeywords++;
                        if (text1.includes(keyword) && text2.includes(keyword)) {
                            keywordMatches++;
                        }
                    }
                }

                return totalKeywords > 0 ? keywordMatches / totalKeywords : 0;
            }

            calculateTextSimilarity(text1, text2) {
                if (!text1 || !text2) return 0;

                const words1 = text1.split(' ').filter(w => w.length > 2);
                const words2 = text2.split(' ').filter(w => w.length > 2);

                if (words1.length === 0 || words2.length === 0) return 0;

                // Contar palabras en com√∫n
                let commonWords = 0;
                for (const word1 of words1) {
                    for (const word2 of words2) {
                        if (word1.includes(word2) || word2.includes(word1) ||
                            this.levenshteinDistance(word1, word2) <= 2) {
                            commonWords++;
                            break;
                        }
                    }
                }

                // Calcular similitud como porcentaje
                const maxWords = Math.max(words1.length, words2.length);
                return commonWords / maxWords;
            }

            levenshteinDistance(str1, str2) {
                const matrix = [];
               
                for (let i = 0; i <= str2.length; i++) {
                    matrix[i] = [i];
                }
               
                for (let j = 0; j <= str1.length; j++) {
                    matrix[0][j] = j;
                }
               
                for (let i = 1; i <= str2.length; i++) {
                    for (let j = 1; j <= str1.length; j++) {
                        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j - 1] + 1,
                                matrix[i][j - 1] + 1,
                                matrix[i - 1][j] + 1
                            );
                        }
                    }
                }
               
                return matrix[str2.length][str1.length];
            }

            calculateConfidence(suggestion) {
                if (!suggestion) return 0;
               
                const similarity = suggestion.totalSimilarity;
                const hasNameMatch = suggestion.nameSimilarity >= 0.9;
                const hasPlacaMatch = suggestion.placaSimilarity >= 0.8;
                const hasReferenceMatch = suggestion.referenceSimilarity >= 0.9;
                const hasCodeMatch = suggestion.codeSimilarity >= 0.9;
               
                let confidence = Math.round(similarity * 100);
               
                // Bonificaciones por identificadores √∫nicos espec√≠ficos
                if (hasNameMatch) {
                    confidence += 30; // BONUS MUY ALTO por nombre de persona coincidente
                }
               
                if (hasPlacaMatch) {
                    confidence += 25; // BONUS ALTO por placa coincidente
                }
               
                if (hasReferenceMatch) {
                    confidence += 20; // BONUS por n√∫mero de referencia √∫nico
                }
               
                if (hasCodeMatch) {
                    confidence += 15; // BONUS por c√≥digo espec√≠fico
                }
               
                // Bonus extra por m√∫ltiples identificadores √∫nicos
                const uniqueFactors = [hasNameMatch, hasPlacaMatch, hasReferenceMatch, hasCodeMatch].filter(Boolean).length;
                if (uniqueFactors >= 2) {
                    confidence += 20; // Bonus por m√∫ltiples identificadores √∫nicos
                }
               
                // Bonus especial para matches perfectos
                if (suggestion.nameSimilarity === 1.0) {
                    confidence += 15; // Nombre 100% exacto
                }
               
                if (suggestion.placaSimilarity === 1.0) {
                    confidence += 10; // Placa 100% exacta
                }
               
                // Asegurar que est√© en el rango correcto
                confidence = Math.min(Math.max(confidence, 30), 99);
               
                return confidence;
            }

            updateAIStatus(status) {
                if (this.aiStatus) {
                    this.aiStatus.textContent = status;
                }
            }

            updateAIProgress(percentage) {
                if (this.aiProgressBar) {
                    this.aiProgressBar.style.width = `${percentage}%`;
                }
                this.analysisProgress = percentage;
            }

            showAISummary() {
                const suggestionsCount = this.aiSuggestions.size;
                const highConfidenceCount = Array.from(this.aiSuggestions.values())
                    .filter(s => s.confidence >= 70).length;

                let summaryHTML = `
                    <div class="suggestion-item">
                        <div class="suggestion-confidence">${suggestionsCount}</div>
                        <div class="suggestion-content">
                            <strong>Sugerencias generadas para transacciones sin conciliar</strong>
                            <div class="suggestion-text">
                                ${highConfidenceCount} con alta confianza (‚â•70%) y ${suggestionsCount - highConfidenceCount} con confianza media
                            </div>
                        </div>
                    </div>
                `;

                // Mostrar algunas sugerencias destacadas
                const topSuggestions = Array.from(this.aiSuggestions.values())
                    .sort((a, b) => b.confidence - a.confidence)
                    .slice(0, 3);

                for (const suggestion of topSuggestions) {
                    const tx = suggestion.transaction;
                    const topMatch = suggestion.suggestions[0];
                   
                    summaryHTML += `
                        <div class="suggestion-item">
                            <div class="suggestion-confidence">${suggestion.confidence}%</div>
                            <div class="suggestion-content">
                                <strong>Ref: ${tx.Referencia}</strong> - ${this.formatAmount(tx.Cr√©ditos)}
                                <div class="suggestion-text">
                                    "${topMatch.suggestedObservation}"
                                </div>
                            </div>
                        </div>
                    `;
                }

                this.aiSuggestionsList.innerHTML = summaryHTML;
                this.updateAIStatus(`‚úÖ ${suggestionsCount} sugerencias listas para revisar`);
               
                // IMPORTANTE: Mensaje claro en consola
                console.log(`üéâ SUGERENCIAS IA DISPONIBLES: ${suggestionsCount} transacciones con indicadores üß†`);
                console.log(`üìç Los indicadores aparecen en la columna "Observaciones / Sugerencias"`);
                console.log(`üí° Haz clic en los botones üß† para ver los detalles de cada sugerencia`);
               
                // Forzar refresh final para asegurar que se muestren todas las sugerencias
                setTimeout(() => {
                    this.refreshCurrentView();
                    console.log(`‚úÖ Vista final actualizada con todas las ${suggestionsCount} sugerencias`);
                }, 100);
            }

            // === FUNCIONES MEJORADAS PARA MOSTRAR SUGERENCIAS ===
            createSuggestionIndicator(transaction, index) {
                const suggestion = this.aiSuggestions.get(transaction.Referencia);
                if (!suggestion) return '';

                const confidence = suggestion.confidence;
                const topMatch = suggestion.suggestions[0];
                const hasPlacaMatch = topMatch.placaSimilarity >= 0.8;
                const hasNameMatch = topMatch.nameSimilarity >= 0.9;
                const hasReferenceMatch = topMatch.referenceSimilarity >= 0.9;
                const hasCodeMatch = topMatch.codeSimilarity >= 0.9;
               
                // Crear preview de la sugerencia
                let suggestionPreview = topMatch.suggestedObservation.substring(0, 30) + '...';
               
                // Agregar badges especiales basados en identificadores √∫nicos
                let badges = '';
                if (hasNameMatch) badges += ' üë§';
                if (hasPlacaMatch) badges += ' üöó';
                if (hasReferenceMatch) badges += ' üî¢';
                if (hasCodeMatch) badges += ' üè∑Ô∏è';
               
                // Color del indicador basado en confianza y factores √∫nicos
                let gradientColor;
                if (confidence >= 90 || (hasNameMatch && hasPlacaMatch)) {
                    gradientColor = 'linear-gradient(135deg, #27ae60, #2ecc71)'; // Verde para muy alta confianza
                } else if (confidence >= 75 || hasNameMatch || hasPlacaMatch) {
                    gradientColor = 'linear-gradient(135deg, #ff9500, #ff6b35)'; // Naranja para alta confianza
                } else {
                    gradientColor = 'linear-gradient(135deg, #3498db, #2980b9)'; // Azul para confianza media
                }

                return `
                    <div style="position: relative; display: flex; flex-direction: column; align-items: center; gap: 4px;">
                        <button class="suggestion-indicator"
                                data-suggestion-ref="${transaction.Referencia}"
                                style="background: ${gradientColor};"
                                title="üí° ${suggestionPreview}${badges} (${confidence}% confianza) - Clic para ver detalles">
                            üß†
                        </button>
                        <span style="background: ${gradientColor}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: bold; white-space: nowrap;">
                            ${confidence}%${badges}
                        </span>
                    </div>
                `;
            }

            toggleSuggestionTooltip(referencia) {
                console.log('üß† Mostrando panel de sugerencia para:', referencia);
                this.showSuggestionPanel(referencia);
            }

            // ===== FUNCI√ìN PARA GENERAR SUGERENCIAS POR DEMANDA =====
            async generateSuggestionsForTransaction(transactionRef) {
                try {
                    // Buscar la transacci√≥n espec√≠fica
                    const transaction = this.allTransactions.find(t => t.Referencia === transactionRef);
                    if (!transaction) {
                        console.error('‚ùå Transacci√≥n no encontrada:', transactionRef);
                        this.showSavingIndicator('‚ùå Transacci√≥n no encontrada', 'error');
                        return;
                    }

                    // Verificar si ya hay sugerencias para esta transacci√≥n
                    if (this.aiSuggestions.has(transactionRef)) {
                        console.log('‚úÖ Ya existen sugerencias para esta transacci√≥n');
                        this.showSavingIndicator('‚úÖ Ya existen sugerencias para esta transacci√≥n', 'success');
                        return;
                    }

                    // Verificar que la transacci√≥n no tenga observaciones
                    if (transaction.Observaciones && transaction.Observaciones.trim() !== '') {
                        console.log('‚ö†Ô∏è La transacci√≥n ya tiene observaciones');
                        this.showSavingIndicator('‚ö†Ô∏è La transacci√≥n ya tiene observaciones', 'warning');
                        return;
                    }

                    // Mostrar indicador de carga
                    this.showSavingIndicator('üß† Generando sugerencias de IA...', 'loading');

                    // Clasificar transacciones si no se ha hecho
                    if (this.conciliatedTransactions.length === 0) {
                        await this.classifyTransactions();
                    }

                    // Generar sugerencias para esta transacci√≥n espec√≠fica
                    const suggestions = this.findSimilarTransactions(transaction);
                    
                    if (suggestions.length > 0) {
                        const confidence = this.calculateConfidence(suggestions[0]);
                        
                        this.aiSuggestions.set(transactionRef, {
                            transaction: transaction,
                            suggestions: suggestions,
                            confidence: confidence
                        });

                        // Actualizar dashboard
                        this.updateAISuggestionsDashboard();
                        
                        // Actualizar solo la fila espec√≠fica sin reordenar
                        this.updateTransactionRowWithSuggestion(transactionRef);
                        
                        this.showSavingIndicator('‚úÖ Sugerencias generadas exitosamente', 'success');
                        
                        console.log(`üí° Sugerencias generadas para ${transactionRef}:`, suggestions[0].suggestedObservation);
                    } else {
                        this.showSavingIndicator('‚ö†Ô∏è No se encontraron sugerencias para esta transacci√≥n', 'warning');
                    }

                } catch (error) {
                    console.error('‚ùå Error generando sugerencias:', error);
                    this.showSavingIndicator('‚ùå Error generando sugerencias', 'error');
                }
            }

            showSuggestionPanel(referencia) {
                const suggestion = this.aiSuggestions.get(referencia);
                if (!suggestion) {
                    console.warn('‚ö†Ô∏è No se encontr√≥ sugerencia para:', referencia);
                    return;
                }

                const transaction = suggestion.transaction;
                const confidence = suggestion.confidence;
                const topMatch = suggestion.suggestions[0];

                // Crear backdrop
                const backdrop = document.createElement('div');
                backdrop.className = 'suggestion-panel-backdrop';
                backdrop.id = 'suggestion-backdrop';
               
                // Crear panel
                const panel = document.createElement('div');
                panel.className = 'suggestion-panel';
                panel.id = 'suggestion-panel';
               
                panel.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                        <span style="font-size: 28px;">üß†</span>
                        <div>
                            <h3 style="margin: 0; font-size: 18px; font-weight: 700;">Sugerencia de IA</h3>
                            <p style="margin: 0; opacity: 0.9; font-size: 14px;">Confianza: ${confidence}%</p>
                        </div>
                        <button onclick="window.transactionSearchSystem.closeSuggestionPanel()"
                                style="margin-left: auto; background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 18px;">
                            √ó
                        </button>
                    </div>

                    <div style="background: rgba(255,255,255,0.1); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                        <h4 style="margin: 0 0 8px 0; font-size: 14px; opacity: 0.8;">üìÑ Transacci√≥n:</h4>
                        <p style="margin: 0 0 8px 0; font-weight: 600;">${transaction.Referencia} - ${this.formatAmount(transaction.Cr√©ditos)}</p>
                        <p style="margin: 0; font-size: 13px; opacity: 0.9;">${transaction.Descripci√≥n}</p>
                        ${topMatch.unconciledPlacas && topMatch.unconciledPlacas.length > 0 ?
                            topMatch.unconciledPlacas.map(p =>
                                `<p style="margin: 8px 0 0 0; font-size: 12px; background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 6px;">
                                    üöó Placa: <strong>${p.placa}</strong>
                                    ${p.tipoCoincidencia === 'exacta' ? '(‚úÖ Flota Verificada)' :
                                      p.tipoCoincidencia === 'parcial' ? '(‚ö†Ô∏è Parcial en Flota)' :
                                      p.tipoCoincidencia === 'formato' ? '(üìù Similar en Flota)' :
                                      p.tipoCoincidencia === 'detectada' ? '(üîç Detectada)' : ''}
                                </p>`
                            ).join('') : ''}
                        ${topMatch.unconciledNames && topMatch.unconciledNames.length > 0 ? `<p style="margin: 8px 0 0 0; font-size: 12px; background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 6px;">üë§ Nombre detectado: <strong>${topMatch.unconciledNames[0]}</strong></p>` : ''}
                        ${topMatch.unconciledNumbers && topMatch.unconciledNumbers.length > 0 ? `<p style="margin: 8px 0 0 0; font-size: 12px; background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 6px;">üî¢ N√∫mero √∫nico: <strong>${topMatch.unconciledNumbers[0]}</strong></p>` : ''}
                    </div>

                    <div style="background: rgba(255,255,255,0.15); padding: 16px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid #ff9500;">
                        <h4 style="margin: 0 0 8px 0; font-size: 14px; opacity: 0.8;">üí° Observaci√≥n sugerida:</h4>
                        <p style="margin: 0; font-size: 15px; font-weight: 600; font-style: italic;">
                            "${topMatch.suggestedObservation}"
                        </p>
                    </div>

                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 12px; opacity: 0.9;">
                        <p style="margin: 0 0 4px 0;">üìä <strong>Basado en similitud con:</strong> ${topMatch.conciliatedTransaction.Referencia}</p>
                        <p style="margin: 0 0 4px 0;">üéØ <strong>Similitud total:</strong> ${Math.round(topMatch.totalSimilarity * 100)}%</p>
                        ${topMatch.nameSimilarity >= 0.9 ? `<p style="margin: 0 0 4px 0;">üë§ <strong>Nombre detectado:</strong> ${Math.round(topMatch.nameSimilarity * 100)}% coincidencia</p>` : ''}
                        ${topMatch.placaSimilarity >= 0.8 ? `<p style="margin: 0 0 4px 0;">üöó <strong>Placa coincidente:</strong> ${topMatch.conciliatedPlaca || topMatch.unconciledPlaca}</p>` : ''}
                        ${topMatch.referenceSimilarity >= 0.9 ? '<p style="margin: 0 0 4px 0;">üî¢ <strong>N√∫mero √∫nico coincidente</strong></p>' : ''}
                        ${topMatch.codeSimilarity >= 0.9 ? '<p style="margin: 0 0 4px 0;">üè∑Ô∏è <strong>C√≥digo espec√≠fico coincidente</strong></p>' : ''}
                        ${topMatch.matchFactors && topMatch.matchFactors.length > 0 ? `<p style="margin: 0; color: #ff9500;"><strong>Identificadores √∫nicos:</strong> ${topMatch.matchFactors.join(', ')}</p>` : ''}
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button onclick="window.transactionSearchSystem.applySuggestionFromPanel('${referencia}')"
                                style="background: #27ae60; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; flex: 1;">
                            ‚úÖ Aplicar Sugerencia
                        </button>
                        <button onclick="window.transactionSearchSystem.dismissSuggestionFromPanel('${referencia}')"
                                style="background: #e74c3c; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; flex: 1;">
                            ‚ùå Descartar
                        </button>
                    </div>
                `;

                // Agregar al DOM
                document.body.appendChild(backdrop);
                document.body.appendChild(panel);

                // Mostrar con animaci√≥n
                setTimeout(() => {
                    backdrop.classList.add('show');
                    panel.classList.add('show');
                }, 10);

                // Cerrar al hacer clic en el backdrop
                backdrop.addEventListener('click', () => {
                    this.closeSuggestionPanel();
                });

                // Cerrar con Escape
                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        this.closeSuggestionPanel();
                        document.removeEventListener('keydown', escapeHandler);
                    }
                };
                document.addEventListener('keydown', escapeHandler);
            }

            closeSuggestionPanel() {
                const backdrop = document.getElementById('suggestion-backdrop');
                const panel = document.getElementById('suggestion-panel');
               
                if (backdrop) {
                    backdrop.classList.remove('show');
                    setTimeout(() => backdrop.remove(), 300);
                }
               
                if (panel) {
                    panel.classList.remove('show');
                    setTimeout(() => panel.remove(), 300);
                }
            }

            async applySuggestionFromPanel(referencia) {
                await this.applySuggestion(referencia);
                this.closeSuggestionPanel();
            }

            dismissSuggestionFromPanel(referencia) {
                this.dismissSuggestion(referencia);
                this.closeSuggestionPanel();
            }

            dismissSuggestion(referencia) {
                // Remover la sugerencia del mapa
                this.aiSuggestions.delete(referencia);

                // Actualizar dashboard de estad√≠sticas
                this.updateAISuggestionsDashboard();

                // Recargar la vista actual para ocultar el indicador
                const currentQuery = this.searchInput.value.trim();
                if (currentQuery || this.dateFilterActive || this.observationsFilter !== 'all') {
                    this.performSearch(currentQuery);
                } else {
                    this.showInitialState();
                }

                this.showSavingIndicator('Sugerencia descartada', 'success');
            }

            // === CARGA DE TRANSACCIONES CON IA ===
            async loadTransactions() {
                try {
                    this.showLoading(true);
                    this.hideError();
                   
                    // Cargar desde la hoja BAC primero
                    try {
                        const defaultResponse = await fetch(this.apiUrl);
                        if (defaultResponse.ok) {
                            const defaultData = await defaultResponse.json();
                            this.bacTransactions = Array.isArray(defaultData) ? defaultData.map(t => ({
                                ...t,
                                banco: 'BAC',
                                montoNumerico: this.parseAmount(t.Cr√©ditos || '0')
                            })) : [];
                            
                            // Ordenar transacciones de BAC por fecha y monto
                            this.sortTransactionsByDateAndAmount(this.bacTransactions);
                            
                            console.log(`‚úÖ Cargadas y ordenadas ${this.bacTransactions.length} transacciones de BAC`);
                        }
                    } catch (error) {
                        console.warn('Error cargando hoja por defecto:', error);
                    }
                   
                    // Cargar desde todas las hojas
                    const sheets = [
                        { name: 'BAC', target: 'bacTransactions' },
                        { name: 'BN', target: 'bnTransactions' },
                        { name: 'HuberBN', target: 'huberBNTransactions' },
                        { name: 'AutosubastasBAC', target: 'autosubastasTransactions' },
                        { name: 'AutosubastasBN', target: 'autosubastasBNTransactions' }
                    ];

                    for (const sheet of sheets) {
                        try {
                            const url = sheet.name === 'BAC' ? this.apiUrl : `${this.apiUrl}?sheet=${sheet.name}`;
                            const response = await fetch(url);
                            if (response.ok) {
                                const data = await response.json();
                                this[sheet.target] = Array.isArray(data) ? data.map(t => ({
                                    ...t,
                                    banco: sheet.name,
                                    montoNumerico: this.parseAmount(t.Cr√©ditos || '0')
                                })) : [];
                                
                                // Ordenar transacciones de cada banco por fecha y monto
                                this.sortTransactionsByDateAndAmount(this[sheet.target]);
                                
                                console.log(`‚úÖ Cargadas y ordenadas ${this[sheet.target].length} transacciones de ${sheet.name}`);
                            } else {
                                this[sheet.target] = [];
                            }
                        } catch (error) {
                            console.warn(`Error cargando ${sheet.name}:`, error);
                            this[sheet.target] = [];
                        }
                    }
                   
                    // Combinar todas las transacciones
                    this.allTransactions = [
                        ...this.bacTransactions,
                        ...this.bnTransactions,
                        ...this.huberBNTransactions,
                        ...this.autosubastasTransactions,
                        ...this.autosubastasBNTransactions
                    ];
                   
                    if (this.allTransactions.length === 0) {
                        throw new Error('No se pudieron cargar transacciones de ninguna hoja');
                    }
                   
                    // Ordenar transacciones por fecha y monto
                    this.sortTransactionsByDateAndAmount(this.allTransactions);
                   
                    console.log(`üìä Total de transacciones cargadas y ordenadas: ${this.allTransactions.length}`);
                   
                    // Agregar campo Observaciones si no existe
                    if (this.allTransactions.length > 0) {
                        const hasObservaciones = this.allTransactions.some(t => 'Observaciones' in t);
                        const hasIDCliente = this.allTransactions.some(t => 'ID_Cliente' in t);
                        
                        if (!hasObservaciones) {
                            console.warn('‚ö†Ô∏è El campo "Observaciones" no existe en la API. Agregando campo vac√≠o por defecto.');
                            this.allTransactions.forEach(t => t.Observaciones = '');
                            this.bacTransactions.forEach(t => t.Observaciones = '');
                            this.bnTransactions.forEach(t => t.Observaciones = '');
                            this.huberBNTransactions.forEach(t => t.Observaciones = '');
                            this.autosubastasTransactions.forEach(t => t.Observaciones = '');
                            this.autosubastasBNTransactions.forEach(t => t.Observaciones = '');
                        }
                        
                        if (!hasIDCliente) {
                            console.warn('‚ö†Ô∏è El campo "ID_Cliente" no existe en la API. Agregando campo vac√≠o por defecto.');
                            this.allTransactions.forEach(t => t.ID_Cliente = '');
                            this.bacTransactions.forEach(t => t.ID_Cliente = '');
                            this.bnTransactions.forEach(t => t.ID_Cliente = '');
                            this.huberBNTransactions.forEach(t => t.ID_Cliente = '');
                            this.autosubastasTransactions.forEach(t => t.ID_Cliente = '');
                            this.autosubastasBNTransactions.forEach(t => t.ID_Cliente = '');
                        }
                    }

                    // Inicializar filtro de observaciones
                    this.updateObservationsFilterUI();

                    // === CARGAR PLACAS DE FLOTA ===
                    await this.loadFlotaPlacas();

                    // === CARGAR TRANSACCIONES PENDIENTES POR DEFECTO ===
                    // Establecer filtro en "Sin Obs." autom√°ticamente (m√°s r√°pido)
                    setTimeout(() => {
                        this.observationsFilter = 'without';
                        this.updateObservationsFilterUI();
                        this.performObservationsFilterOnly();
                        console.log('üìù Vista inicial configurada: mostrando transacciones sin observaciones');
                    }, 200); // Reducido de 500ms a 200ms

                    // === AN√ÅLISIS DE IA DESHABILITADO PARA CARGA M√ÅS R√ÅPIDA ===
                    // El an√°lisis ahora se ejecuta por demanda cuando el usuario lo solicita
                    // setTimeout(() => {
                    //     this.startAIAnalysis();
                    // }, 500);
                   
                } catch (error) {
                    console.error('Error cargando transacciones:', error);
                    this.showError(`Error al cargar las transacciones: ${error.message}. Verifique la conexi√≥n a la API.`);
                } finally {
                    this.showLoading(false);
                }
            }

            // === M√âTODOS PARA EL FILTRO DE OBSERVACIONES ===
            toggleObservationsFilter() {
                console.log('üîÑ Alternando filtro de observaciones. Actual:', this.observationsFilter);
               
                switch (this.observationsFilter) {
                    case 'all':
                        this.observationsFilter = 'without';
                        break;
                    case 'without':
                        this.observationsFilter = 'with';
                        break;
                    case 'with':
                        this.observationsFilter = 'all';
                        break;
                    default:
                        this.observationsFilter = 'all';
                }

                console.log('üîÑ Filtro de observaciones cambiado a:', this.observationsFilter);
               
                this.updateObservationsFilterUI();

                const currentQuery = this.searchInput.value.trim();
                if (currentQuery || this.dateFilterActive) {
                    this.performSearch(currentQuery);
                } else {
                    this.performObservationsFilterOnly();
                }
            }

            updateObservationsFilterUI() {
                if (!this.observationsFilterBtn) {
                    console.error('‚ùå No se encontr√≥ el bot√≥n de filtro de observaciones');
                    return;
                }

                let buttonText, buttonColor, buttonTitle;
               
                switch (this.observationsFilter) {
                    case 'all':
                        buttonText = 'üîÑ Todas';
                        buttonColor = '#6c757d';
                        buttonTitle = 'Mostrando todas las transacciones. Clic para mostrar solo sin observaciones.';
                        break;
                    case 'without':
                        buttonText = 'üìù Sin Obs.';
                        buttonColor = '#ff9500';
                        buttonTitle = 'Mostrando solo transacciones SIN observaciones desde 10/07/2025 (pendientes). Clic para mostrar solo con observaciones.';
                        break;
                    case 'with':
                        buttonText = '‚úÖ Con Obs.';
                        buttonColor = '#30d158';
                        buttonTitle = 'Mostrando solo transacciones CON observaciones (conciliadas). Clic para mostrar todas.';
                        break;
                }

                this.observationsFilterBtn.textContent = buttonText;
                this.observationsFilterBtn.style.background = buttonColor;
                this.observationsFilterBtn.style.borderColor = buttonColor;
                this.observationsFilterBtn.title = buttonTitle;
               
                console.log('‚úÖ UI del filtro de observaciones actualizada:', buttonText);
            }

            performObservationsFilterOnly() {
                console.log('üìù Ejecutando solo filtro de observaciones:', this.observationsFilter);
               
                let transactionsToFilter = this.getFilteredTransactionsByBank();
               
                if (this.dateFilterActive) {
                    transactionsToFilter = this.applyDateFilterToTransactions(transactionsToFilter);
                }
               
                const filteredByObservations = this.applyObservationsFilter(transactionsToFilter);
                const finalResults = this.applyCurrentFilter(filteredByObservations);
               
                // Ordenar resultados por fecha y monto
                this.sortTransactionsByDateAndAmount(finalResults);
               
                console.log(`üìä Resultados filtrados por observaciones: ${finalResults.length}`);
               
                if (finalResults.length === 0) {
                    this.showNoResults();
                } else {
                    this.displayResults(finalResults, '');
                }
            }

            applyObservationsFilter(transactions) {
                console.log('üîç Aplicando filtro de observaciones:', this.observationsFilter, 'a', transactions.length, 'transacciones');
               
                switch (this.observationsFilter) {
                    case 'without':
                        // Para transacciones sin observaciones, tambi√©n aplicar filtro de fecha desde 10/07/2025
                        const without = transactions.filter(t => {
                            const hasNoObservations = !t.Observaciones || t.Observaciones.trim() === '';
                            if (!hasNoObservations) return false;
                           
                            // Aplicar filtro de fecha de corte (solo desde 10/07/2025)
                            const transactionDate = this.parseTransactionDate(t.Fecha);
                            if (!transactionDate) return false;
                           
                            const isAfterCutoff = transactionDate >= this.cutoffDate;
                            return isAfterCutoff;
                        });
                        console.log('üìù Transacciones sin observaciones desde 10/07/2025:', without.length);
                        return without;
                    case 'with':
                        const with_ = transactions.filter(t => t.Observaciones && t.Observaciones.trim() !== '');
                        console.log('‚úÖ Transacciones con observaciones:', with_.length);
                        return with_;
                    case 'all':
                    default:
                        console.log('üîÑ Mostrando todas las transacciones:', transactions.length);
                        return transactions;
                }
            }

            // === M√âTODOS PARA EL FILTRO DE FECHA ===
            applyDateFilter() {
                const dateFrom = this.dateFromInput.value;
                const dateTo = this.dateToInput.value;

                if (!dateFrom && !dateTo) {
                    alert('Por favor selecciona al menos una fecha (desde o hasta)');
                    return;
                }

                console.log('üìÖ Aplicando filtro de fecha:', { dateFrom, dateTo });

                this.dateFromFilter = dateFrom || null;
                this.dateToFilter = dateTo || null;
                this.dateFilterActive = true;

                this.updateDateFilterUI();

                const currentQuery = this.searchInput.value.trim();
                if (currentQuery) {
                    this.performSearch(currentQuery);
                } else {
                    this.performDateFilterOnly();
                }
            }

            clearDateFilter() {
                console.log('‚ùå Limpiando filtro de fecha');
               
                this.dateFilterActive = false;
                this.dateFromFilter = null;
                this.dateToFilter = null;
                this.dateFromInput.value = '';
                this.dateToInput.value = '';

                this.updateDateFilterUI();

                const currentQuery = this.searchInput.value.trim();
                if (currentQuery || this.observationsFilter !== 'all') {
                    this.performSearch(currentQuery);
                } else {
                    this.showInitialState();
                }
            }

            updateDateFilterUI() {
                if (this.dateFilterActive) {
                    this.dateFilterSection.classList.add('active');
                    this.dateFilterStatus.classList.add('show');
                   
                    let rangeText = '';
                    if (this.dateFromFilter && this.dateToFilter) {
                        rangeText = `${this.formatDateForDisplay(this.dateFromFilter)} - ${this.formatDateForDisplay(this.dateToFilter)}`;
                    } else if (this.dateFromFilter) {
                        rangeText = `Desde ${this.formatDateForDisplay(this.dateFromFilter)}`;
                    } else if (this.dateToFilter) {
                        rangeText = `Hasta ${this.formatDateForDisplay(this.dateToFilter)}`;
                    }
                   
                    this.dateRangeText.textContent = rangeText;
                } else {
                    this.dateFilterSection.classList.remove('active');
                    this.dateFilterStatus.classList.remove('show');
                }
            }

            formatDateForDisplay(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr + 'T00:00:00');
                return date.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            }

            performDateFilterOnly() {
                console.log('üìÖ Ejecutando solo filtro de fecha');
               
                const transactionsToFilter = this.getFilteredTransactionsByBank();
                let filteredByDate = this.applyDateFilterToTransactions(transactionsToFilter);
               
                if (this.observationsFilter !== 'all') {
                    filteredByDate = this.applyObservationsFilter(filteredByDate);
                }
               
                const finalResults = this.applyCurrentFilter(filteredByDate);
               
                // Ordenar resultados por fecha y monto
                this.sortTransactionsByDateAndAmount(finalResults);
               
                console.log(`üìä Resultados filtrados por fecha y observaciones: ${finalResults.length}`);
               
                if (finalResults.length === 0) {
                    this.showNoResults();
                } else {
                    this.displayResults(finalResults, '');
                }
            }

            applyDateFilterToTransactions(transactions) {
                if (!this.dateFilterActive) {
                    return transactions;
                }

                return transactions.filter(transaction => {
                    const transactionDate = this.parseTransactionDate(transaction.Fecha);
                    if (!transactionDate) {
                        console.warn('‚ö†Ô∏è Fecha inv√°lida encontrada:', transaction.Fecha, 'en transacci√≥n:', transaction.Referencia);
                        return false;
                    }

                    let matchesDateFilter = true;

                    if (this.dateFromFilter) {
                        const fromDate = new Date(this.dateFromFilter + 'T00:00:00');
                        matchesDateFilter = matchesDateFilter && (transactionDate >= fromDate);
                    }

                    if (this.dateToFilter) {
                        const toDate = new Date(this.dateToFilter + 'T23:59:59');
                        matchesDateFilter = matchesDateFilter && (transactionDate <= toDate);
                    }

                    return matchesDateFilter;
                });
            }

            parseTransactionDate(dateStr) {
                if (!dateStr) return null;

                try {
                    let date = null;

                    if (dateStr.includes('/') || dateStr.includes('-')) {
                        const separator = dateStr.includes('/') ? '/' : '-';
                        const parts = dateStr.split(separator);
                       
                        if (parts.length === 3) {
                            const day = parseInt(parts[0]);
                            const month = parseInt(parts[1]) - 1;
                            const year = parseInt(parts[2]);
                           
                            if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                                date = new Date(year, month, day);
                            }
                        }
                    }
                   
                    if (!date && dateStr.match(/^\d{4}-\d{2}-\d{2}/)) {
                        date = new Date(dateStr + 'T00:00:00');
                    }

                    if (date && !isNaN(date.getTime())) {
                        return date;
                    }

                    return null;

                } catch (error) {
                    console.error('‚ùå Error parseando fecha:', dateStr, error);
                    return null;
                }
            }

            parseAmount(amountStr) {
                if (!amountStr) return 0;
               
                let cleanStr = amountStr.toString();
               
                if (cleanStr.includes('.') && !cleanStr.includes(',')) {
                    return parseFloat(cleanStr) || 0;
                } else if (cleanStr.includes(',')) {
                    cleanStr = cleanStr.replace(/\./g, '').replace(',', '.');
                    return parseFloat(cleanStr) || 0;
                } else {
                    return parseFloat(cleanStr) || 0;
                }
            }

            // Funci√≥n auxiliar para ordenar transacciones por fecha y monto
            sortTransactionsByDateAndAmount(transactions) {
                return transactions.sort((a, b) => {
                    // Primero ordenar por fecha (m√°s reciente primero)
                    const dateA = this.parseTransactionDate(a.Fecha);
                    const dateB = this.parseTransactionDate(b.Fecha);
                    
                    if (dateA && dateB) {
                        if (dateA.getTime() !== dateB.getTime()) {
                            return dateB.getTime() - dateA.getTime(); // M√°s reciente primero
                        }
                    }
                    
                    // Si las fechas son iguales o no v√°lidas, ordenar por monto (mayor a menor)
                    const amountA = this.parseAmount(a.Cr√©ditos || '0');
                    const amountB = this.parseAmount(b.Cr√©ditos || '0');
                    return amountB - amountA; // Mayor monto primero
                });
            }

            // Funci√≥n para actualizar solo una fila espec√≠fica sin reordenar
            updateTransactionRowWithSuggestion(transactionRef) {
                console.log('üîÑ Actualizando fila espec√≠fica para sugerencia:', transactionRef);
                
                // Buscar la transacci√≥n
                const transaction = this.allTransactions.find(t => t.Referencia === transactionRef);
                if (!transaction) {
                    console.error('‚ùå Transacci√≥n no encontrada para actualizar fila:', transactionRef);
                    return;
                }

                // Buscar el √≠ndice de la transacci√≥n en los resultados actuales
                const currentResults = this.getLastDisplayedResults();
                if (!currentResults) {
                    console.warn('‚ö†Ô∏è No hay resultados actuales para actualizar');
                    return;
                }

                const transactionIndex = currentResults.findIndex(t => t.Referencia === transactionRef);
                if (transactionIndex === -1) {
                    console.warn('‚ö†Ô∏è Transacci√≥n no encontrada en resultados actuales:', transactionRef);
                    return;
                }

                // Obtener el contenedor de resultados
                const resultsContainer = this.resultsContainer;
                if (!resultsContainer) {
                    console.error('‚ùå Contenedor de resultados no encontrado');
                    return;
                }

                // Determinar si estamos en vista m√≥vil o desktop
                const isMobile = window.innerWidth <= 768;
                
                // Obtener la consulta actual para el resaltado
                const currentQuery = this.searchInput.value.trim();
                
                if (isMobile) {
                    // Actualizar fila m√≥vil
                    const mobileRows = resultsContainer.querySelectorAll('.mobile-transaction-row');
                    if (mobileRows[transactionIndex]) {
                        const newRowHTML = this.createMobileTransactionRow(currentResults[transactionIndex], currentQuery, transactionIndex);
                        mobileRows[transactionIndex].outerHTML = newRowHTML;
                    }
                } else {
                    // Actualizar fila desktop
                    const desktopRows = resultsContainer.querySelectorAll('.transaction-row');
                    if (desktopRows[transactionIndex]) {
                        const newRowHTML = this.createDesktopTransactionRow(currentResults[transactionIndex], currentQuery, transactionIndex);
                        desktopRows[transactionIndex].outerHTML = newRowHTML;
                    }
                }

                // Re-aplicar listeners a la fila actualizada
                this.addSuggestionListeners(currentResults);
                
                console.log('‚úÖ Fila actualizada sin reordenamiento:', transactionRef);
            }

            formatAmount(amount) {
                if (!amount) return '¬¢0,00';
               
                let amountStr = amount.toString();
               
                if (amountStr.includes('.') && !amountStr.includes(',')) {
                    const parts = amountStr.split('.');
                    if (parts.length === 2 && parts[1].length <= 2) {
                        amountStr = parts[0] + ',' + parts[1].padEnd(2, '0');
                    }
                }
               
                const cleanNumber = parseFloat(amountStr.replace(/[^\d]/g, '')) / 100;
               
                return `¬¢${cleanNumber.toLocaleString('es-CR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).replace(/\./g, 'TEMP').replace(/,/g, '.').replace(/TEMP/g, ',')}`;
            }

            showSavingIndicator(message, type = '', showButtons = false) {
                if (!this.savingIndicator) {
                    this.savingIndicator = document.getElementById('savingIndicator');
                   
                    if (!this.savingIndicator) {
                        console.error('‚ùå No se pudo encontrar el elemento del indicador');
                        return;
                    }
                }
               
                // Limpiar contenido anterior
                this.savingIndicator.innerHTML = '';
               
                // Crear contenido b√°sico
                const messageElement = document.createElement('div');
                messageElement.textContent = message;
                this.savingIndicator.appendChild(messageElement);
               
                // Agregar botones si es necesario
                if (showButtons && (type === 'success' || type === 'conciliated')) {
                    const buttonsContainer = document.createElement('div');
                    buttonsContainer.className = 'saving-indicator-buttons';
                   
                    const pendingButton = document.createElement('button');
                    pendingButton.className = 'saving-indicator-btn primary';
                    pendingButton.textContent = 'üîÑ Ver Pendientes';
                    pendingButton.onclick = () => {
                        this.goToPendingTransactions();
                        this.savingIndicator.classList.remove('show');
                    };
                   
                    const continueButton = document.createElement('button');
                    continueButton.className = 'saving-indicator-btn';
                    continueButton.textContent = 'üìã Copiar Esta';
                    continueButton.onclick = () => {
                        // Copiar la √∫ltima transacci√≥n conciliada
                        const currentResults = this.getLastDisplayedResults();
                        if (currentResults && currentResults.length > 0) {
                            this.copyTransaction(currentResults[0], continueButton);
                        }
                        this.savingIndicator.classList.remove('show');
                    };
                   
                    buttonsContainer.appendChild(pendingButton);
                    buttonsContainer.appendChild(continueButton);
                    this.savingIndicator.appendChild(buttonsContainer);
                }
               
                this.savingIndicator.className = `saving-indicator show ${type}`;
               
                // Auto-ocultar despu√©s de m√°s tiempo si hay botones
                const hideDelay = showButtons ? 8000 : 2000;
                setTimeout(() => {
                    if (this.savingIndicator) {
                        this.savingIndicator.classList.remove('show');
                    }
                }, hideDelay);
            }

            // === FUNCIONES PARA EDITAR OBSERVACIONES ===
            openObservationsEditor(observationsElement, transaction) {
                console.log('üîß Abriendo editor de observaciones para:', transaction.Referencia);
               
                if (this.activeObservationsEditor) {
                    this.closeObservationsEditor();
                    return;
                }
               
                const currentObservations = transaction.Observaciones || '';
               
                const editor = document.createElement('div');
                editor.className = 'observations-editor';
                editor.innerHTML = `
                    <textarea class="observations-input"
                              placeholder="Ingrese sus observaciones..."
                              rows="3">${currentObservations}</textarea>
                    <div class="observations-actions">
                        <button type="button" class="observations-btn cancel">Cancelar</button>
                        <button type="button" class="observations-btn save">Guardar</button>
                    </div>
                `;
               
                const parent = observationsElement.parentNode;
                parent.replaceChild(editor, observationsElement);
                this.activeObservationsEditor = editor;
               
                const textarea = editor.querySelector('.observations-input');
                setTimeout(() => {
                    textarea.focus();
                    textarea.setSelectionRange(textarea.value.length, textarea.value.length);
                }, 10);
               
                const saveBtn = editor.querySelector('.save');
                const cancelBtn = editor.querySelector('.cancel');
               
                saveBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const newObservations = textarea.value.trim();
                    this.updateTransactionObservations(transaction, newObservations);
                });
               
                cancelBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.closeObservationsEditor();
                    const currentQuery = this.searchInput.value.trim();
                    if (currentQuery || this.dateFilterActive || this.observationsFilter !== 'all') {
                        this.performSearch(currentQuery);
                    }
                });
               
                textarea.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') {
                        e.preventDefault();
                        const newObservations = textarea.value.trim();
                        this.updateTransactionObservations(transaction, newObservations);
                    }
                });
            }

            closeObservationsEditor() {
                if (this.activeObservationsEditor) {
                    this.activeObservationsEditor.remove();
                    this.activeObservationsEditor = null;
                }
            }

            updateTransactionInArrays(updatedTransaction) {
                const allIndex = this.allTransactions.findIndex(t => t.Referencia === updatedTransaction.Referencia);
                if (allIndex !== -1) {
                    this.allTransactions[allIndex] = updatedTransaction;
                }
               
                if (updatedTransaction.banco === 'BAC') {
                    const bacIndex = this.bacTransactions.findIndex(t => t.Referencia === updatedTransaction.Referencia);
                    if (bacIndex !== -1) {
                        this.bacTransactions[bacIndex] = updatedTransaction;
                    }
                } else if (updatedTransaction.banco === 'BN') {
                    const bnIndex = this.bnTransactions.findIndex(t => t.Referencia === updatedTransaction.Referencia);
                    if (bnIndex !== -1) {
                        this.bnTransactions[bnIndex] = updatedTransaction;
                    }
                } else if (updatedTransaction.banco === 'HuberBN') {
                    const huberBNIndex = this.huberBNTransactions.findIndex(t => t.Referencia === updatedTransaction.Referencia);
                    if (huberBNIndex !== -1) {
                        this.huberBNTransactions[huberBNIndex] = updatedTransaction;
                    }
                } else if (updatedTransaction.banco === 'AutosubastasBAC') {
                    const autosubastasIndex = this.autosubastasTransactions.findIndex(t => t.Referencia === updatedTransaction.Referencia);
                    if (autosubastasIndex !== -1) {
                        this.autosubastasTransactions[autosubastasIndex] = updatedTransaction;
                    }
                } else if (updatedTransaction.banco === 'AutosubastasBN') {
                    const autosubastasBNIndex = this.autosubastasBNTransactions.findIndex(t => t.Referencia === updatedTransaction.Referencia);
                    if (autosubastasBNIndex !== -1) {
                        this.autosubastasBNTransactions[autosubastasBNIndex] = updatedTransaction;
                    }
                }
            }

            // === FUNCI√ìN PARA COPIAR TRANSACCI√ìN ===
            async copyTransaction(transaction, buttonElement) {
                console.log('üìã Copiando transacci√≥n:', transaction.Referencia);
               
                let bankName;
                if (transaction.banco === 'BAC') {
                    bankName = 'BAC San Jos√©';
                } else if (transaction.banco === 'BN') {
                    bankName = 'Banco Nacional';
                } else if (transaction.banco === 'HuberBN') {
                    bankName = 'Huber BN';
                } else if (transaction.banco === 'AutosubastasBAC') {
                    bankName = 'Autosubastas BAC';
                } else if (transaction.banco === 'AutosubastasBN') {
                    bankName = 'Autosubastas BN';
                }
               
                const amount = this.formatAmount(transaction.Cr√©ditos);
                const observations = transaction.Observaciones || 'Sin observaciones';
               
                const singleLineText = `${bankName} | ${transaction.Fecha || 'N/A'} | Ref: ${transaction.Referencia} | ${amount} | ${transaction.Descripci√≥n || 'Sin descripci√≥n'} | Obs: ${observations}`;
               
                try {
                    await navigator.clipboard.writeText(singleLineText);
                   
                    const originalText = buttonElement.innerHTML;
                    buttonElement.innerHTML = '‚úì';
                    buttonElement.classList.add('copied');
                   
                    this.showSavingIndicator('‚úÖ Copiado al portapapeles', 'success');
                   
                    setTimeout(() => {
                        buttonElement.innerHTML = originalText;
                        buttonElement.classList.remove('copied');
                    }, 1500);
                   
                } catch (error) {
                    const textArea = document.createElement('textarea');
                    textArea.value = singleLineText;
                    document.body.appendChild(textArea);
                    textArea.select();
                   
                    try {
                        document.execCommand('copy');
                        this.showSavingIndicator('‚úÖ Copiado al portapapeles', 'success');
                       
                        const originalText = buttonElement.innerHTML;
                        buttonElement.innerHTML = '‚úì';
                        buttonElement.classList.add('copied');
                       
                        setTimeout(() => {
                            buttonElement.innerHTML = originalText;
                            buttonElement.classList.remove('copied');
                        }, 1500);
                       
                    } catch (fallbackError) {
                        this.showSavingIndicator('‚ùå Error al copiar', 'error');
                    }
                   
                    document.body.removeChild(textArea);
                }
            }

            // === FUNCI√ìN PARA COMPARTIR POR WHATSAPP ===
            shareTransaction(transaction) {
                let bankName, bankIcon;
                if (transaction.banco === 'BAC') {
                    bankName = 'BAC San Jos√©';
                    bankIcon = 'üîµ';
                } else if (transaction.banco === 'BN') {
                    bankName = 'Banco Nacional';
                    bankIcon = 'üü¢';
                } else if (transaction.banco === 'HuberBN') {
                    bankName = 'Huber BN';
                    bankIcon = 'üü°';
                } else if (transaction.banco === 'AutosubastasBAC') {
                    bankName = 'Autosubastas BAC';
                    bankIcon = 'üü†';
                } else if (transaction.banco === 'AutosubastasBN') {
                    bankName = 'Autosubastas BN';
                    bankIcon = 'üü£';
                }
               
                const amount = this.formatAmount(transaction.Cr√©ditos);
                const observations = transaction.Observaciones || 'Sin observaciones';
               
                const message = `*üí≥ TRANSACCI√ìN BANCARIA*

${bankIcon} *Banco:* ${bankName}
üìÖ *Fecha:* ${transaction.Fecha || 'N/A'}
üî¢ *Referencia:* ${transaction.Referencia}
üí∞ *Monto:* ${amount}

üìÑ *Descripci√≥n:*
${transaction.Descripci√≥n || 'Sin descripci√≥n'}

üí¨ *Observaciones:*
${observations}

---
_Enviado desde Sistema Inteligente de Transacciones_`;

                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
                window.open(whatsappUrl, '_blank');
            }

            addDashboardListeners() {
                // Listeners para estad√≠sticas de bancos
                const bankStats = document.querySelectorAll('.bank-stat');
                bankStats.forEach((stat, index) => {
                    stat.addEventListener('click', () => {
                        const banks = ['BAC', 'BN', 'HuberBN', 'AutosubastasBAC', 'AutosubastasBN'];
                        const selectedBank = banks[index];
                       
                        // Cambiar filtro de banco
                        this.handleBankChange(selectedBank);
                       
                        // Asegurar que el filtro de observaciones est√© en "without"
                        this.observationsFilter = 'without';
                        this.updateObservationsFilterUI();
                       
                        // Mostrar transacciones filtradas
                        this.performObservationsFilterOnly();
                       
                        // Scroll hacia abajo para ver resultados
                        setTimeout(() => {
                            const resultsSection = document.querySelector('.results-section');
                            if (resultsSection) {
                                resultsSection.scrollIntoView({ behavior: 'smooth' });
                            }
                        }, 100);
                    });
                   
                    // Agregar cursor pointer
                    stat.style.cursor = 'pointer';
                    stat.title = `Ver transacciones pendientes de este banco`;
                });

                // Listener para transacci√≥n m√°s antigua
                const olderTransaction = this.oldestTransaction;
                if (olderTransaction) {
                    olderTransaction.addEventListener('click', () => {
                        if (this.oldestRef && this.oldestRef.textContent) {
                            const ref = this.oldestRef.textContent.replace('Ref: ', '');
                            this.searchInput.value = ref;
                            this.performSearch(ref);
                           
                            // Scroll hacia abajo para ver resultados
                            setTimeout(() => {
                                const resultsSection = document.querySelector('.results-section');
                                if (resultsSection) {
                                    resultsSection.scrollIntoView({ behavior: 'smooth' });
                                }
                            }, 100);
                        }
                    });
                   
                    olderTransaction.style.cursor = 'pointer';
                    olderTransaction.title = 'Buscar esta transacci√≥n';
                }
            }

            // === EVENTOS DE ORDENAMIENTO ===
            addSortingListeners() {
                // Note: Los listeners se agregan din√°micamente cuando se crean los headers
                // en la funci√≥n updateTableHeaders()
            }

            // === FUNCIONES DE ORDENAMIENTO ===
            handleColumnSort(column) {
                console.log(`üîÑ Ordenando por columna: ${column}`);
               
                // Determinar nueva direcci√≥n de ordenamiento
                if (this.currentSort.column === column) {
                    // Misma columna: alternar direcci√≥n
                    if (this.currentSort.direction === 'asc') {
                        this.currentSort.direction = 'desc';
                    } else if (this.currentSort.direction === 'desc') {
                        this.currentSort.direction = null; // Quitar ordenamiento
                        this.currentSort.column = null;
                    } else {
                        this.currentSort.direction = 'asc';
                    }
                } else {
                    // Nueva columna: empezar con ascendente
                    this.currentSort.column = column;
                    this.currentSort.direction = 'asc';
                }

                console.log(`üìä Ordenamiento actual:`, this.currentSort);

                // Actualizar indicadores visuales
                this.updateSortIndicators();

                // Re-ejecutar la b√∫squeda actual para aplicar el ordenamiento
                const currentQuery = this.searchInput.value.trim();
                if (currentQuery || this.dateFilterActive || this.observationsFilter !== 'all') {
                    this.performSearch(currentQuery);
                } else {
                    this.performObservationsFilterOnly();
                }
            }

            updateSortIndicators() {
                // Actualizar todos los indicadores de ordenamiento
                const headers = document.querySelectorAll('.sortable-header');
                headers.forEach(header => {
                    const column = header.getAttribute('data-sort-column');
                    const indicator = header.querySelector('.sort-indicator');
                   
                    if (indicator) {
                        if (column === this.currentSort.column) {
                            indicator.classList.add('active');
                            indicator.classList.remove('asc', 'desc');
                            if (this.currentSort.direction) {
                                indicator.classList.add(this.currentSort.direction);
                            }
                        } else {
                            indicator.classList.remove('active', 'asc', 'desc');
                        }
                    }
                });
            }

            sortTransactions(transactions) {
                if (!this.currentSort.column || !this.currentSort.direction) {
                    // Sin ordenamiento: mantener orden original (no ordenar por sugerencias)
                    return this.sortResultsBySuggestionConfidence(transactions);
                }

                console.log(`üîÑ Aplicando ordenamiento: ${this.currentSort.column} ${this.currentSort.direction}`);

                const sorted = [...transactions].sort((a, b) => {
                    let valueA, valueB;

                    switch (this.currentSort.column) {
                        case 'fecha':
                            valueA = this.parseTransactionDate(a.Fecha) || new Date(0);
                            valueB = this.parseTransactionDate(b.Fecha) || new Date(0);
                            break;
                       
                        case 'referencia':
                            valueA = (a.Referencia || '').toString().toLowerCase();
                            valueB = (b.Referencia || '').toString().toLowerCase();
                            break;
                       
                        case 'descripcion':
                            valueA = (a.Descripci√≥n || '').toString().toLowerCase();
                            valueB = (b.Descripci√≥n || '').toString().toLowerCase();
                            break;
                       
                        case 'monto':
                            valueA = this.parseAmount(a.Cr√©ditos || '0');
                            valueB = this.parseAmount(b.Cr√©ditos || '0');
                            break;
                       
                        case 'observaciones':
                            valueA = (a.Observaciones || '').toString().toLowerCase();
                            valueB = (b.Observaciones || '').toString().toLowerCase();
                            break;
                       
                        default:
                            return 0;
                    }

                    // Comparar valores
                    let comparison = 0;
                    if (valueA < valueB) {
                        comparison = -1;
                    } else if (valueA > valueB) {
                        comparison = 1;
                    }

                    // Aplicar direcci√≥n de ordenamiento
                    return this.currentSort.direction === 'desc' ? -comparison : comparison;
                });

                console.log(`‚úÖ Transacciones ordenadas: ${sorted.length} elementos`);
                return sorted;
            }

            updateTableHeaders() {
                // Solo crear headers en vista desktop
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    return; // En mobile no se muestran headers
                }

                // Crear headers din√°micamente con eventos de ordenamiento
                const tableContainer = document.getElementById('tableContainer');
                const existingHeader = tableContainer.querySelector('.table-header');
               
                if (existingHeader) {
                    existingHeader.remove();
                }

                const headerElement = document.createElement('div');
                headerElement.className = 'table-header';
                headerElement.innerHTML = `
                    <div class="sortable-header" data-sort-column="fecha" title="Clic para ordenar por fecha">
                        <span>Fecha</span>
                        <span class="sort-indicator ${this.currentSort.column === 'fecha' ? 'active ' + (this.currentSort.direction || '') : ''}"></span>
                    </div>
                    <div class="sortable-header" data-sort-column="referencia" title="Clic para ordenar por referencia">
                        <span>Referencia</span>
                        <span class="sort-indicator ${this.currentSort.column === 'referencia' ? 'active ' + (this.currentSort.direction || '') : ''}"></span>
                    </div>
                    <div class="sortable-header" data-sort-column="descripcion" title="Clic para ordenar por descripci√≥n">
                        <span>Descripci√≥n</span>
                        <span class="sort-indicator ${this.currentSort.column === 'descripcion' ? 'active ' + (this.currentSort.direction || '') : ''}"></span>
                    </div>
                    <div class="sortable-header" data-sort-column="monto" title="Clic para ordenar por monto">
                        <span>Monto</span>
                        <span class="sort-indicator ${this.currentSort.column === 'monto' ? 'active ' + (this.currentSort.direction || '') : ''}"></span>
                    </div>
                    <div class="sortable-header" data-sort-column="observaciones" title="Clic para ordenar por observaciones">
                        <span>Observaciones / Sugerencias</span>
                        <span class="sort-indicator ${this.currentSort.column === 'observaciones' ? 'active ' + (this.currentSort.direction || '') : ''}"></span>
                    </div>
                `;

                // Insertar el header al principio del contenedor
                const resultsContainer = document.getElementById('resultsContainer');
                tableContainer.insertBefore(headerElement, resultsContainer);

                // Agregar event listeners a los headers
                const sortableHeaders = headerElement.querySelectorAll('.sortable-header');
                sortableHeaders.forEach(header => {
                    header.addEventListener('click', () => {
                        const column = header.getAttribute('data-sort-column');
                        this.handleColumnSort(column);
                    });
                });

                console.log('‚úÖ Headers de tabla actualizados con eventos de ordenamiento');
            }

            // === NUEVA FUNCI√ìN: IR A TRANSACCIONES PENDIENTES ===
            goToPendingTransactions() {
                console.log('üìù Navegando a transacciones pendientes...');
               
                // Limpiar b√∫squeda
                this.searchInput.value = '';
               
                // Limpiar filtro de fecha
                this.dateFilterActive = false;
                this.dateFromFilter = null;
                this.dateToFilter = null;
                this.dateFromInput.value = '';
                this.dateToInput.value = '';
                this.updateDateFilterUI();
               
                // Cambiar a filtro de banco "all"
                this.currentBank = 'all';
                this.bankButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.bank === 'all');
                });
               
                // Cambiar a filtro "Sin Obs."
                this.observationsFilter = 'without';
                this.updateObservationsFilterUI();
               
                // Limpiar ordenamiento
                this.currentSort = {
                    column: null,
                    direction: null
                };
               
                // Mostrar transacciones pendientes
                this.performObservationsFilterOnly();
               
                // Scroll hacia arriba para ver resultados
                setTimeout(() => {
                    const resultsSection = document.querySelector('.results-section');
                    if (resultsSection) {
                        resultsSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }, 100);
               
                this.showSavingIndicator('üìù Mostrando transacciones pendientes', 'success');
            }

            // === NUEVA FUNCI√ìN: COPIAR TODAS LAS TRANSACCIONES MOSTRADAS ===
            async copyAllDisplayedTransactions() {
                console.log('üìã Copiando todas las transacciones mostradas...');
               
                // Obtener todas las transacciones mostradas
                const transactionRows = document.querySelectorAll('.transaction-row');
                if (transactionRows.length === 0) {
                    this.showSavingIndicator('‚ùå No hay transacciones para copiar', 'error');
                    return;
                }
               
                // Crear texto de todas las transacciones
                const allTransactionsText = [];
               
                // Buscar las transacciones correspondientes en los resultados actuales
                const currentResults = this.getLastDisplayedResults();
               
                if (!currentResults || currentResults.length === 0) {
                    this.showSavingIndicator('‚ùå No se pudieron obtener las transacciones', 'error');
                    return;
                }
               
                currentResults.forEach((transaction, index) => {
                    let bankName;
                    switch (transaction.banco) {
                        case 'BAC':
                            bankName = 'BAC San Jos√©';
                            break;
                        case 'BN':
                            bankName = 'Banco Nacional';
                            break;
                        case 'HuberBN':
                            bankName = 'Huber BN';
                            break;
                        case 'AutosubastasBAC':
                            bankName = 'Autosubastas BAC';
                            break;
                        case 'AutosubastasBN':
                            bankName = 'Autosubastas BN';
                            break;
                        default:
                            bankName = transaction.banco;
                    }
                   
                    const amount = this.formatAmount(transaction.Cr√©ditos);
                    const observations = transaction.Observaciones || 'Sin observaciones';
                   
                    const lineText = `${bankName} | ${transaction.Fecha || 'N/A'} | Ref: ${transaction.Referencia} | ${amount} | ${transaction.Descripci√≥n || 'Sin descripci√≥n'} | Obs: ${observations}`;
                    allTransactionsText.push(lineText);
                });
               
                const finalText = allTransactionsText.join('\n');
               
                try {
                    await navigator.clipboard.writeText(finalText);
                    this.showSavingIndicator(`‚úÖ ${currentResults.length} transacciones copiadas al portapapeles`, 'success');
                } catch (error) {
                    // Fallback para navegadores que no soportan clipboard API
                    const textArea = document.createElement('textarea');
                    textArea.value = finalText;
                    document.body.appendChild(textArea);
                    textArea.select();
                   
                    try {
                        document.execCommand('copy');
                        this.showSavingIndicator(`‚úÖ ${currentResults.length} transacciones copiadas al portapapeles`, 'success');
                    } catch (fallbackError) {
                        this.showSavingIndicator('‚ùå Error al copiar transacciones', 'error');
                    }
                   
                    document.body.removeChild(textArea);
                }
            }

            // === FUNCI√ìN AUXILIAR: OBTENER RESULTADOS MOSTRADOS ACTUALMENTE ===
            getLastDisplayedResults() {
                // Esto mantendr√° una referencia a los √∫ltimos resultados mostrados
                return this.lastDisplayedResults || [];
            }
            debugSuggestions() {
                console.log('üîç DEBUG DE SUGERENCIAS IA AVANZADO');
                console.log('=====================================');
                console.log(`üìä Total transacciones: ${this.allTransactions.length}`);
                console.log(`‚úÖ Transacciones conciliadas: ${this.conciliatedTransactions.length}`);
                console.log(`‚ùå Transacciones sin conciliar (desde 10/07/2025): ${this.unconciledTransactions.length}`);
                console.log(`üöó Placas de flota cargadas: ${this.placasFlota.length}`);
                console.log(`üß† Sugerencias generadas: ${this.aiSuggestions.size}`);
                console.log('');
               
                if (this.placasFlota.length > 0) {
                    console.log('üöó Primeras 10 placas de flota:', this.placasFlota.slice(0, 10));
                    console.log('');
                }
               
                // === NUEVO: DEBUG ESPEC√çFICO DE DETECCI√ìN DE PLACAS ===
                console.log('üîç AN√ÅLISIS DE DETECCI√ìN DE PLACAS:');
                console.log('====================================');
               
                const sampleTransactions = this.unconciledTransactions.slice(0, 10);
                sampleTransactions.forEach((tx, i) => {
                    const placasDetectadas = this.detectPlacasInText(tx.Descripci√≥n);
                    console.log(`${i + 1}. "${tx.Descripci√≥n}"`);
                    console.log(`   üìã Ref: ${tx.Referencia} | üí∞ ${this.formatAmount(tx.Cr√©ditos)}`);
                    if (placasDetectadas.length > 0) {
                        placasDetectadas.forEach(placa => {
                            const estado = placa.tipoCoincidencia === 'exacta' ? '‚úÖ EN FLOTA' :
                                          placa.tipoCoincidencia === 'parcial' ? '‚ö†Ô∏è PARCIAL FLOTA' :
                                          placa.tipoCoincidencia === 'formato' ? 'üìù SIMILAR FLOTA' :
                                          placa.tipoCoincidencia === 'detectada' ? 'üîç SOLO DETECTADA' : '‚ùì UNKNOWN';
                            console.log(`   üöó ${placa.placa} | ${estado} | Confianza: ${Math.round(placa.confianza * 100)}%`);
                        });
                    } else {
                        console.log(`   ‚ùå No se detectaron placas`);
                    }
                    console.log('');
                });
                console.log('');
               
                if (this.aiSuggestions.size > 0) {
                    console.log('üìã Lista de sugerencias (ordenadas por confianza):');
                    const sortedSuggestions = Array.from(this.aiSuggestions.entries())
                        .sort(([,a], [,b]) => b.confidence - a.confidence);
                   
                    sortedSuggestions.forEach(([ref, suggestion], index) => {
                        const tx = suggestion.transaction;
                        const topMatch = suggestion.suggestions[0];
                       
                        console.log(`${index + 1}. ${ref} (${suggestion.confidence}%)`);
                        console.log(`   üìÑ Descripci√≥n: "${tx.Descripci√≥n}"`);
                        console.log(`   üí∞ Monto: ${this.formatAmount(tx.Cr√©ditos)}`);
                        console.log(`   üí° Sugerencia: "${topMatch.suggestedObservation}"`);
                        console.log(`   üéØ Similitud total: ${Math.round(topMatch.totalSimilarity * 100)}%`);
                       
                        if (topMatch.matchFactors && topMatch.matchFactors.length > 0) {
                            console.log(`   üîç Identificadores √∫nicos: ${topMatch.matchFactors.join(', ')}`);
                        }
                       
                        if (topMatch.nameSimilarity >= 0.9) {
                            console.log(`   üë§ Similitud nombres: ${Math.round(topMatch.nameSimilarity * 100)}%`);
                        }
                       
                        if (topMatch.placaSimilarity >= 0.8) {
                            console.log(`   üöó Placa match: ${JSON.stringify(topMatch.placaMatchInfo?.matchType || 'N/A')}`);
                        }
                       
                        if (topMatch.referenceSimilarity >= 0.9) {
                            console.log(`   üî¢ N√∫mero √∫nico coincidente`);
                        }
                       
                        if (topMatch.codeSimilarity >= 0.9) {
                            console.log(`   üè∑Ô∏è C√≥digo espec√≠fico coincidente`);
                        }
                       
                        console.log('');
                    });
                } else {
                    console.log('‚ö†Ô∏è No se generaron sugerencias. Verificando...');
                    console.log(`Fecha de corte: ${this.cutoffDate.toLocaleDateString()}`);
                   
                    // Mostrar algunas transacciones de ejemplo
                    console.log('üìã Primeras 5 transacciones sin conciliar:');
                    this.unconciledTransactions.slice(0, 5).forEach((tx, i) => {
                        const txDate = this.parseTransactionDate(tx.Fecha);
                        const placas = this.detectPlacasInText(tx.Descripci√≥n);
                        const placasStr = placas.length > 0 ? ` [üöó ${placas.map(p => p.placa).join(', ')}]` : '';
                        console.log(`${i + 1}. ${tx.Referencia} - ${tx.Descripci√≥n} (${this.formatAmount(tx.Cr√©ditos)}) - ${txDate ? txDate.toLocaleDateString() : 'Fecha inv√°lida'}${placasStr}`);
                    });
                }
               
                alert(`üîç DEBUG INFO AVANZADO:\n\nüìä ${this.allTransactions.length} transacciones totales\n‚úÖ ${this.conciliatedTransactions.length} conciliadas\n‚ùå ${this.unconciledTransactions.length} sin conciliar\nüöó ${this.placasFlota.length} placas de flota\nüß† ${this.aiSuggestions.size} sugerencias\nüì± WhatsApp configurado\nüîç Detecci√≥n de placas mejorada\nüìä Ordenamiento por columnas\nüîÑ B√∫squeda autom√°tica despu√©s de conciliar\nüìù Navegaci√≥n f√°cil a pendientes (3 opciones)\nüìã Copia m√∫ltiple de transacciones\n\nVer consola (F12) para an√°lisis detallado de placas`);
            }

            // === FUNCI√ìN PARA EXPORTAR OBSERVACIONES ===
            exportObservations() {
                const withObservations = this.allTransactions.filter(t => t.Observaciones && t.Observaciones.trim() !== '');
               
                if (withObservations.length === 0) {
                    alert('üìù No hay observaciones para exportar.\n\nAgrega algunas observaciones primero haciendo clic en las celdas de la columna "Observaciones".');
                    return;
                }
               
                const csvHeader = 'Fecha,Referencia,Descripci√≥n,Monto,Banco,Observaciones\n';
                const csvRows = withObservations.map(t => {
                    const cleanText = (text) => `"${(text || '').replace(/"/g, '""')}"`;
                    return [
                        cleanText(t.Fecha),
                        cleanText(t.Referencia),
                        cleanText(t.Descripci√≥n),
                        cleanText(t.Cr√©ditos),
                        cleanText(t.banco),
                        cleanText(t.Observaciones)
                    ].join(',');
                }).join('\n');
               
                const csvContent = csvHeader + csvRows;
               
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `observaciones_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
               
                alert(`‚úÖ Exportadas ${withObservations.length} observaciones con √©xito!\n\nEl archivo se descarg√≥ como CSV.`);
            }

            // === FUNCI√ìN MEJORADA PARA B√öSQUEDA POR MONTO ===
            matchesAmount(transaction, searchTerm) {
                const creditos = transaction.Cr√©ditos || '';
                if (!creditos || !searchTerm) return false;
               
                const terminoBusqueda = searchTerm.toString().replace(/\./g, '').replace(/,/g, '');
                const montoNumerico = this.parseAmount(creditos);
                const numeroTermino = parseFloat(terminoBusqueda);
               
                if (isNaN(numeroTermino)) return false;
               
                return (
                    montoNumerico === numeroTermino ||
                    montoNumerico === (numeroTermino / 100) ||
                    (montoNumerico * 100) === numeroTermino ||
                    creditos.toString().replace(/\./g, '').replace(/,/g, '') === terminoBusqueda
                );
            }

            handleSearch(query) {
                if (this.searchTimeout) {
                    clearTimeout(this.searchTimeout);
                }

                if (!query && !this.dateFilterActive && this.observationsFilter === 'all') {
                    this.showInitialState();
                    return;
                }

                this.searchTimeout = setTimeout(() => {
                    this.performSearch(query);
                }, 300);
            }

            performSearch(query) {
                try {
                    console.log(`üîç Buscando: "${query}" ${this.dateFilterActive ? '(con filtro de fecha)' : ''} ${this.observationsFilter !== 'all' ? '(con filtro de observaciones)' : ''}`);
                   
                    const searchTerm = query.toLowerCase();
                   
                    let transactionsToSearch = this.getFilteredTransactionsByBank();

                    if (this.dateFilterActive) {
                        transactionsToSearch = this.applyDateFilterToTransactions(transactionsToSearch);
                    }

                    if (this.observationsFilter !== 'all') {
                        transactionsToSearch = this.applyObservationsFilter(transactionsToSearch);
                    }
                   
                    let results = transactionsToSearch;

                    if (query && query.trim() !== '') {
                        results = transactionsToSearch.filter(transaction => {
                            const referencia = (transaction.Referencia || '').toString().toLowerCase();
                            const descripcion = (transaction.Descripci√≥n || '').toString().toLowerCase();
                            const codigo = (transaction.C√≥digo || '').toString().toLowerCase();
                            const fecha = (transaction.Fecha || '').toString().toLowerCase();
                            const observaciones = (transaction.Observaciones || '').toString().toLowerCase();
                           
                            const matchesText =
                                referencia.includes(searchTerm) ||
                                descripcion.includes(searchTerm) ||
                                codigo.includes(searchTerm) ||
                                fecha.includes(searchTerm) ||
                                observaciones.includes(searchTerm);
                           
                            const matchesAmountImproved = this.matchesAmount(transaction, query);
                           
                            return matchesText || matchesAmountImproved;
                        });
                    }
                   
                    results = this.applyCurrentFilter(results);
                   
                    // Ordenar resultados por fecha y monto
                    this.sortTransactionsByDateAndAmount(results);
                   
                    this.displayResults(results, query);
                   
                } catch (error) {
                    console.error('Error en b√∫squeda:', error);
                    this.showError(`Error durante la b√∫squeda: ${error.message}`);
                }
            }

            applyCurrentFilter(transactions) {
                return transactions;
            }

            handleFilterChange(filter) {
                this.currentFilter = filter;
               
                this.filterButtons.forEach(btn => {
                    if (btn.dataset.filter) {
                        btn.classList.toggle('active', btn.dataset.filter === filter);
                    }
                });

                const currentQuery = this.searchInput.value.trim();
                if (currentQuery || this.dateFilterActive || this.observationsFilter !== 'all') {
                    this.performSearch(currentQuery);
                }
            }

            handleBankChange(bank) {
                this.currentBank = bank;
               
                this.bankButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.bank === bank);
                });

                const currentQuery = this.searchInput.value.trim();
                if (currentQuery || this.dateFilterActive || this.observationsFilter !== 'all') {
                    this.performSearch(currentQuery);
                } else {
                    this.showInitialState();
                }
            }

            getFilteredTransactionsByBank() {
                switch (this.currentBank) {
                    case 'BAC':
                        return this.bacTransactions;
                    case 'BN':
                        return this.bnTransactions;
                    case 'HuberBN':
                        return this.huberBNTransactions;
                    case 'AutosubastasBAC':
                        return this.autosubastasTransactions;
                    case 'AutosubastasBN':
                        return this.autosubastasBNTransactions;
                    default:
                        return this.allTransactions;
                }
            }

            displayResults(results, query) {
                this.hideAllStates();
               
                if (results.length === 0) {
                    this.showNoResults();
                    return;
                }

                // APLICAR ORDENAMIENTO
                const sortedResults = this.sortTransactions(results);

                // Guardar referencia a los resultados mostrados para las funciones de copia
                this.lastDisplayedResults = sortedResults;

                this.showResultsInfo(sortedResults.length, query);
                this.renderTransactionRows(sortedResults, query);
                this.tableContainer.style.display = 'block';
               
                // Actualizar headers con eventos de ordenamiento
                this.updateTableHeaders();
            }

            sortResultsBySuggestionConfidence(transactions) {
                // NO ordenar por sugerencias - mantener el orden original
                // Esto evita que las transacciones se muevan cuando se generan sugerencias
                console.log(`üìä Manteniendo orden original: ${transactions.length} transacciones`);
                return transactions;
            }

            renderTransactionRows(results, query) {
                const isMobile = window.innerWidth <= 768;
               
                this.resultsContainer.innerHTML = results.map((transaction, index) => {
                    if (isMobile) {
                        return this.createMobileTransactionRow(transaction, query, index);
                    } else {
                        return this.createDesktopTransactionRow(transaction, query, index);
                    }
                }).join('');
               
                this.addObservationListeners(results);
                this.addShareListeners(results);
                this.addCopyListeners(results);
                this.addSuggestionListeners(results);
            }

            addObservationListeners(transactions) {
                transactions.forEach((transaction, index) => {
                    const observationElement = document.querySelector(`[data-obs-index="${index}"]`);
                    if (observationElement) {
                        observationElement.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            this.openObservationsEditor(observationElement, transaction);
                        });
                    }
                });
            }

            addShareListeners(transactions) {
                transactions.forEach((transaction, index) => {
                    const shareButton = document.querySelector(`[data-share-index="${index}"]`);
                    if (shareButton) {
                        shareButton.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            this.shareTransaction(transaction);
                        });
                    }
                });
            }

            addSuggestionListeners(transactions) {
                // Listeners para botones de sugerencias existentes
                document.querySelectorAll('.suggestion-indicator').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const ref = btn.getAttribute('data-suggestion-ref');
                        this.toggleSuggestionTooltip(ref);
                    });
                });

                // Listeners para botones de sugerencias por demanda
                document.querySelectorAll('.suggestions-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const transactionRef = btn.getAttribute('data-transaction-ref');
                        this.generateSuggestionsForTransaction(transactionRef);
                    });
                });
            }

            addCopyListeners(transactions) {
                transactions.forEach((transaction, index) => {
                    const copyButton = document.querySelector(`[data-copy-index="${index}"]`);
                    if (copyButton) {
                        copyButton.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            this.copyTransaction(transaction, copyButton);
                        });
                    }
                });
            }



            createDesktopTransactionRow(transaction, query, index) {
                const highlightText = (text, query) => {
                    if (!text || !query) return text || '';
                    const regex = new RegExp(`(${query})`, 'gi');
                    return text.replace(regex, '<mark>$1</mark>');
                };

                let bankIcon, bankColor;
                if (transaction.banco === 'BAC') {
                    bankIcon = 'üîµ';
                    bankColor = '#007aff';
                } else if (transaction.banco === 'BN') {
                    bankIcon = 'üü¢';
                    bankColor = '#30d158';
                } else if (transaction.banco === 'HuberBN') {
                    bankIcon = 'üü°';
                    bankColor = '#ffcc00';
                } else if (transaction.banco === 'AutosubastasBAC') {
                    bankIcon = 'üü†';
                    bankColor = '#ff9500';
                } else if (transaction.banco === 'AutosubastasBN') {
                    bankIcon = 'üü£';
                    bankColor = '#af52de';
                }
               
                const observaciones = transaction.Observaciones || '';
                const observationsDisplay = observaciones ?
                    highlightText(observaciones, query) :
                    'Agregar observaciones...';
                const observationsClass = observaciones ? '' : 'empty';
               
                // Verificar si hay sugerencia de IA
                const hasSuggestion = this.aiSuggestions.has(transaction.Referencia);
                const suggestionClass = hasSuggestion ? 'has-suggestion' : '';
                const suggestionIndicator = hasSuggestion ? this.createSuggestionIndicator(transaction, index) : '';
                
                // Bot√≥n de sugerencias por demanda (solo para transacciones sin observaciones)
                const suggestionsButton = !observaciones ? `
                    <button class="suggestions-btn"
                            data-suggestions-index="${index}"
                            data-transaction-ref="${transaction.Referencia}"
                            title="üí° Generar sugerencias de IA para esta transacci√≥n"
                            style="background: linear-gradient(135deg, #007aff, #0056cc); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; margin-left: 8px; transition: all 0.2s;">
                        üí° Sugerencias
                    </button>
                ` : '';
               
                return `
                    <div class="transaction-row">
                        <button class="copy-btn"
                                data-copy-index="${index}"
                                title="Copiar en una l√≠nea">
                            üìã
                        </button>
                                                    <button class="share-btn"
                                    data-share-index="${index}"
                                    title="Compartir por WhatsApp">
                                üì±
                            </button>
                        <div class="cell cell-date">${transaction.Fecha || 'N/A'}</div>
                        <div class="cell cell-reference">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="color: ${bankColor}; font-size: 12px;">${bankIcon}</span>
                                ${highlightText(transaction.Referencia, query)}
                            </div>
                        </div>
                        <div class="cell cell-description">${highlightText(transaction.Descripci√≥n, query)}</div>
                        <div class="cell cell-amount">${this.formatAmount(transaction.Cr√©ditos)}</div>
                        <div class="cell">
                            <div class="observations-container">
                                <div class="cell-observations ${observationsClass} ${suggestionClass}"
                                     data-obs-index="${index}"
                                     title="Haga clic para editar observaciones">
                                    ${observationsDisplay}
                                </div>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    ${suggestionIndicator}
                                    ${suggestionsButton}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            createMobileTransactionRow(transaction, query, index) {
                const highlightText = (text, query) => {
                    if (!text || !query) return text || '';
                    const regex = new RegExp(`(${query})`, 'gi');
                    return text.replace(regex, '<mark>$1</mark>');
                };

                const codeClass = transaction.C√≥digo === 'TS' ? 'code-ts' : 'code-tf';
               
                let bankIcon, bankName;
                if (transaction.banco === 'BAC') {
                    bankIcon = 'üîµ';
                    bankName = 'BAC';
                } else if (transaction.banco === 'BN') {
                    bankIcon = 'üü¢';
                    bankName = 'BN';
                } else if (transaction.banco === 'HuberBN') {
                    bankIcon = 'üü°';
                    bankName = 'HuberBN';
                } else if (transaction.banco === 'AutosubastasBAC') {
                    bankIcon = 'üü†';
                    bankName = 'AutosubastasBAC';
                } else if (transaction.banco === 'AutosubastasBN') {
                    bankIcon = 'üü£';
                    bankName = 'AutosubastasBN';
                }
               
                const observaciones = transaction.Observaciones || '';
                const observationsDisplay = observaciones ?
                    highlightText(observaciones, query) :
                    'Agregar observaciones...';
                const observationsClass = observaciones ? '' : 'empty';
               
                // Verificar si hay sugerencia de IA
                const hasSuggestion = this.aiSuggestions.has(transaction.Referencia);
                const suggestionClass = hasSuggestion ? 'has-suggestion' : '';
                const suggestionIndicator = hasSuggestion ? this.createSuggestionIndicator(transaction, index) : '';
               
                return `
                    <div class="transaction-row" style="position: relative;">
                                                    <button class="copy-btn"
                                    data-copy-index="${index}"
                                    title="Copiar en una l√≠nea"
                                    style="right: 88px;">
                                üìã
                            </button>
                                                    <button class="share-btn"
                                    data-share-index="${index}"
                                    title="Compartir por WhatsApp"
                                    style="right: 60px;">
                                üì±
                            </button>
                        <div class="mobile-row">
                            <div class="mobile-header">
                                <div class="mobile-bank-date">
                                    <span class="mobile-bank-icon">${bankIcon}</span>
                                    <div class="cell-date">${transaction.Fecha || 'N/A'}</div>
                                </div>
                                <div class="mobile-amount-container">
                                    <div class="mobile-amount-label">Monto</div>
                                    <div class="mobile-amount">${this.formatAmount(transaction.Cr√©ditos)}</div>
                                </div>
                            </div>
                        </div>
                       
                        <div class="mobile-details">
                            <div class="mobile-detail">
                                <div class="mobile-label">Banco</div>
                                <div>${bankName}</div>
                            </div>
                            <div class="mobile-detail">
                                <div class="mobile-label">Referencia</div>
                                <div class="cell-reference">${highlightText(transaction.Referencia, query)}</div>
                            </div>
                            <div class="mobile-detail">
                                <div class="mobile-label">C√≥digo</div>
                                <span class="cell-code ${codeClass}">${transaction.C√≥digo || 'N/A'}</span>
                            </div>
                        </div>
                       
                        <div class="mobile-description">
                            ${highlightText(transaction.Descripci√≥n, query)}
                        </div>
                       
                        <div style="margin-top: 12px;">
                            <div class="mobile-label">Observaciones</div>
                            <div class="observations-container">
                                <div class="cell-observations ${observationsClass} ${suggestionClass}"
                                     data-obs-index="${index}"
                                     title="Haga clic para editar observaciones"
                                     style="margin-top: 4px;">
                                    ${observationsDisplay}
                                </div>
                                <div style="display: flex; align-items: center; gap: 4px; margin-top: 8px;">
                                    ${suggestionIndicator}
                                    ${!observaciones ? `
                                        <button class="suggestions-btn"
                                                data-suggestions-index="${index}"
                                                data-transaction-ref="${transaction.Referencia}"
                                                title="üí° Generar sugerencias de IA para esta transacci√≥n"
                                                style="background: linear-gradient(135deg, #007aff, #0056cc); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s;">
                                            üí° Sugerencias
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            showResultsInfo(count, query) {
                let bankInfo;
                switch (this.currentBank) {
                    case 'BAC':
                        bankInfo = 'BAC San Jos√©';
                        break;
                    case 'BN':
                        bankInfo = 'Banco Nacional';
                        break;
                    case 'HuberBN':
                        bankInfo = 'Huber BN';
                        break;
                    case 'AutosubastasBAC':
                        bankInfo = 'Autosubastas BAC';
                        break;
                    case 'AutosubastasBN':
                        bankInfo = 'Autosubastas BN';
                        break;
                    default:
                        bankInfo = 'todos los bancos';
                }
               
                let dateInfo = '';
                if (this.dateFilterActive) {
                    if (this.dateFromFilter && this.dateToFilter) {
                        dateInfo = ` entre ${this.formatDateForDisplay(this.dateFromFilter)} - ${this.formatDateForDisplay(this.dateToFilter)}`;
                    } else if (this.dateFromFilter) {
                        dateInfo = ` desde ${this.formatDateForDisplay(this.dateFromFilter)}`;
                    } else if (this.dateToFilter) {
                        dateInfo = ` hasta ${this.formatDateForDisplay(this.dateToFilter)}`;
                    }
                }

                let obsInfo = '';
                if (this.observationsFilter === 'without') {
                    obsInfo = ' (sin observaciones - pendientes)';
                } else if (this.observationsFilter === 'with') {
                    obsInfo = ' (con observaciones - conciliadas)';
                }

                // Agregar info de sugerencias de IA si hay
                const suggestionsInResults = count > 0 ?
                    Array.from(this.aiSuggestions.keys()).filter(ref =>
                        this.resultsContainer.textContent.includes(ref)
                    ).length : 0;

                let aiInfo = '';
                if (suggestionsInResults > 0) {
                    aiInfo = ` | üß† ${suggestionsInResults} con sugerencias IA`;
                }

                // Info de ordenamiento actual
                let sortInfo = '';
                if (this.currentSort.column && this.currentSort.direction) {
                    const sortColumnNames = {
                        'fecha': 'Fecha',
                        'referencia': 'Referencia',
                        'descripcion': 'Descripci√≥n',
                        'monto': 'Monto',
                        'observaciones': 'Observaciones'
                    };
                    const directionText = this.currentSort.direction === 'asc' ? '‚Üë' : '‚Üì';
                    sortInfo = ` | üìä Ordenado por ${sortColumnNames[this.currentSort.column]} ${directionText}`;
                }

                // Crear contenido principal
                const mainInfo = document.createElement('div');
                mainInfo.innerHTML = `
                    ${count} transacci√≥n${count !== 1 ? 'es' : ''} encontrada${count !== 1 ? 's' : ''}
                    ${query ? `para "${query}"` : ''}
                    en ${bankInfo}${dateInfo}${obsInfo}${aiInfo}${sortInfo}
                    ${this.currentFilter !== 'all' ? ' (filtrado)' : ''}
                    <small style="display: block; margin-top: 4px; color: #666; font-size: 12px;">
                        üí° Haz clic en los t√≠tulos de las columnas para ordenar
                    </small>
                `;

                // Detectar si se est√°n viendo transacciones conciliadas o hay una b√∫squeda espec√≠fica
                const showButtons = (this.observationsFilter === 'with') ||
                                  (query && query.trim() !== '') ||
                                  this.dateFilterActive;

                if (showButtons) {
                    // Crear contenedor de botones
                    const buttonsContainer = document.createElement('div');
                    buttonsContainer.className = 'results-info-buttons';

                    // Bot√≥n para ir a pendientes
                    const pendingButton = document.createElement('button');
                    pendingButton.className = 'results-info-btn pending';
                    pendingButton.textContent = 'üîÑ Ver Pendientes';
                    pendingButton.onclick = () => this.goToPendingTransactions();

                    // Bot√≥n para copiar todas las transacciones mostradas
                    const copyAllButton = document.createElement('button');
                    copyAllButton.className = 'results-info-btn copy';
                    copyAllButton.textContent = `üìã Copiar ${count === 1 ? 'Esta' : 'Todas'}`;
                    copyAllButton.onclick = () => this.copyAllDisplayedTransactions();

                    buttonsContainer.appendChild(pendingButton);
                    buttonsContainer.appendChild(copyAllButton);

                    // Limpiar y agregar contenido
                    this.resultsInfo.innerHTML = '';
                    this.resultsInfo.appendChild(mainInfo);
                    this.resultsInfo.appendChild(buttonsContainer);
                } else {
                    // Solo mostrar informaci√≥n sin botones
                    this.resultsInfo.innerHTML = '';
                    this.resultsInfo.appendChild(mainInfo);
                }

                this.resultsInfo.style.display = 'flex';
            }

            showLoading(show) {
                this.isLoading = show;
                this.loadingIndicator.style.display = show ? 'block' : 'none';
                if (show) this.hideAllStates();
            }

            showError(message) {
                this.errorMessage.innerHTML = `
                    <strong>‚ö†Ô∏è ${message}</strong><br>
                    <small>Presiona F12 ‚Üí Console para ver detalles t√©cnicos</small>
                `;
                this.errorMessage.style.display = 'block';
            }

            hideError() {
                this.errorMessage.style.display = 'none';
            }

            showNoResults() {
                this.noResults.style.display = 'block';
            }

            showInitialState() {
                this.hideAllStates();
               
                if (this.allTransactions.length > 0) {
                    const aiSuggestionsCount = this.aiSuggestions.size;
                    const pendingCount = this.unconciledTransactions.length;
                   
                    // Si hay transacciones pendientes y el filtro est√° en "without", no mostrar estado inicial
                    if (pendingCount > 0 && this.observationsFilter === 'without') {
                        return; // Las transacciones se mostrar√°n autom√°ticamente
                    }
                   
                    const aiInfo = aiSuggestionsCount > 0 ?
                        `<small style="color: #ff9500; margin-top: 10px; display: block;">
                            üß† ${aiSuggestionsCount} sugerencias IA generadas para transacciones sin conciliar
                        </small>` : '';

                    this.initialState.innerHTML = `
                        <div class="state-icon">üß†</div>
                        <div class="state-title">Sistema Inteligente Listo</div>
                        <div class="state-description">
                            Mostrando ${pendingCount} transacciones pendientes desde 10/07/2025<br>
                            <small style="color: #007aff; margin-top: 10px; display: block;">
                                üí° Haga clic en las estad√≠sticas para filtrar por banco
                            </small>
                            <small style="color: #2196f3; margin-top: 5px; display: block;">
                                üîç Use la b√∫squeda para encontrar transacciones espec√≠ficas
                            </small>
                            <small style="color: #ff9500; margin-top: 5px; display: block;">
                                üìä Haga clic en los t√≠tulos de columnas para ordenar
                            </small>
                            <small style="color: #30d158; margin-top: 5px; display: block;">
                                ‚úèÔ∏è Haga clic en observaciones para editarlas
                            </small>
                            <small style="color: #25d366; margin-top: 5px; display: block;">
                                üì± Las conciliaciones se env√≠an autom√°ticamente a WhatsApp
                            </small>
                            <small style="color: #e74c3c; margin-top: 5px; display: block;">
                                üîÑ Despu√©s de conciliar se busca autom√°ticamente la transacci√≥n
                            </small>
                            <small style="color: #ff9500; margin-top: 5px; display: block;">
                                üìù Use el bot√≥n "Pendientes" para volver a las sin conciliar
                            </small>
                            ${aiInfo}
                            <small style="color: #86868b; margin-top: 10px; display: block;">
                                üìä ${this.allTransactions.length} transacciones totales cargadas | üìÖ Filtro autom√°tico: desde 10/07/2025
                            </small>
                        </div>
                    `;
                } else {
                    this.initialState.innerHTML = `
                        <div class="state-icon">üß†</div>
                        <div class="state-title">Cargando Sistema Inteligente...</div>
                        <div class="state-description">
                            Por favor espere mientras se cargan los datos y se ejecuta el an√°lisis IA
                        </div>
                    `;
                }
               
                this.initialState.style.display = 'block';
            }

            hideAllStates() {
                this.initialState.style.display = 'none';
                this.noResults.style.display = 'none';
                this.tableContainer.style.display = 'none';
                this.resultsInfo.style.display = 'none';
            }


        }

        // Responsive handling
        window.addEventListener('resize', () => {
            const searchSystem = window.transactionSearchSystem;
            if (searchSystem && (searchSystem.searchInput.value.trim() || searchSystem.dateFilterActive || searchSystem.observationsFilter !== 'all')) {
                const query = searchSystem.searchInput.value.trim();
                searchSystem.performSearch(query);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üß† DOM cargado, inicializando sistema inteligente de transacciones con WhatsApp...');
            try {
                window.transactionSearchSystem = new SmartTransactionSystem();
                console.log('‚úÖ Sistema inteligente de transacciones con WhatsApp inicializado correctamente');
               
            } catch (error) {
                console.error('‚ùå Error inicializando sistema inteligente de transacciones:', error);
            }
        });

        // Verificar autenticaci√≥n al cargar
        function checkAuthentication() {
            const urlParams = new URLSearchParams(window.location.search);
            const isAdmin = urlParams.get('admin') === 'true';
            const isVendor = urlParams.get('vendor') === 'true';
            
            // Si no hay par√°metros de autenticaci√≥n, verificar sesi√≥n
            if (!isAdmin && !isVendor) {
                const session = localStorage.getItem('vendorSession');
                
                if (session) {
                    const sessionData = JSON.parse(session);
                    const now = new Date();
                    const expiresAt = new Date(sessionData.expiresAt);
                    
                    if (now < expiresAt) {
                        console.log('‚úÖ Sesi√≥n v√°lida encontrada');
                        // Redirigir con par√°metros de sesi√≥n
                        if (sessionData.vendorId === '112220831') {
                            window.location.href = '/transacciones.html?admin=true';
                        } else {
                            window.location.href = '/transacciones.html?vendor=true';
                        }
                        return;
                    } else {
                        console.log('‚ùå Sesi√≥n expirada');
                        localStorage.removeItem('vendorSession');
                    }
                }
                
                // No hay sesi√≥n v√°lida, redirigir al login
                console.log('üîí No hay sesi√≥n v√°lida, redirigiendo al login');
                window.location.href = '/login.html';
                return;
            }
            
            // Si hay par√°metros de autenticaci√≥n, continuar normalmente
            console.log('‚úÖ Acceso autorizado a transacciones');
        }
        
        // Ejecutar verificaci√≥n al cargar - DESHABILITADO TEMPORALMENTE
        // checkAuthentication();


    </script>

    

    <!-- Bot√≥n Volver al Inicio -->
    <a href="index.html" class="home-button" title="Volver al Inicio">
        üè†
    </a>