<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Disponible Field</title>
</head>
<body>
    <h1>Test Disponible Field</h1>
    <div id="output"></div>

    <script>
        // Mock functions that are needed
        function formatDateForStorage(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${day}/${month}/${year}`;
        }

        // Mock parsePaymentAmount function
        function parsePaymentAmount(paymentAmount, bankSource) {
            if (!paymentAmount) return 0;
            
            console.log(`üîç [DEBUG PARSE] === PARSEO BAC 970873893 ===`);
            console.log(`üîç [DEBUG PARSE] Amount original: ${paymentAmount} (tipo: ${typeof paymentAmount})`);
            console.log(`üîç [DEBUG PARSE] BankSource: "${bankSource}"`);
            console.log(`üîç [DEBUG PARSE] paymentAmount === '60.000,00':`, paymentAmount === '60.000,00');
            console.log(`üîç [DEBUG PARSE] paymentAmount === 60000:`, paymentAmount === 60000);
            
            let result = 0;
            
            // Si es un n√∫mero, usarlo directamente
            if (typeof paymentAmount === 'number') {
                result = paymentAmount;
            } else if (typeof paymentAmount === 'string') {
                // Si es string, procesar seg√∫n el formato
                if (bankSource === 'BAC' || bankSource === 'BN') {
                    // Formato: "60.000,00" -> 60000
                    const cleanAmount = paymentAmount.replace(/\./g, '').replace(',', '.');
                    result = parseFloat(cleanAmount) || 0;
                    
                    console.log(`üîç [DEBUG PARSE] cleanAmount: "${cleanAmount}"`);
                    console.log(`üîç [DEBUG PARSE] parseFloat(cleanAmount): ${parseFloat(cleanAmount)}`);
                    console.log(`üîç [DEBUG PARSE] result: ${result}`);
                } else {
                    // Otros bancos: intentar parseFloat directo
                    result = parseFloat(paymentAmount) || 0;
                }
            } else {
                // Otros tipos: intentar conversi√≥n
                result = parseFloat(paymentAmount) || 0;
            }
            
            console.log(`üîç [DEBUG PARSE] Resultado final: ${result}`);
            console.log(`üîç [DEBUG PARSE] === FIN DEBUG PARSE ===`);
            
            return result;
        }

        // Test function
        function testCalculation970873893() {
            console.log('üß™ [PRUEBA C√ÅLCULO] === PRUEBA ESPEC√çFICA PARA 970873893 ===');
            
            // Simular los datos del pago problem√°tico
            const payment = {
                Referencia: '970873893',
                Cr√©ditos: '60.000,00',
                BankSource: 'BAC',
                FacturasAsignadas: 'FAC-19511:47000'
            };
            
            // Simular las asignaciones
            const assignments = [
                { invoiceNumber: 'FAC-19511', amount: 47000 }
            ];
            
            console.log('üß™ [PRUEBA C√ÅLCULO] Payment object:', payment);
            console.log('üß™ [PRUEBA C√ÅLCULO] Assignments:', assignments);
            
            // Calcular usando la misma l√≥gica que updatePaymentAssignmentsRaw
            const paymentAmount = parsePaymentAmount(payment.Cr√©ditos, payment.BankSource);
            const totalAssignedAmount = assignments.reduce((sum, assignment) => sum + assignment.amount, 0);
            const availableAmount = Math.max(0, paymentAmount - totalAssignedAmount);
            
            console.log('üß™ [PRUEBA C√ÅLCULO] Payment amount:', paymentAmount);
            console.log('üß™ [PRUEBA C√ÅLCULO] Total assigned amount:', totalAssignedAmount);
            console.log('üß™ [PRUEBA C√ÅLCULO] Available amount:', availableAmount);
            console.log('üß™ [PRUEBA C√ÅLCULO] Available amount type:', typeof availableAmount);
            console.log('üß™ [PRUEBA C√ÅLCULO] Available amount > 0:', availableAmount > 0);
            console.log('üß™ [PRUEBA C√ÅLCULO] Disponible value:', availableAmount.toString());
            console.log('üß™ [PRUEBA C√ÅLCULO] Disponible type:', typeof availableAmount.toString());
            console.log('üß™ [PRUEBA C√ÅLCULO] Disponible length:', availableAmount.toString().length);
            console.log('üß™ [PRUEBA C√ÅLCULO] Disponible === "":', availableAmount.toString() === "");
            console.log('üß™ [PRUEBA C√ÅLCULO] Disponible === "0":', availableAmount.toString() === "0");
            
            // Simular el updateData
            const updateData = {
                FacturasAsignadas: 'FAC-19511:47000',
                FechaAsignacion: formatDateForStorage(new Date()),
                Disponible: availableAmount.toString()
            };
            
            console.log('üß™ [PRUEBA C√ÅLCULO] Update data:', updateData);
            console.log('üß™ [PRUEBA C√ÅLCULO] JSON.stringify(updateData):', JSON.stringify(updateData));
            console.log('üß™ [PRUEBA C√ÅLCULO] === FIN PRUEBA C√ÅLCULO ===');
            
            // Display results in the page
            const output = document.getElementById('output');
            output.innerHTML = `
                <h2>Resultados del Test</h2>
                <p><strong>Payment amount:</strong> ${paymentAmount}</p>
                <p><strong>Total assigned amount:</strong> ${totalAssignedAmount}</p>
                <p><strong>Available amount:</strong> ${availableAmount}</p>
                <p><strong>Available amount type:</strong> ${typeof availableAmount}</p>
                <p><strong>Disponible value:</strong> "${availableAmount.toString()}"</p>
                <p><strong>Disponible type:</strong> ${typeof availableAmount.toString()}</p>
                <p><strong>Disponible length:</strong> ${availableAmount.toString().length}</p>
                <p><strong>Disponible === "":</strong> ${availableAmount.toString() === ""}</p>
                <p><strong>Disponible === "0":</strong> ${availableAmount.toString() === "0"}</p>
                <p><strong>Update data:</strong> <pre>${JSON.stringify(updateData, null, 2)}</pre></p>
            `;
            
            return {
                paymentAmount,
                totalAssignedAmount,
                availableAmount,
                updateData
            };
        }

        // Run the test when page loads
        window.onload = function() {
            testCalculation970873893();
        };
    </script>
</body>
</html> 